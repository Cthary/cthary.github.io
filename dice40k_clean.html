<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warhammer 40k Combat Simulator v2.1</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Google Fonts with font-display: swap for performance -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        /* ===== CSS DESIGN SYSTEM - VERSION 2.1 ===== */
        
        /* CSS Custom Properties (Design Tokens) */
        :root {
            /* Color Palette - Warhammer 40k Theme */
            --primary-bg: #0a0a0a;
            --secondary-bg: #1a1a1a;
            --panel-bg: #2a2a2a;
            --accent-bg: #3a3a3a;
            
            --text-primary: #e8e8e8;
            --text-secondary: #b8b8b8;
            --text-accent: #d4af37;
            --text-muted: #888888;
            
            --primary-gold: #d4af37;
            --secondary-gold: #b8941f;
            --accent-gold: #f4d03f;
            --dark-gold: #8b7500;
            
            --error-color: #e74c3c;
            --warning-color: #f39c12;
            --success-color: #27ae60;
            --info-color: #3498db;
            
            --border-color: #404040;
            --border-accent: #606060;
            --border-light: #808080;
            
            /* Typography Scale */
            --font-family-primary: 'Exo 2', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            --font-family-display: 'Orbitron', monospace;
            
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            
            --line-height-tight: 1.25;
            --line-height-normal: 1.5;
            --line-height-relaxed: 1.75;
            
            /* Spacing Scale */
            --space-xs: 0.25rem;
            --space-sm: 0.5rem;
            --space-md: 1rem;
            --space-lg: 1.5rem;
            --space-xl: 2rem;
            --space-2xl: 3rem;
            --space-3xl: 4rem;
            
            /* Border Radius */
            --radius-sm: 0.125rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --radius-2xl: 1rem;
            --radius-full: 9999px;
            
            /* Shadows */
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            
            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 250ms ease-in-out;
            --transition-slow: 350ms ease-in-out;
            
            /* Animation Curves */
            --ease-out-cubic: cubic-bezier(0.33, 1, 0.68, 1);
            --ease-in-out-cubic: cubic-bezier(0.65, 0, 0.35, 1);
            
            /* Z-index Scale */
            --z-dropdown: 1000;
            --z-sticky: 1020;
            --z-fixed: 1030;
            --z-modal-backdrop: 1040;
            --z-modal: 1050;
            --z-popover: 1060;
            --z-tooltip: 1070;
        }
        
        /* ===== RESET & BASE STYLES ===== */
        
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
        }
        
        body {
            font-family: var(--font-family-primary);
            font-size: var(--font-size-base);
            line-height: var(--line-height-normal);
            color: var(--text-primary);
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        /* ===== ACCESSIBILITY & SCREEN READER ===== */
        
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-gold);
            color: var(--primary-bg);
            padding: 8px;
            text-decoration: none;
            border-radius: var(--radius-md);
            z-index: var(--z-tooltip);
            font-weight: var(--font-weight-medium);
            transition: top var(--transition-fast);
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* Focus styles for better accessibility */
        :focus-visible {
            outline: 2px solid var(--primary-gold);
            outline-offset: 2px;
            border-radius: var(--radius-sm);
        }
        
        /* ===== TYPOGRAPHY ===== */
        
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-family-display);
            font-weight: var(--font-weight-bold);
            line-height: var(--line-height-tight);
            margin-bottom: var(--space-md);
            color: var(--text-accent);
        }
        
        h1 { font-size: var(--font-size-4xl); }
        h2 { font-size: var(--font-size-3xl); }
        h3 { font-size: var(--font-size-2xl); }
        h4 { font-size: var(--font-size-xl); }
        h5 { font-size: var(--font-size-lg); }
        h6 { font-size: var(--font-size-base); }
        
        p {
            margin-bottom: var(--space-md);
            color: var(--text-secondary);
        }
        
        /* ===== LAYOUT COMPONENTS ===== */
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: var(--space-lg);
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
            margin: var(--space-xl) 0;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: var(--space-md);
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
            }
        }
        
        /* ===== CARD COMPONENT ===== */
        
        .card {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }
        
        .card:hover {
            border-color: var(--border-accent);
            box-shadow: var(--shadow-xl);
        }
        
        .card-header {
            background: linear-gradient(45deg, var(--accent-bg), var(--secondary-bg));
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .card-body {
            padding: var(--space-xl);
        }
        
        .card-footer {
            background: var(--secondary-bg);
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--border-color);
        }
        
        /* ===== SITE HEADER ===== */
        
        .site-header {
            text-align: center;
            padding: var(--space-2xl) 0;
            position: relative;
        }
        
        .site-title {
            font-family: var(--font-family-display);
            font-weight: 900;
            font-size: clamp(2rem, 5vw, 4rem);
            background: linear-gradient(45deg, var(--primary-gold), var(--accent-gold));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-md);
        }
        
        .site-description {
            font-size: var(--font-size-lg);
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto var(--space-lg);
        }
        
        .version-badge {
            display: inline-block;
            background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-full);
            font-size: var(--font-size-sm);
            font-weight: var(--font-weight-semibold);
            letter-spacing: 0.5px;
        }
        
        /* ===== FORM COMPONENTS ===== */
        
        .form-group {
            margin-bottom: var(--space-lg);
        }
        
        .form-label {
            display: block;
            font-weight: var(--font-weight-medium);
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            font-size: var(--font-size-sm);
        }
        
        .form-label.required::after {
            content: ' *';
            color: var(--error-color);
            font-weight: var(--font-weight-bold);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: var(--space-md);
            background: var(--secondary-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: all var(--transition-normal);
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-gold);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }
        
        .form-input:required,
        .form-select:required {
            border-left: 4px solid var(--error-color);
        }
        
        .form-input:required:valid,
        .form-select:required:valid {
            border-left-color: var(--success-color);
        }
        
        .form-input::placeholder {
            color: var(--text-muted);
        }
        
        /* Form validation states */
        .form-group.has-error .form-input,
        .form-group.has-error .form-select {
            border-color: var(--error-color);
        }
        
        .form-group.has-success .form-input,
        .form-group.has-success .form-select {
            border-color: var(--success-color);
        }
        
        /* ===== BUTTON COMPONENTS ===== */
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            background: var(--accent-bg);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
            font-family: inherit;
            text-decoration: none;
            cursor: pointer;
            transition: all var(--transition-normal);
            min-height: 44px;
            white-space: nowrap;
        }
        
        .btn:hover:not(:disabled) {
            background: var(--panel-bg);
            border-color: var(--border-accent);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            border-color: var(--primary-gold);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: linear-gradient(45deg, var(--secondary-gold), var(--accent-gold));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        .btn-danger {
            background: linear-gradient(45deg, var(--error-color), #dc2626);
            color: white;
            border-color: var(--error-color);
        }
        
        .btn-large {
            padding: var(--space-lg) var(--space-2xl);
            font-size: var(--font-size-lg);
            min-height: 52px;
        }
        
        .btn-icon {
            padding: var(--space-sm);
            min-width: 44px;
            border-radius: var(--radius-full);
        }
        
        .button-group {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            flex-wrap: wrap;
        }
        
        /* ===== GRID UTILITIES ===== */
        
        .grid {
            display: grid;
            gap: var(--space-lg);
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        /* ===== LOADING & OVERLAY COMPONENTS ===== */
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: var(--z-modal);
        }
        
        .loading-content {
            background: var(--panel-bg);
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            text-align: center;
            box-shadow: var(--shadow-xl);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-lg);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== TOAST NOTIFICATIONS ===== */
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            z-index: var(--z-tooltip);
            max-width: 400px;
            animation: slideIn 0.3s ease-out;
        }
        
        .toast-error {
            border-color: var(--error-color);
            background: linear-gradient(45deg, var(--panel-bg), rgba(231, 76, 60, 0.1));
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }
        
        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--space-xs);
            margin-left: auto;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* ===== RESPONSIVE DESIGN ===== */
        
        @media (max-width: 768px) {
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
            }
            
            .site-title {
                font-size: 2.5rem;
            }
            
            .card-header,
            .card-body,
            .card-footer {
                padding: var(--space-lg);
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: var(--space-sm);
            }
            
            .card-header,
            .card-body,
            .card-footer {
                padding: var(--space-md);
            }
        }
        
        /* ===== MATERIAL ICONS ENHANCEMENT ===== */
        
        .material-icons {
            user-select: none;
            font-size: inherit;
        }
        
        /* ===== UTILITY CLASSES ===== */
        
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        
        .flex { display: flex; }
        .flex-col { flex-direction: column; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-sm { gap: var(--space-sm); }
        .gap-md { gap: var(--space-md); }
        .gap-lg { gap: var(--space-lg); }
        
        .mt-0 { margin-top: 0; }
        .mb-0 { margin-bottom: 0; }
        .p-0 { padding: 0; }
        
        .hidden { display: none; }
        .visible { display: block; }
    </style>
</head>

<body>
    <!-- Skip Links für bessere Zugänglichkeit -->
    <a href="#main-content" class="skip-link">Zum Hauptinhalt springen</a>
    <a href="#simulation-controls" class="skip-link">Zu den Simulationseinstellungen springen</a>
    <a href="#results" class="skip-link">Zu den Ergebnissen springen</a>

    <div class="container">
        <!-- Hauptheader mit semantischer Struktur -->
        <header class="site-header" role="banner">
            <h1 class="site-title">Warhammer 40k Combat Simulator</h1>
            <p class="site-description">
                Präzise mathematische Simulation für Warhammer 40.000 Kampfszenarien
            </p>
            <span class="version-badge" aria-label="Version 2.1">v2.1</span>
        </header>

        <!-- Hauptinhalt mit verbesserter Semantik -->
        <main id="main-content" role="main" aria-labelledby="main-heading">
            <h2 id="main-heading" class="sr-only">Combat Simulator Interface</h2>
            
            <!-- Hauptlayout Grid -->
            <div class="main-grid">
                <!-- Waffen-Sektion -->
                <section class="card" aria-labelledby="weapons-heading">
                    <header class="card-header">
                        <h2 id="weapons-heading" class="card-title">
                            <i class="material-icons" aria-hidden="true">gps_fixed</i>
                            Waffen-Konfiguration (Pflichtfelder)
                        </h2>
                    </header>
                    
                    <div class="card-body">
                        <div class="form-group">
                            <label for="weapon-upload" class="form-label required">
                                Waffen-Datei hochladen
                            </label>
                            <input 
                                type="file" 
                                id="weapon-upload" 
                                class="form-input"
                                accept=".json"
                                required
                                aria-describedby="weapon-upload-help"
                                onchange="loadWeapons(event)"
                            >
                            <small id="weapon-upload-help" class="text-muted">
                                JSON-Datei mit Waffendefinitionen
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="weapon-select" class="form-label required">
                                Waffe auswählen
                            </label>
                            <select 
                                id="weapon-select" 
                                class="form-select"
                                required
                                disabled
                                aria-describedby="weapon-select-help"
                                onchange="selectWeapon()"
                            >
                                <option value="">-- Waffe auswählen --</option>
                            </select>
                            <small id="weapon-select-help" class="text-muted">
                                Erst nach dem Laden einer Datei verfügbar
                            </small>
                        </div>

                        <div id="selected-weapons" class="selected-items" aria-live="polite">
                            <!-- Ausgewählte Waffen werden hier angezeigt -->
                        </div>
                    </div>
                </section>

                <!-- Verteidiger-Sektion -->
                <section class="card" aria-labelledby="defenders-heading">
                    <header class="card-header">
                        <h2 id="defenders-heading" class="card-title">
                            <i class="material-icons" aria-hidden="true">shield</i>
                            Verteidiger-Konfiguration (Pflichtfelder)
                        </h2>
                    </header>
                    
                    <div class="card-body">
                        <div class="form-group">
                            <label for="defender-upload" class="form-label required">
                                Verteidiger-Datei hochladen
                            </label>
                            <input 
                                type="file" 
                                id="defender-upload" 
                                class="form-input"
                                accept=".json"
                                required
                                aria-describedby="defender-upload-help"
                                onchange="loadDefenders(event)"
                            >
                            <small id="defender-upload-help" class="text-muted">
                                JSON-Datei mit Verteidigerdefinitionen
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="defender-select" class="form-label required">
                                Verteidiger auswählen
                            </label>
                            <select 
                                id="defender-select" 
                                class="form-select"
                                required
                                disabled
                                aria-describedby="defender-select-help"
                                onchange="selectDefender()"
                            >
                                <option value="">-- Verteidiger auswählen --</option>
                            </select>
                            <small id="defender-select-help" class="text-muted">
                                Erst nach dem Laden einer Datei verfügbar
                            </small>
                        </div>

                        <div id="selected-defenders" class="selected-items" aria-live="polite">
                            <!-- Ausgewählte Verteidiger werden hier angezeigt -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Simulations-Steuerung -->
            <section 
                id="simulation-controls" 
                class="card" 
                aria-labelledby="simulation-heading"
            >
                <header class="card-header">
                    <h2 id="simulation-heading" class="card-title">
                        <i class="material-icons" aria-hidden="true">play_arrow</i>
                        Simulation starten
                    </h2>
                </header>
                
                <div class="card-body">
                    <div class="grid grid-3">
                        <div class="form-group">
                            <label for="iterations" class="form-label">
                                Anzahl Simulationen
                            </label>
                            <input 
                                type="number" 
                                id="iterations" 
                                class="form-input"
                                value="10000"
                                min="100"
                                max="1000000"
                                step="100"
                                aria-describedby="iterations-help"
                            >
                            <small id="iterations-help" class="text-muted">
                                Zwischen 100 und 1.000.000
                            </small>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <input type="checkbox" id="export-pdf" style="margin-right: 8px;">
                                Auto-PDF Export
                            </label>
                            <small class="text-muted">
                                PDF nach Simulation automatisch erstellen
                            </small>
                        </div>

                        <div class="form-group">
                            <button 
                                id="simulate-btn"
                                class="btn btn-primary btn-large w-full"
                                onclick="runSimulation()"
                                disabled
                                aria-describedby="simulate-help"
                            >
                                <i class="material-icons" aria-hidden="true">analytics</i>
                                Simulation starten
                            </button>
                            <small id="simulate-help" class="text-muted">
                                Waffen und Verteidiger müssen ausgewählt sein
                            </small>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ergebnisse Sektion -->
            <section 
                id="results" 
                class="card" 
                aria-labelledby="results-heading"
                aria-live="polite"
                style="display: none;"
            >
                <header class="card-header">
                    <h2 id="results-heading" class="card-title">
                        <i class="material-icons" aria-hidden="true">assessment</i>
                        Simulationsergebnisse
                    </h2>
                </header>
                
                <div class="card-body">
                    <div id="results-content" role="region" aria-label="Simulationsergebnisse">
                        <!-- Ergebnisse werden hier eingefügt -->
                    </div>
                </div>
                
                <footer class="card-footer">
                    <div class="results-actions">
                        <div class="button-group">
                            <button class="btn btn-secondary" onclick="exportToPDF()">
                                <i class="material-icons" aria-hidden="true">picture_as_pdf</i>
                                PDF exportieren
                            </button>
                            <button class="btn btn-secondary" onclick="clearResults()">
                                <i class="material-icons" aria-hidden="true">clear</i>
                                Ergebnisse löschen
                            </button>
                        </div>
                    </div>
                </footer>
            </section>
        </main>

        <!-- Help & Info Sektion -->
        <aside class="help-section" role="complementary" aria-labelledby="help-heading">
            <details class="card">
                <summary class="card-header" id="help-heading">
                    <h2 class="card-title">
                        <i class="material-icons" aria-hidden="true">help</i>
                        Hilfe & Anleitung
                    </h2>
                </summary>
                
                <div class="card-body">
                    <div class="grid grid-2">
                        <div>
                            <h3>Erste Schritte</h3>
                            <ol>
                                <li>Laden Sie eine Waffen-JSON-Datei hoch</li>
                                <li>Laden Sie eine Verteidiger-JSON-Datei hoch</li>
                                <li>Wählen Sie Waffen und Verteidiger aus</li>
                                <li>Starten Sie die Simulation</li>
                            </ol>
                        </div>
                        <div>
                            <h3>JSON-Format</h3>
                            <p>Die JSON-Dateien müssen Arrays mit Objekten enthalten, die die Warhammer 40k Statistiken definieren.</p>
                            <p>Beispiel-Dateien finden Sie in der Dokumentation.</p>
                        </div>
                    </div>
                </div>
            </details>
        </aside>
    </div>

    <!-- Loading Overlay -->
    <div 
        id="loading-overlay" 
        class="loading-overlay" 
        role="dialog" 
        aria-modal="true" 
        aria-labelledby="loading-title"
        style="display: none;"
    >
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <h2 id="loading-title">Simulation läuft...</h2>
            <p id="loading-progress" aria-live="polite">Wird geladen...</p>
        </div>
    </div>

    <!-- Error Toast -->
    <div 
        id="error-toast" 
        class="toast toast-error" 
        role="alert" 
        aria-live="assertive"
        style="display: none;"
    >
        <div class="toast-content">
            <i class="material-icons" aria-hidden="true">error</i>
            <span id="error-message"></span>
            <button 
                class="toast-close" 
                onclick="hideErrorToast()"
                aria-label="Fehlermeldung schließen"
            >
                <i class="material-icons" aria-hidden="true">close</i>
            </button>
        </div>
    </div>

    <!-- JavaScript for Enhanced Combat Simulator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // Enhanced Combat Simulator JavaScript - Version 2.1
        console.log('Warhammer 40k Combat Simulator v2.1 geladen');
        
        // Global state management
        let weaponsData = [];
        let defendersData = [];
        let selectedWeapons = [];
        let selectedDefenders = [];
        let currentResults = null;

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded successfully');
            initializeModernSimulator();
        });
        
        function initializeModernSimulator() {
            console.log('Modern simulator interface initialized');
            
            // Initialize required field validation
            initializeRequiredFields();
            
            // Set focus to first interactive element
            const firstInput = document.getElementById('weapon-upload');
            if (firstInput) {
                firstInput.focus();
            }
            
            announceToScreenReader('Warhammer 40k Combat Simulator v2.1 geladen');
        }

        // ===== ACCESSIBILITY FUNCTIONS =====
        
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        function showErrorToast(message) {
            const toast = document.getElementById('error-toast');
            const messageElement = document.getElementById('error-message');
            messageElement.textContent = message;
            toast.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideErrorToast();
            }, 5000);
            
            announceToScreenReader(`Fehler: ${message}`);
        }

        function hideErrorToast() {
            const toast = document.getElementById('error-toast');
            toast.style.display = 'none';
        }

        function showLoadingOverlay(message = 'Wird geladen...') {
            const overlay = document.getElementById('loading-overlay');
            const progressElement = document.getElementById('loading-progress');
            progressElement.textContent = message;
            overlay.style.display = 'flex';
            
            // Focus management
            const previousFocus = document.activeElement;
            overlay.setAttribute('data-previous-focus', previousFocus.id || '');
            overlay.focus();
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
            
            // Restore focus
            const previousFocusId = overlay.getAttribute('data-previous-focus');
            if (previousFocusId) {
                const previousElement = document.getElementById(previousFocusId);
                if (previousElement) {
                    previousElement.focus();
                }
            }
        }

        // ===== FORM VALIDATION =====
        
        function initializeRequiredFields() {
            const requiredFields = document.querySelectorAll('input[required], select[required]');
            
            requiredFields.forEach(field => {
                field.addEventListener('input', validateField);
                field.addEventListener('change', validateField);
                field.addEventListener('blur', validateField);
                
                // Initial check
                validateField({ target: field });
            });
            
            updateSimulateButtonState();
        }
        
        function validateField(event) {
            const field = event.target;
            const formGroup = field.closest('.form-group');
            
            if (field.checkValidity()) {
                formGroup?.classList.remove('has-error');
                formGroup?.classList.add('has-success');
            } else {
                formGroup?.classList.remove('has-success');
                formGroup?.classList.add('has-error');
            }
            
            updateSimulateButtonState();
        }

        function updateSimulateButtonState() {
            const btn = document.getElementById('simulate-btn');
            const hasWeapons = selectedWeapons.length > 0;
            const hasDefenders = selectedDefenders.length > 0;
            
            btn.disabled = !(hasWeapons && hasDefenders);
            
            if (btn.disabled) {
                btn.setAttribute('aria-describedby', 'simulate-help');
            } else {
                btn.removeAttribute('aria-describedby');
            }
        }

        // ===== FILE LOADING =====
        
        async function loadWeapons(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoadingOverlay('Lade Waffendaten...');
            
            try {
                const text = await file.text();
                weaponsData = JSON.parse(text);
                
                if (!Array.isArray(weaponsData) || weaponsData.length === 0) {
                    throw new Error('Ungültige Waffendatei: Keine Waffen gefunden');
                }

                populateWeaponSelect();
                announceToScreenReader(`${weaponsData.length} Waffen erfolgreich geladen`);
                
            } catch (error) {
                console.error('Error loading weapons:', error);
                showErrorToast(`Fehler beim Laden der Waffendatei: ${error.message}`);
                weaponsData = [];
            } finally {
                hideLoadingOverlay();
                updateSimulateButtonState();
            }
        }

        async function loadDefenders(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoadingOverlay('Lade Verteidigerdaten...');
            
            try {
                const text = await file.text();
                defendersData = JSON.parse(text);
                
                if (!Array.isArray(defendersData) || defendersData.length === 0) {
                    throw new Error('Ungültige Verteidigerdatei: Keine Verteidiger gefunden');
                }

                populateDefenderSelect();
                announceToScreenReader(`${defendersData.length} Verteidiger erfolgreich geladen`);
                
            } catch (error) {
                console.error('Error loading defenders:', error);
                showErrorToast(`Fehler beim Laden der Verteidigerdatei: ${error.message}`);
                defendersData = [];
            } finally {
                hideLoadingOverlay();
                updateSimulateButtonState();
            }
        }

        function populateWeaponSelect() {
            const select = document.getElementById('weapon-select');
            select.innerHTML = '<option value="">-- Waffe auswählen --</option>';
            
            weaponsData.forEach((weapon, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = weapon.name || `Waffe ${index + 1}`;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        function populateDefenderSelect() {
            const select = document.getElementById('defender-select');
            select.innerHTML = '<option value="">-- Verteidiger auswählen --</option>';
            
            defendersData.forEach((defender, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = defender.name || `Verteidiger ${index + 1}`;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        // ===== SELECTION FUNCTIONS =====
        
        function selectWeapon() {
            const select = document.getElementById('weapon-select');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') return;
            
            const weapon = weaponsData[selectedIndex];
            if (!weapon) return;
            
            // Check if already selected
            if (selectedWeapons.find(w => w.name === weapon.name)) {
                showErrorToast('Diese Waffe ist bereits ausgewählt');
                select.value = '';
                return;
            }
            
            selectedWeapons.push({ ...weapon, id: Date.now() });
            updateSelectedWeaponsDisplay();
            updateSimulateButtonState();
            select.value = '';
            
            announceToScreenReader(`Waffe ${weapon.name} hinzugefügt`);
        }

        function selectDefender() {
            const select = document.getElementById('defender-select');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') return;
            
            const defender = defendersData[selectedIndex];
            if (!defender) return;
            
            // Check if already selected
            if (selectedDefenders.find(d => d.name === defender.name)) {
                showErrorToast('Dieser Verteidiger ist bereits ausgewählt');
                select.value = '';
                return;
            }
            
            selectedDefenders.push({ ...defender, id: Date.now() });
            updateSelectedDefendersDisplay();
            updateSimulateButtonState();
            select.value = '';
            
            announceToScreenReader(`Verteidiger ${defender.name} hinzugefügt`);
        }

        // ===== DISPLAY FUNCTIONS =====
        
        function updateSelectedWeaponsDisplay() {
            const container = document.getElementById('selected-weapons');
            container.innerHTML = '';
            
            selectedWeapons.forEach(weapon => {
                const weaponCard = createWeaponCard(weapon);
                container.appendChild(weaponCard);
            });
        }

        function updateSelectedDefendersDisplay() {
            const container = document.getElementById('selected-defenders');
            container.innerHTML = '';
            
            selectedDefenders.forEach(defender => {
                const defenderCard = createDefenderCard(defender);
                container.appendChild(defenderCard);
            });
        }

        function createWeaponCard(weapon) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginTop = '1rem';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-labelledby', `weapon-title-${weapon.id}`);
            
            card.innerHTML = `
                <div class="card-header">
                    <h4 id="weapon-title-${weapon.id}" class="card-title">${weapon.name}</h4>
                    <button 
                        class="btn btn-icon btn-danger"
                        onclick="removeWeapon(${weapon.id})"
                        aria-label="Waffe ${weapon.name} entfernen"
                        title="Waffe entfernen"
                    >
                        <i class="material-icons" aria-hidden="true">delete</i>
                    </button>
                </div>
                <div class="card-body">
                    <p><strong>Details:</strong> ${JSON.stringify(weapon, null, 2)}</p>
                </div>
            `;
            
            return card;
        }

        function createDefenderCard(defender) {
            const card = document.createElement('div');
            card.className = 'card';
            card.style.marginTop = '1rem';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-labelledby', `defender-title-${defender.id}`);
            
            card.innerHTML = `
                <div class="card-header">
                    <h4 id="defender-title-${defender.id}" class="card-title">${defender.name}</h4>
                    <button 
                        class="btn btn-icon btn-danger"
                        onclick="removeDefender(${defender.id})"
                        aria-label="Verteidiger ${defender.name} entfernen"
                        title="Verteidiger entfernen"
                    >
                        <i class="material-icons" aria-hidden="true">delete</i>
                    </button>
                </div>
                <div class="card-body">
                    <p><strong>Details:</strong> ${JSON.stringify(defender, null, 2)}</p>
                </div>
            `;
            
            return card;
        }

        function removeWeapon(weaponId) {
            const weapon = selectedWeapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            selectedWeapons = selectedWeapons.filter(w => w.id !== weaponId);
            updateSelectedWeaponsDisplay();
            updateSimulateButtonState();
            
            announceToScreenReader(`Waffe ${weapon.name} entfernt`);
        }

        function removeDefender(defenderId) {
            const defender = selectedDefenders.find(d => d.id === defenderId);
            if (!defender) return;
            
            selectedDefenders = selectedDefenders.filter(d => d.id !== defenderId);
            updateSelectedDefendersDisplay();
            updateSimulateButtonState();
            
            announceToScreenReader(`Verteidiger ${defender.name} entfernt`);
        }

        // ===== SIMULATION FUNCTIONS =====
        
        async function runSimulation() {
            // Validation
            if (selectedWeapons.length === 0 || selectedDefenders.length === 0) {
                showErrorToast('Bitte wählen Sie mindestens eine Waffe und einen Verteidiger aus');
                return;
            }

            const iterations = parseInt(document.getElementById('iterations').value) || 10000;
            
            if (iterations < 100 || iterations > 1000000) {
                showErrorToast('Anzahl Simulationen muss zwischen 100 und 1.000.000 liegen');
                return;
            }

            showLoadingOverlay('Führe Kampfsimulation durch...');
            
            try {
                // Placeholder simulation
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                const results = {
                    weapons: selectedWeapons,
                    defenders: selectedDefenders,
                    iterations: iterations,
                    timestamp: new Date().toISOString(),
                    message: 'Simulation erfolgreich durchgeführt (Placeholder)'
                };
                
                currentResults = results;
                displayResults(results);
                
                announceToScreenReader('Simulation erfolgreich abgeschlossen');
                
            } catch (error) {
                console.error('Simulation error:', error);
                showErrorToast(`Fehler bei der Simulation: ${error.message}`);
            } finally {
                hideLoadingOverlay();
            }
        }

        function displayResults(results) {
            const resultsSection = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = `
                <div class="grid grid-2">
                    <div>
                        <h3>Simulation Details</h3>
                        <p><strong>Iterationen:</strong> ${results.iterations.toLocaleString()}</p>
                        <p><strong>Waffen:</strong> ${results.weapons.length}</p>
                        <p><strong>Verteidiger:</strong> ${results.defenders.length}</p>
                        <p><strong>Zeitstempel:</strong> ${new Date(results.timestamp).toLocaleString()}</p>
                    </div>
                    <div>
                        <h3>Ergebnisse</h3>
                        <p>${results.message}</p>
                        <p class="text-muted">Die vollständige Simulation wird in einer zukünftigen Version implementiert.</p>
                    </div>
                </div>
            `;
            
            resultsSection.style.display = 'block';
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function clearResults() {
            const resultsSection = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '';
            resultsSection.style.display = 'none';
            currentResults = null;
            
            announceToScreenReader('Ergebnisse gelöscht');
        }

        // ===== EXPORT FUNCTIONS =====
        
        async function exportToPDF() {
            if (!currentResults) {
                showErrorToast('Keine Ergebnisse zum Exportieren verfügbar');
                return;
            }

            showLoadingOverlay('Erstelle PDF...');
            
            try {
                // Placeholder PDF export
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                showErrorToast('PDF-Export wird in einer zukünftigen Version implementiert');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showErrorToast(`Fehler beim PDF-Export: ${error.message}`);
            } finally {
                hideLoadingOverlay();
            }
        }

        // ===== KEYBOARD NAVIGATION =====
        
        document.addEventListener('keydown', function(event) {
            // ESC key handling
            if (event.key === 'Escape') {
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay.style.display !== 'none') {
                    hideLoadingOverlay();
                    return;
                }
                
                const errorToast = document.getElementById('error-toast');
                if (errorToast.style.display !== 'none') {
                    hideErrorToast();
                    return;
                }
            }
            
            // Enter key for simulation
            if (event.key === 'Enter' && event.target.id === 'simulate-btn') {
                runSimulation();
            }
        });
    </script>
</body>
</html>
