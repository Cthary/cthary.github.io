<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warhammer 40k 10th Edition Kampfsimulator</title>
    <!-- jsPDF für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e6ed;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #ffd700;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .simulation-panel {
            margin-bottom: 30px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .collapsible {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .collapsible.active {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .collapsible:after {
            content: '▼';
            font-size: 14px;
            color: #ffd700;
            transition: transform 0.3s ease;
        }

        .collapsible.active:after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 5px 5px;
        }

        .collapsible-content.active {
            padding: 20px;
            max-height: 1000px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #b8c6db;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            font-size: 14px;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(224, 230, 237, 0.6);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
        }

        .collapsible-btn {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid rgba(255, 215, 0, 0.3);
            color: #ffd700;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .collapsible-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            border-color: rgba(255, 215, 0, 0.5);
        }

        .collapsible-content {
            display: none;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .collapsible-content.active {
            display: block;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
        }

        .collapsible-btn.active .toggle-icon {
            transform: rotate(180deg);
        }

        .keywords-section {
            margin-top: 15px;
        }

        .keywords-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .keywords-input input {
            flex: 1;
        }

        .help-btn {
            background: linear-gradient(45deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            transform: scale(1.1);
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .keyword-tag {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .keyword-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .unit-list {
            margin-top: 20px;
        }

        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 1.1rem;
        }

        .unit-controls {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #667eea;
            padding: 10px;
            margin: 5px 0;
            border-radius: 0 5px 5px 0;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .weapon-info {
            flex: 1;
            margin-bottom: 8px;
        }

        .weapon-controls {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            align-items: center;
        }

        .weapon-controls .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 60px;
        }

        .results-panel {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-item {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 5px;
            padding: 15px;
        }

        .result-header {
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .stat-label {
            color: #b8c6db;
        }

        .stat-value {
            color: #e0e6ed;
            font-weight: 600;
        }

        .json-section {
            margin-top: 20px;
        }

        .json-textarea {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .simulation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .simulation-controls label {
            color: #b8c6db;
            font-weight: 600;
        }

        .simulation-controls input {
            width: 100px;
        }

        .keyword-reference {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .keyword-reference h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .keyword-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .weapons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin: 10px 0;
        }

        .defenders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 10px 0;
        }

        .weapon-card, .defender-card {
            background: rgba(255, 255, 255, 0.07);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .weapon-card:hover, .defender-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
        }

        .defender-card.leader {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(255, 215, 0, 0.05);
        }

        .weapon-card h5, .defender-card h6 {
            color: #ffd700;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .weapon-stats, .defender-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .keyword-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 3px;
            border-left: 3px solid #667eea;
        }

        .keyword-name {
            font-weight: bold;
            color: #ffd700;
        }

        .keyword-desc {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .chart-container {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .chart-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 100px;
            margin: 10px 0;
        }

        .bar {
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 2px 2px 0 0;
            min-width: 12px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -15px;
            font-size: 9px;
            color: #b8c6db;
        }

        .probability-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .wipeout-chance {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e6ed;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ffd700;
        }

        /* Success and Error Messages */
        .success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .error {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        /* Loading Overlay */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 215, 0, 0.2);
            border-top: 6px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Unit and Weapon Management Styles */
        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-header h3 {
            margin: 0;
            color: #ffd700;
        }

        .unit-stats p {
            margin: 5px 0;
        }

        .weapons-list {
            margin-top: 10px;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .weapon-item button {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .btn-small {
            padding: 3px 8px;
            font-size: 0.8rem;
        }

        .keyword-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .keyword-selection-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .keyword-selection-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        .keyword-selection-item.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .keyword-selection-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .keyword-selection-desc {
            font-size: 0.85rem;
            color: #b8c6db;
        }

        .keyword-parameter-inputs {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
        }

        .keyword-parameter-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .keyword-parameter-label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #ffd700;
        }

        .keyword-parameter-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            font-size: 0.9rem;
        }

        .simulation-start-panel {
            text-align: center;
            margin: 30px 0;
        }

        .simulation-final-controls p {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #b8c6db;
        }

        .btn-large {
            font-size: 1.2rem !important;
            padding: 15px 30px !important;
        }

        /* Chart Styles */
        .distribution-chart {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            overflow-x: auto; /* Allow horizontal scrolling if needed */
        }

        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 3px;
            min-width: 30px;
            max-width: 60px;
            flex: 1;
        }

        .chart-bars-row {
            display: flex;
            align-items: flex-end;
            height: 120px;
            margin-bottom: 10px;
            padding: 0 5px;
            min-width: fit-content;
        }

        .chart-bar {
            width: 100%;
            border-radius: 3px 3px 0 0;
            position: relative;
            min-height: 3px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .bar-label {
            color: white;
            font-size: 0.65rem;
            font-weight: bold;
            padding: 1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bar-text {
            color: #ccc;
            font-size: 0.7rem;
            margin-top: 3px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
    <style>
        .collapsible {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .collapsible.active {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .collapsible:after {
            content: '▼';
            font-size: 14px;
            color: #ffd700;
            transition: transform 0.3s ease;
        }

        .collapsible.active:after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 5px 5px;
        }

        .collapsible-content.active {
            padding: 20px;
            max-height: 1000px;
        }

        .simulation-panel {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚔️ Warhammer 40k 10th Edition Kampfsimulator ⚔️</h1>
            <p>Simuliere Kämpfe zwischen Angreifern und Verteidigern mit allen 10th Edition Regeln</p>
        </div>

        <!-- Simulation Panel -->
        <div class="panel simulation-panel">
            <h2>🎯 Simulation Setup</h2>
            
            <div class="simulation-controls">
                <label>Anzahl Simulationen:</label>
                <input type="number" id="simulationAmount" value="1000" min="10" max="100000">
            </div>

            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
                <div class="loading-text">
                    Simulation läuft...<br>
                    <small>Bitte warten Sie, während die Berechnung durchgeführt wird.</small>
                </div>
            </div>

            <!-- JSON Import/Export als aufklappbar -->
            <button class="collapsible" onclick="toggleCollapsible(this)">
                📄 JSON Import/Export
            </button>
            <div class="collapsible-content">
                <div class="form-group">
                    <label>📥 Konfiguration aus Datei laden:</label>
                    <input type="file" id="jsonFileInput" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="importFromFile()">Datei importieren</button>
                </div>

                <div class="form-group">
                    <label>📤 Aktuelle Konfiguration speichern:</label>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="exportJson()">Als Datei exportieren</button>
                        <button class="btn" onclick="showFullJson()">JSON anzeigen</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>📝 Oder JSON manuell eingeben:</label>
                    <textarea class="json-textarea" id="jsonImport" placeholder="Fügen Sie hier Ihre JSON-Konfiguration ein..."></textarea>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="importJson()">JSON importieren</button>
                        <button class="btn" onclick="loadExample()">Beispiel laden</button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="showFullJson()">Vollständige JSON anzeigen</button>
                <button class="btn btn-danger" onclick="clearAll()">Alles zurücksetzen</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Angreifer Panel -->
            <div class="panel">
                <h2>🗡️ Angreifer verwalten</h2>
                
                <div class="form-group">
                    <label>Gruppen-Name (z.B. "Space Marine Squad"):</label>
                    <input type="text" id="attackerGroupName" placeholder="z.B. Space Marine Squad">
                </div>

                <div class="form-group">
                    <label>Name des Angreifers:</label>
                    <input type="text" id="attackerName" placeholder="z.B. Sergeant, Marine">
                </div>

                <div class="form-group">
                    <label>Anzahl dieses Modell-Typs:</label>
                    <input type="number" id="attackerCount" value="1" min="1" max="20">
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addAttacker()">Angreifer hinzufügen</button>
                </div>

                <div class="unit-list" id="attackersList"></div>

                <!-- Waffe hinzufügen als aufklappbar -->
                <button class="collapsible" onclick="toggleCollapsible(this)">
                    ⚔️ Waffe hinzufügen
                </button>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label>Angreifer auswählen:</label>
                        <select id="weaponAttackerSelect">
                            <option value="">Bitte Angreifer auswählen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Waffenname:</label>
                        <input type="text" id="weaponName" placeholder="z.B. Bolter">
                    </div>
                    
                    <div class="form-group">
                        <label>Anzahl identischer Waffen (Amount):</label>
                        <input type="number" id="weaponAmount" value="1" min="1" max="20">
                    </div>

                    <div class="form-group">
                        <label>Waffentyp:</label>
                        <select id="weaponType">
                            <option value="Ranged">Ranged</option>
                            <option value="Melee">Melee</option>
                            <option value="Psychic">Psychic</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Attacks (kann D6, 2D3+1, etc. sein):</label>
                        <input type="text" id="weaponAttacks" value="1" placeholder="z.B. 2D6+3">
                    </div>

                    <div class="form-group">
                        <label>To Hit (Würfelwurf benötigt):</label>
                        <input type="number" id="weaponToHit" value="4" min="2" max="6">
                    </div>

                    <div class="form-group">
                        <label>Strength:</label>
                        <input type="number" id="weaponStrength" value="4" min="1" max="20">
                    </div>

                    <div class="form-group">
                        <label>AP (Armor Penetration):</label>
                        <input type="number" id="weaponAP" value="0" min="0" max="6">
                    </div>

                    <div class="form-group">
                        <label>Damage (kann D6, D3+1, etc. sein):</label>
                        <input type="text" id="weaponDamage" value="1" placeholder="z.B. D6+2">
                    </div>                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="weaponKeywordInput" placeholder="Keyword eingeben oder aus Liste wählen">
                        <button class="btn btn-small" onclick="addWeaponKeyword()">+</button>
                        <button class="btn btn-small" onclick="showKeywordSelector('weapon')" title="Aus Keyword-Liste auswählen">📋</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="weaponKeywords"></div>
                    
                    <!-- Parameter-Input für Keywords wie "Melta X", "Anti-X Y+", etc. -->
                    <div id="weaponKeywordParameters" style="margin-top: 10px; display: none;">
                        <div class="keyword-parameter-inputs"></div>
                    </div>
                </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="addWeapon()">Waffe hinzufügen</button>
                        <button class="btn" onclick="clearWeaponForm()">Formular leeren</button>
                    </div>
                </div>
            </div>

            <!-- Verteidiger Panel -->
            <div class="panel">
                <h2>🛡️ Verteidiger verwalten</h2>
                
                <div class="form-group">
                    <label>Gruppen-Name (z.B. "Space Marine Squad"):</label>
                    <input type="text" id="defenderGroupName" placeholder="z.B. Space Marine Squad">
                </div>
                
                <div class="form-group">
                    <label>Name des Verteidigers:</label>
                    <input type="text" id="defenderName" placeholder="z.B. Sergeant, Marine">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="defenderIsLeader" style="margin: 0;">
                        <span>🎖️ Leader (erhält Schaden zuletzt)</span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Anzahl Modelle:</label>
                    <input type="number" id="defenderModels" value="10" min="1">
                </div>

                <div class="form-group">
                    <label>Toughness:</label>
                    <input type="number" id="defenderToughness" value="4" min="1" max="12">
                </div>

                <div class="form-group">
                    <label>Wounds pro Modell:</label>
                    <input type="number" id="defenderWounds" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>Save (Armor Save):</label>
                    <input type="number" id="defenderSave" value="6" min="2" max="7">
                </div>
                <div class="form-group">
                    <label>Invulnerable Save (leer lassen wenn nicht vorhanden):</label>
                    <input type="number" id="defenderInvul" min="2" max="6" placeholder="z.B. 5">
                </div>

                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="defenderKeywordInput" placeholder="Keyword eingeben oder aus Liste wählen">
                        <button class="btn btn-small" onclick="addDefenderKeyword()">+</button>
                        <button class="btn btn-small" onclick="showKeywordSelector('defender')" title="Aus Keyword-Liste auswählen">📋</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="defenderKeywords"></div>
                    
                    <!-- Parameter-Input für Keywords -->
                    <div id="defenderKeywordParameters" style="margin-top: 10px; display: none;">
                        <div class="keyword-parameter-inputs"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addDefender()">Verteidiger hinzufügen</button>
                </div>

                <div class="unit-list" id="defendersList"></div>
            </div>
        </div>

        <!-- Simulation starten -->
        <div class="panel simulation-start-panel">
            <h2>🚀 Simulation starten</h2>
            <div class="simulation-final-controls">
                <p>Alle Angreifer und Verteidiger sind konfiguriert? Dann kann die Simulation gestartet werden!</p>
                <button class="btn btn-primary btn-large" onclick="runSimulation()" style="font-size: 1.2rem; padding: 15px 30px;">
                    ⚔️ Simulation starten
                </button>
            </div>
        </div>

        <!-- Ergebnisse Panel -->
        <div class="panel results-panel" id="resultsPanel" style="display: none;">
            <h2>📊 Simulationsergebnisse</h2>
            <div class="results-grid" id="resultsContainer"></div>
            
            <!-- Export Button am Ende der Ergebnisse -->
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="exportResultsToPDF()">📄 PDF-Report erstellen</button>
                <button class="btn btn-secondary" onclick="exportResultsToJson()">📄 JSON exportieren</button>
            </div>
        </div>
    </div>

    <!-- Keyword Help Modal -->
    <div id="keywordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordHelp()">&times;</span>
            <h2>📖 Keyword-Referenz</h2>
            <div class="keyword-reference">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-grid" id="modalStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-grid" id="modalCustomKeywords"></div>
            </div>
        </div>
    </div>

    <!-- Keyword Selector Modal -->
    <div id="keywordSelectorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordSelector()">&times;</span>
            <h2>🔖 Keywords auswählen</h2>
            <div class="keyword-selector">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-selection-grid" id="selectorStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-selection-grid" id="selectorCustomKeywords"></div>
            </div>
        </div>
    </div>

    <script>
        // Einfacher Test ohne Module
        console.log('Basic script loading...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            document.body.style.backgroundColor = 'red'; // Visueller Test
        });
    </script>
    
    <script type="module">
        import { Dice } from './src/scripts/dice.js';
        import { Attacker, Defender, Weapon } from './src/scripts/units.js';
        import run from './src/scripts/w40k.js';

        console.log('Scripts loaded successfully');
        console.log('run function:', typeof run);
        console.log('Dice class:', typeof Dice);
        console.log('Attacker class:', typeof Attacker);
        
        // Test basic functionality
        try {
            const testDice = new Dice();
            console.log('Dice test roll:', testDice.roll());
        } catch (error) {
            console.error('Error testing modules:', error);
            alert('Fehler beim Testen der JavaScript-Module: ' + error.message);
        }

        // Globale Variablen
        window.attackers = [];
        window.defenders = [];
        window.simulationResults = [];
        window.currentWeaponKeywords = [];
        window.currentDefenderKeywords = [];

        // Mache run-Funktion global verfügbar
        window.runCombatSimulation = run;
        
        // Mache auch die Klassen global verfügbar für Debug-Zwecke
        window.Weapon = Weapon;
        window.Attacker = Attacker;
        window.Defender = Defender;
        window.Dice = Dice;

        // Migration: Stelle sicher, dass alle Angreifer-Mitglieder ein Weapons-Array haben
        function migrateAttackerData() {
            window.attackers.forEach(group => {
                // Migriere alte Struktur mit Waffen auf Gruppen-Ebene
                if (group.Weapons && !group.Members.some(m => m.Weapons)) {
                    // Teile Waffen auf alle Mitglieder auf (alte Struktur)
                    group.Members.forEach(member => {
                        if (!member.Weapons) {
                            member.Weapons = [...group.Weapons];
                        }
                    });
                    delete group.Weapons; // Entferne alte Waffen-Referenz
                }
                
                // Stelle sicher, dass alle Mitglieder ein Weapons-Array haben
                group.Members.forEach(member => {
                    if (!member.Weapons) {
                        member.Weapons = [];
                    }
                });
            });
        }

        // Collapsible-Funktionalität
        window.toggleCollapsible = function(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            const icon = element.querySelector('.toggle-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                if (icon) icon.textContent = '▼';
            } else {
                content.classList.add('active');
                if (icon) icon.textContent = '▲';
            }
        };

        // Keyword-Definitionen
        const standardKeywords = {
            'lethal hits': 'Critical hits automatisch verwunden (case-insensitive)',
            'sustained hits X': 'Critical hits erzeugen X zusätzliche Hits (X kann Zahl oder Würfel sein, case-insensitive)',
            'devastating wounds': 'Critical wounds ignorieren alle Saves (case-insensitive)',
            'anti-KEYWORD X+': 'Gegen Units mit KEYWORD: Critical wounds bei X+ (z.B. "anti-vehicle 5" oder "anti-infantry 4+", case-insensitive)',
            'twin-linked': 'Reroll alle failed wound rolls (case-insensitive)',
            'rapid fire X': 'Bei Range ≤ Hälfte: +X Attacks (case-insensitive)',
            'blast': '+1 Attack pro 5 Modelle im Ziel (1-4=+0, 5-9=+1, 10-14=+2, etc., case-insensitive)',
            'hazardous': 'Bei Critical Fails: 1 Mortal Wound (case-insensitive, implementiert)',
            'lance': 'Charge: +1 to wound, +1 AP (case-insensitive)',
            'precision': 'Critical hits können Charaktere zuweisen (case-insensitive, implementiert)',
            'torrent': 'Automatische Hits, keine Hit-Würfe erforderlich (case-insensitive, implementiert)',
            'ignores cover': 'Umgeht Cover-Save Bonus des Ziels (case-insensitive, implementiert)',
            'indirect fire': '-1 to hit, maximal 4+ to hit (case-insensitive, implementiert)',
            'psychic': 'Kann durch Deny the Witch gestoppt werden (case-insensitive, implementiert)',
            'melta X': 'Bei Range ≤ Hälfte: +X Damage (case-insensitive, benötigt Parameter X)',
            '+1 to hit': 'Verbessert Hit-Würfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to hit': 'Verschlechtert Hit-Würfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)',
            '+1 to wound': 'Verbessert Wound-Würfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to wound': 'Verschlechtert Wound-Würfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)'
        };

        const customKeywords = {
            'RH1': 'Reroll 1s beim Hit-Wurf',
            'RW1': 'Reroll 1s beim Wound-Wurf',
            'RHMiss': 'Reroll alle fehlgeschlagenen Hit-Würfe',
            'RWMiss': 'Reroll alle fehlgeschlagenen Wound-Würfe',
            'RHNoCrit': 'Reroll 1s beim Hit-Wurf wenn kein Critical Hit',
            'RWNoCrit': 'Reroll 1s beim Wound-Wurf wenn kein Critical Wound',
            'CritHitX': 'Critical Hits bei X+ statt 6+ (z.B. CritHit5+)',
            'CritWoundX': 'Critical Wounds bei X+ statt 6+ (z.B. CritWound4+)',
            '+1D': 'Erhöht ausgehenden Schaden um 1 (case-insensitive)',
            '-1D': 'Reduziert eingehenden Schaden um 1 (minimum 1, case-insensitive)',
            '/2D': 'Halbiert eingehenden Schaden (minimum 1, abgerundet, case-insensitive)',
            'feel no pain X': 'Ignoriert Schaden bei X+ auf 1W6 (z.B. "feel no pain 6", case-insensitive)',
            'feel no pain psychic X': 'Ignoriert Psychic Schaden bei X+ auf 1W6 (case-insensitive)',
            'cover': '+1 Save (außer gegen "ignores cover" Weapons, case-insensitive)',
            '-1 wound when stronger': 'Wenn Stärke > Toughness: -1 to wound (case-insensitive)'
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            populateKeywordModal();
            updateAttackerSelect();
            migrateAttackerData(); // Migration der Angreifer-Daten
            
            // Sicherstellen, dass der Loading-Spinner beim Start versteckt ist
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.classList.remove('active');
            }
        });

        // Utility Functions für UI-Feedback
        window.showError = function(message) {
            console.error(message);
            alert('Fehler: ' + message);
        };

        window.showSuccess = function(message) {
            console.log(message);
            // Temporärer visueller Indikator (könnte später durch Toast-Nachricht ersetzt werden)
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: linear-gradient(45deg, #28a745, #20c997); 
                color: white; padding: 10px 15px; border-radius: 5px; 
                z-index: 10000; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            tempDiv.textContent = message;
            document.body.appendChild(tempDiv);
            
            setTimeout(() => {
                if (tempDiv.parentNode) {
                    tempDiv.parentNode.removeChild(tempDiv);
                }
            }, 3000);
        };

        // Keyword Modal Functions
        window.showKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'block';
        };

        window.closeKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'none';
        };

        // Keyword Selector Functions
        let currentKeywordTarget = null; // 'weapon' or 'defender'

        window.showKeywordSelector = function(target) {
            currentKeywordTarget = target;
            populateKeywordSelector();
            document.getElementById('keywordSelectorModal').style.display = 'block';
        };

        window.closeKeywordSelector = function() {
            document.getElementById('keywordSelectorModal').style.display = 'none';
            currentKeywordTarget = null;
        };

        function populateKeywordSelector() {
            const standardContainer = document.getElementById('selectorStandardKeywords');
            const customContainer = document.getElementById('selectorCustomKeywords');
            
            // Clear existing content
            standardContainer.innerHTML = '';
            customContainer.innerHTML = '';

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-selection-item';
                keywordElement.onclick = () => selectKeyword(keyword);
                keywordElement.innerHTML = `
                    <div class="keyword-selection-name">${keyword}</div>
                    <div class="keyword-selection-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-selection-item';
                keywordElement.onclick = () => selectKeyword(keyword);
                keywordElement.innerHTML = `
                    <div class="keyword-selection-name">${keyword}</div>
                    <div class="keyword-selection-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        function selectKeyword(keyword) {
            if (currentKeywordTarget === 'weapon') {
                if (!window.currentWeaponKeywords.includes(keyword)) {
                    window.currentWeaponKeywords.push(keyword);
                    updateWeaponKeywordsDisplay();
                }
            } else if (currentKeywordTarget === 'defender') {
                if (!window.currentDefenderKeywords.includes(keyword)) {
                    window.currentDefenderKeywords.push(keyword);
                    updateDefenderKeywordsDisplay();
                }
            }
            closeKeywordSelector();
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const keywordModal = document.getElementById('keywordModal');
            const selectorModal = document.getElementById('keywordSelectorModal');
            if (event.target == keywordModal) {
                keywordModal.style.display = 'none';
            }
            if (event.target == selectorModal) {
                selectorModal.style.display = 'none';
                currentKeywordTarget = null;
            }
        };

        // Keyword-Referenz im Modal anzeigen
        function populateKeywordModal() {
            const standardContainer = document.getElementById('modalStandardKeywords');
            const customContainer = document.getElementById('modalCustomKeywords');

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        // Angreifer hinzufügen
        window.addAttacker = function() {
            const groupName = document.getElementById('attackerGroupName').value.trim();
            const name = document.getElementById('attackerName').value.trim();
            const count = parseInt(document.getElementById('attackerCount').value) || 1;
            
            if (!groupName) {
                showError('Bitte geben Sie einen Gruppen-Namen ein.');
                return;
            }
            if (!name) {
                showError('Bitte geben Sie einen Namen für den Angreifer ein.');
                return;
            }

            // Prüfe ob Gruppe bereits existiert
            let group = window.attackers.find(g => g.GroupName === groupName);
            
            if (!group) {
                // Neue Gruppe erstellen
                group = {
                    GroupName: groupName,
                    Members: []
                    // Waffen sind jetzt bei den einzelnen Mitgliedern
                };
                window.attackers.push(group);
            }
            
            // Mitglied zur Gruppe hinzufügen
            const member = {
                Name: name,
                Count: count,
                Weapons: []  // Jedes Mitglied hat seine eigenen Waffen
            };
            
            group.Members.push(member);
            
            // Formular leeren
            document.getElementById('attackerGroupName').value = '';
            document.getElementById('attackerName').value = '';
            document.getElementById('attackerCount').value = '1';
            
            updateAttackersList();
            updateAttackerSelect();
            showSuccess(`${count}x ${name} wurde zur Gruppe "${groupName}" hinzugefügt.`);
        };

        // Verteidiger hinzufügen
        window.addDefender = function() {
            const groupName = document.getElementById('defenderGroupName').value.trim();
            const name = document.getElementById('defenderName').value.trim();
            const isLeader = document.getElementById('defenderIsLeader').checked;
            const models = parseInt(document.getElementById('defenderModels').value);
            const toughness = parseInt(document.getElementById('defenderToughness').value);
            const wounds = parseInt(document.getElementById('defenderWounds').value);
            const save = parseInt(document.getElementById('defenderSave').value);
            const invul = document.getElementById('defenderInvul').value;

            if (!groupName) {
                showError('Bitte geben Sie einen Gruppen-Namen ein.');
                return;
            }
            if (!name) {
                showError('Bitte geben Sie einen Namen für den Verteidiger ein.');
                return;
            }

            // Prüfe ob Gruppe bereits existiert
            let group = window.defenders.find(g => g.GroupName === groupName);
            
            if (!group) {
                // Neue Gruppe erstellen
                group = {
                    GroupName: groupName,
                    Members: []
                };
                window.defenders.push(group);
            }
            
            // Mitglied zur Gruppe hinzufügen
            const member = {
                Name: name,
                type: 'Infantry',
                isLeader: isLeader,
                models: models,
                toughness: toughness,
                wounds: wounds,
                save: save,
                invulnerable: invul ? parseInt(invul) : 7,
                Keywords: [...window.currentDefenderKeywords]
            };
            
            group.Members.push(member);

            clearDefenderForm();
            updateDefendersList();
            const leaderText = isLeader ? ' (Leader)' : '';
            showSuccess(`${models}x ${name}${leaderText} wurde zur Gruppe "${groupName}" hinzugefügt.`);
        };

        // Waffe hinzufügen
        window.addWeapon = function() {
            const attackerValue = document.getElementById('weaponAttackerSelect').value;
            const name = document.getElementById('weaponName').value.trim();
            const type = document.getElementById('weaponType').value;
            const attacks = document.getElementById('weaponAttacks').value.trim();
            const toHit = parseInt(document.getElementById('weaponToHit').value);
            const strength = parseInt(document.getElementById('weaponStrength').value);
            const ap = parseInt(document.getElementById('weaponAP').value);
            const damage = document.getElementById('weaponDamage').value.trim();
            const amount = parseInt(document.getElementById('weaponAmount').value) || 1;

            if (!attackerValue) {
                showError('Bitte wählen Sie einen Angreifer aus.');
                return;
            }

            if (!name) {
                showError('Bitte geben Sie einen Namen für die Waffe ein.');
                return;
            }

            // Parse groupIndex und memberIndex aus dem Wert "groupIndex-memberIndex"
            const [groupIndex, memberIndex] = attackerValue.split('-').map(i => parseInt(i));

            const weapon = {
                name: name,
                type: type,
                attacks: attacks,
                to_hit: toHit,
                strength: strength,
                ap: ap,
                damage: damage,
                amount: amount,
                Keywords: [...new Set(window.currentWeaponKeywords)] // Entferne Duplikate
            };

            // Waffe zum spezifischen Angreifer hinzufügen
            window.attackers[groupIndex].Members[memberIndex].Weapons.push(weapon);
            clearWeaponForm();
            updateAttackersList();
            
            // Waffen-Menü zuklappen nach dem Hinzufügen
            const weaponCollapsible = document.querySelector('button.collapsible');
            const weaponCollapsibles = document.querySelectorAll('button.collapsible');
            let weaponMenuCollapsible = null;
            
            weaponCollapsibles.forEach(collapsible => {
                if (collapsible.textContent.includes('Waffe hinzufügen')) {
                    weaponMenuCollapsible = collapsible;
                }
            });
            
            if (weaponMenuCollapsible && weaponMenuCollapsible.classList.contains('active')) {
                const weaponContent = weaponMenuCollapsible.nextElementSibling;
                weaponMenuCollapsible.classList.remove('active');
                weaponContent.classList.remove('active');
            }
            
            const attackerName = window.attackers[groupIndex].Members[memberIndex].Name;
            const groupName = window.attackers[groupIndex].GroupName;
            showSuccess(`Waffe "${name}" wurde zu ${attackerName} (${groupName}) hinzugefügt.`);
        };

        // Keyword-Funktionen
        window.addWeaponKeyword = function() {
            const input = document.getElementById('weaponKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentWeaponKeywords.includes(keyword)) {
                window.currentWeaponKeywords.push(keyword);
                input.value = '';
                updateWeaponKeywordsDisplay();
            }
        };

        window.addDefenderKeyword = function() {
            const input = document.getElementById('defenderKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentDefenderKeywords.includes(keyword)) {
                window.currentDefenderKeywords.push(keyword);
                input.value = '';
                updateDefenderKeywordsDisplay();
            }
        };

        // Form clearing functions
        window.clearWeaponForm = function() {
            document.getElementById('weaponAttackerSelect').value = '';
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponAmount').value = '1';
            document.getElementById('weaponType').value = 'Ranged';
            document.getElementById('weaponAttacks').value = '1';
            document.getElementById('weaponToHit').value = '4';
            document.getElementById('weaponStrength').value = '4';
            document.getElementById('weaponAP').value = '0';
            document.getElementById('weaponDamage').value = '1';
            document.getElementById('weaponKeywordInput').value = '';
            
            // Keywords leeren
            window.currentWeaponKeywords = [];
            updateWeaponKeywordsDisplay();
        };

        function clearDefenderForm() {
            document.getElementById('defenderGroupName').value = '';
            document.getElementById('defenderName').value = '';
            document.getElementById('defenderIsLeader').checked = false;
            document.getElementById('defenderModels').value = '1';
            document.getElementById('defenderToughness').value = '4';
            document.getElementById('defenderWounds').value = '1';
            document.getElementById('defenderSave').value = '3';
            document.getElementById('defenderInvul').value = '';
            document.getElementById('defenderKeywordInput').value = '';
            
            // Keywords leeren
            window.currentDefenderKeywords = [];
            updateDefenderKeywordsDisplay();
        };

        // Keywords mit Parametern (benötigen X-Werte)
        const parametricKeywords = {
            'melta': { pattern: /^melta\s*(\d+)?$/i, description: 'Bei Range ≤ Hälfte: +X Damage', paramName: 'Bonus-Damage' },
            'anti-': { pattern: /^anti-([^0-9]+)\s*(\d+)\+?$/i, description: 'Gegen KEYWORD: Critical wounds bei X+', paramName: 'Critical-Threshold' },
            'sustained hits': { pattern: /^sustained\s+hits\s*(\d+|d\d+)?$/i, description: 'Critical hits erzeugen X zusätzliche Hits', paramName: 'Extra-Hits' },
            'rapid fire': { pattern: /^rapid\s+fire\s*(\d+)?$/i, description: 'Bei Range ≤ Hälfte: +X Attacks', paramName: 'Bonus-Attacks' },
            'feel no pain': { pattern: /^feel\s+no\s+pain\s*(\d+)\+?$/i, description: 'Ignoriert Schaden bei X+ auf 1W6', paramName: 'Save-Threshold' },
            'crithit': { pattern: /^crithit(\d+)\+?$/i, description: 'Critical Hits bei X+ statt 6+', paramName: 'Hit-Threshold' },
            'critwound': { pattern: /^critwound(\d+)\+?$/i, description: 'Critical Wounds bei X+ statt 6+', paramName: 'Wound-Threshold' }
        };

        function needsParameter(keyword) {
            const keywordLower = keyword.toLowerCase();
            for (const [key, config] of Object.entries(parametricKeywords)) {
                if (keywordLower.includes(key.toLowerCase()) || config.pattern.test(keyword)) {
                    // Prüfe ob bereits ein Parameter vorhanden ist
                    const match = config.pattern.exec(keyword);
                    if (match && match[1]) {
                        return null; // Bereits parametrisiert
                    }
                    return config;
                }
            }
            return null;
        }

        function updateWeaponKeywordsDisplay() {
            const container = document.getElementById('weaponKeywords');
            const paramContainer = document.getElementById('weaponKeywordParameters');
            const paramInputs = paramContainer.querySelector('.keyword-parameter-inputs');
            
            container.innerHTML = '';
            paramInputs.innerHTML = '';
            
            let hasParameters = false;
            
            window.currentWeaponKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeWeaponKeyword(${index})">×</span>
                `;
                container.appendChild(tag);
                
                // Prüfe ob Parameter benötigt wird
                const paramConfig = needsParameter(keyword);
                if (paramConfig) {
                    hasParameters = true;
                    const paramItem = document.createElement('div');
                    paramItem.className = 'keyword-parameter-item';
                    paramItem.innerHTML = `
                        <span class="keyword-parameter-label">${keyword} - ${paramConfig.paramName}:</span>
                        <input type="text" class="keyword-parameter-input" 
                               id="weaponParam_${index}" 
                               placeholder="X" 
                               onchange="updateParametricKeyword('weapon', ${index}, this.value)">
                    `;
                    paramInputs.appendChild(paramItem);
                }
            });
            
            paramContainer.style.display = hasParameters ? 'block' : 'none';
        }

        function updateDefenderKeywordsDisplay() {
            const container = document.getElementById('defenderKeywords');
            const paramContainer = document.getElementById('defenderKeywordParameters');
            const paramInputs = paramContainer.querySelector('.keyword-parameter-inputs');
            
            container.innerHTML = '';
            paramInputs.innerHTML = '';
            
            let hasParameters = false;
            
            window.currentDefenderKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeDefenderKeyword(${index})">×</span>
                `;
                container.appendChild(tag);
                
                // Prüfe ob Parameter benötigt wird
                const paramConfig = needsParameter(keyword);
                if (paramConfig) {
                    hasParameters = true;
                    const paramItem = document.createElement('div');
                    paramItem.className = 'keyword-parameter-item';
                    paramItem.innerHTML = `
                        <span class="keyword-parameter-label">${keyword} - ${paramConfig.paramName}:</span>
                        <input type="text" class="keyword-parameter-input" 
                               id="defenderParam_${index}" 
                               placeholder="X" 
                               onchange="updateParametricKeyword('defender', ${index}, this.value)">
                    `;
                    paramInputs.appendChild(paramItem);
                }
            });
            
            paramContainer.style.display = hasParameters ? 'block' : 'none';
        }

        window.updateParametricKeyword = function(type, index, value) {
            const keywords = type === 'weapon' ? window.currentWeaponKeywords : window.currentDefenderKeywords;
            const keyword = keywords[index];
            const paramConfig = needsParameter(keyword);
            
            if (paramConfig && value) {
                // Ersetze das Keyword mit dem parametrisierten Wert
                let newKeyword = keyword;
                if (keyword.toLowerCase().includes('melta')) {
                    newKeyword = `melta ${value}`;
                } else if (keyword.toLowerCase().includes('anti-')) {
                    // Extrahiere das Anti-Target und füge den Wert hinzu
                    const match = keyword.match(/anti-([^0-9]+)/i);
                    if (match) {
                        newKeyword = `anti-${match[1].trim()} ${value}+`;
                    }
                } else if (keyword.toLowerCase().includes('sustained hits')) {
                    newKeyword = `sustained hits ${value}`;
                } else if (keyword.toLowerCase().includes('rapid fire')) {
                    newKeyword = `rapid fire ${value}`;
                } else if (keyword.toLowerCase().includes('feel no pain')) {
                    newKeyword = `feel no pain ${value}+`;
                } else if (keyword.toLowerCase().includes('crithit')) {
                    newKeyword = `CritHit${value}+`;
                } else if (keyword.toLowerCase().includes('critwound')) {
                    newKeyword = `CritWound${value}+`;
                }
                
                keywords[index] = newKeyword;
                
                if (type === 'weapon') {
                    updateWeaponKeywordsDisplay();
                } else {
                    updateDefenderKeywordsDisplay();
                }
            }
        };

        window.removeWeaponKeyword = function(index) {
            window.currentWeaponKeywords.splice(index, 1);
            updateWeaponKeywordsDisplay();
        };

        window.removeDefenderKeyword = function(index) {
            window.currentDefenderKeywords.splice(index, 1);
            updateDefenderKeywordsDisplay();
        };

        // Listen aktualisieren
        function updateAttackersList() {
            const container = document.getElementById('attackersList');
            container.innerHTML = '';

            window.attackers.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${group.GroupName}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small" onclick="editAttackerGroup(${groupIndex})">Bearbeiten</button>
                            <button class="btn btn-small btn-danger" onclick="removeAttackerGroup(${groupIndex})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Mitglieder:</strong><br>
                        ${group.Members.map((member, mIndex) => `
                            <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.03); border-radius: 3px;">
                                <div style="margin-bottom: 5px;">
                                    ${member.Count}x ${member.Name}
                                    <button class="btn btn-small" onclick="editAttackerMember(${groupIndex}, ${mIndex})" style="float: right; margin-left: 5px;">Bearbeiten</button>
                                    <button class="btn btn-small btn-danger" onclick="removeAttackerMember(${groupIndex}, ${mIndex})" style="float: right;">Entfernen</button>
                                </div>
                                ${member.Weapons && member.Weapons.length > 0 ? `
                                    <div style="margin-left: 10px; font-size: 0.9em; color: #b8c6db;">
                                        <strong>Waffen (${member.Weapons.length}):</strong><br>
                                        ${member.Weapons.map((weapon, wIndex) => `
                                            <div style="margin: 2px 0; padding: 3px; background: rgba(255,255,255,0.05); border-radius: 2px;">
                                                <strong>${weapon.name}</strong> (${weapon.type})<br>
                                                A: ${weapon.attacks} | Hit: ${weapon.to_hit}+ | S: ${weapon.strength} | AP: -${weapon.ap} | D: ${weapon.damage} | Amount: ${weapon.amount}<br>
                                                Keywords: ${weapon.Keywords.join(', ') || 'Keine'}
                                                <div style="margin-top: 3px;">
                                                    <button class="btn btn-small" onclick="editWeapon(${groupIndex}, ${mIndex}, ${wIndex})">Bearbeiten</button>
                                                    <button class="btn btn-small btn-danger" onclick="removeWeapon(${groupIndex}, ${mIndex}, ${wIndex})">Entfernen</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div style="margin-left: 10px; font-size: 0.9em; color: #888;">Keine Waffen</div>'}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateDefendersList() {
            const container = document.getElementById('defendersList');
            container.innerHTML = '';

            window.defenders.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${group.GroupName}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small" onclick="editDefenderGroup(${groupIndex})">Bearbeiten</button>
                            <button class="btn btn-small btn-danger" onclick="removeDefenderGroup(${groupIndex})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Mitglieder:</strong><br>
                        ${group.Members.map((member, mIndex) => `
                            <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 3px;">
                                <strong>${member.models}x ${member.Name}${member.isLeader ? ' 🎖️ (Leader)' : ''}</strong><br>
                                T: ${member.toughness} | W: ${member.wounds} | Save: ${member.save}+ | 
                                Inv: ${member.invulnerable < 7 ? member.invulnerable + '+' : 'Keine'}<br>
                                Keywords: ${member.Keywords.join(', ') || 'Keine'}
                                <div style="margin-top: 5px;">
                                    <button class="btn btn-small" onclick="editDefenderMember(${groupIndex}, ${mIndex})">Bearbeiten</button>
                                    <button class="btn btn-small btn-danger" onclick="removeDefenderMember(${groupIndex}, ${mIndex})">Entfernen</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateAttackerSelect() {
            const select = document.getElementById('weaponAttackerSelect');
            select.innerHTML = '<option value="">Bitte Angreifer auswählen</option>';
            
            window.attackers.forEach((group, groupIndex) => {
                group.Members.forEach((member, memberIndex) => {
                    const option = document.createElement('option');
                    option.value = `${groupIndex}-${memberIndex}`;
                    option.textContent = `${member.Name} (${group.GroupName}) - ${member.Count}x`;
                    select.appendChild(option);
                });
            });
        }

        // Entfernen-Funktionen für Gruppen
        window.removeAttackerGroup = function(groupIndex) {
            const group = window.attackers[groupIndex];
            if (confirm(`Möchten Sie die gesamte Gruppe "${group.GroupName}" entfernen?`)) {
                window.attackers.splice(groupIndex, 1);
                updateAttackersList();
                updateAttackerSelect();
            }
        };

        window.removeDefenderGroup = function(groupIndex) {
            const group = window.defenders[groupIndex];
            if (confirm(`Möchten Sie die gesamte Gruppe "${group.GroupName}" entfernen?`)) {
                window.defenders.splice(groupIndex, 1);
                updateDefendersList();
            }
        };

        window.removeAttackerMember = function(groupIndex, memberIndex) {
            const group = window.attackers[groupIndex];
            const member = group.Members[memberIndex];
            if (confirm(`Möchten Sie ${member.Count}x ${member.Name} entfernen?`)) {
                group.Members.splice(memberIndex, 1);
                // Wenn keine Mitglieder mehr, Gruppe entfernen
                if (group.Members.length === 0) {
                    window.attackers.splice(groupIndex, 1);
                    updateAttackerSelect();
                }
                updateAttackersList();
            }
        };

        window.removeDefenderMember = function(groupIndex, memberIndex) {
            const group = window.defenders[groupIndex];
            const member = group.Members[memberIndex];
            if (confirm(`Möchten Sie ${member.models}x ${member.Name} entfernen?`)) {
                group.Members.splice(memberIndex, 1);
                // Wenn keine Mitglieder mehr, Gruppe entfernen
                if (group.Members.length === 0) {
                    window.defenders.splice(groupIndex, 1);
                }
                updateDefendersList();
            }
        };

        window.removeWeapon = function(groupIndex, memberIndex, weaponIndex) {
            window.attackers[groupIndex].Members[memberIndex].Weapons.splice(weaponIndex, 1);
            updateAttackersList();
        };

        window.editWeapon = function(groupIndex, memberIndex, weaponIndex) {
            const weapon = window.attackers[groupIndex].Members[memberIndex].Weapons[weaponIndex];
            
            // Lade die aktuellen Werte in das Waffen-Formular
            document.getElementById('weaponName').value = weapon.name;
            document.getElementById('weaponType').value = weapon.type;
            document.getElementById('weaponAttacks').value = weapon.attacks;
            document.getElementById('weaponToHit').value = weapon.to_hit;
            document.getElementById('weaponStrength').value = weapon.strength;
            document.getElementById('weaponAP').value = weapon.ap;
            document.getElementById('weaponDamage').value = weapon.damage;
            document.getElementById('weaponAmount').value = weapon.amount;
            
            // Lade Keywords - entferne Duplikate und bereinige
            let cleanKeywords = weapon.Keywords || [];
            if (Array.isArray(cleanKeywords)) {
                cleanKeywords = cleanKeywords.filter(k => 
                    k && 
                    k.trim() !== '' && 
                    !k.startsWith('WoundBonus') &&
                    !k.includes('undefined')
                );
                cleanKeywords = [...new Set(cleanKeywords)]; // Entferne Duplikate
            } else {
                cleanKeywords = [];
            }
            window.currentWeaponKeywords = cleanKeywords;
            updateWeaponKeywordsDisplay();
            
            // Speichere die Indizes für das Update
            window.editingWeaponGroupIndex = groupIndex;
            window.editingWeaponMemberIndex = memberIndex;
            window.editingWeaponIndex = weaponIndex;
            
            // Ändere den Button-Text und die Funktion
            const addButton = document.querySelector('button[onclick="addWeapon()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Waffe aktualisieren';
            addButton.onclick = function() {
                updateWeapon();
                addButton.textContent = originalText;
                addButton.onclick = window.addWeapon;
                // Schließe das Menü nach dem Update
                const weaponCollapsible = document.querySelector('.collapsible');
                if (weaponCollapsible && weaponCollapsible.textContent.includes('Waffe hinzufügen')) {
                    const content = weaponCollapsible.nextElementSibling;
                    if (content && content.style.display === 'block') {
                        weaponCollapsible.classList.remove('active');
                        content.style.display = 'none';
                    }
                }
            };
            
            // Öffne das Waffen-Menü
            const weaponCollapsible = document.querySelector('.collapsible');
            if (weaponCollapsible && weaponCollapsible.textContent.includes('Waffe hinzufügen')) {
                const content = weaponCollapsible.nextElementSibling;
                if (content) {
                    weaponCollapsible.classList.add('active');
                    content.style.display = 'block';
                }
            }
            
            showSuccess('Waffen-Daten in das Formular geladen. Bearbeiten Sie die Werte und klicken Sie "Waffe aktualisieren".');
        };

        // Debug: Überprüfe ob editWeapon verfügbar ist
        console.log('editWeapon function available:', typeof window.editWeapon);

        // Notfall-Funktion: Bereinige alle Keywords aller Waffen
        window.cleanupAllWeaponKeywords = function() {
            let totalCleaned = 0;
            
            window.attackers.forEach((group, groupIndex) => {
                group.Members.forEach((member, memberIndex) => {
                    member.Weapons.forEach((weapon, weaponIndex) => {
                        if (weapon.Keywords) {
                            const originalLength = weapon.Keywords.length;
                            
                            // Entferne alle WoundBonus Keywords
                            weapon.Keywords = weapon.Keywords.filter(k => !k.startsWith('WoundBonus'));
                            
                            // Entferne Duplikate
                            weapon.Keywords = [...new Set(weapon.Keywords)];
                            
                            // Entferne leere oder undefined Keywords
                            weapon.Keywords = weapon.Keywords.filter(k => k && k.trim() !== '');
                            
                            totalCleaned += (originalLength - weapon.Keywords.length);
                        }
                    });
                });
            });
            
            updateAttackersList();
            showSuccess(`Keyword-Bereinigung abgeschlossen! ${totalCleaned} doppelte/fehlerhafte Keywords entfernt.`);
        };

        // Verbesserte updateWeapon Funktion mit zusätzlicher Keyword-Bereinigung
        function updateWeapon() {
            const groupIndex = window.editingWeaponGroupIndex;
            const memberIndex = window.editingWeaponMemberIndex;
            const weaponIndex = window.editingWeaponIndex;
            
            if (groupIndex === undefined || memberIndex === undefined || weaponIndex === undefined) {
                showError('Fehler beim Update: Waffen-Indizes nicht gefunden.');
                return;
            }
            
            const weapon = window.attackers[groupIndex].Members[memberIndex].Weapons[weaponIndex];
            
            // Update die Waffen-Daten
            weapon.name = document.getElementById('weaponName').value.trim();
            weapon.type = document.getElementById('weaponType').value;
            weapon.attacks = document.getElementById('weaponAttacks').value;
            weapon.to_hit = parseInt(document.getElementById('weaponToHit').value);
            weapon.strength = parseInt(document.getElementById('weaponStrength').value);
            weapon.ap = parseInt(document.getElementById('weaponAP').value);
            weapon.damage = document.getElementById('weaponDamage').value;
            weapon.amount = parseInt(document.getElementById('weaponAmount').value) || 1;
            weapon.Keywords = [...new Set(window.currentWeaponKeywords)]; // Entferne Duplikate
            
            // Zusätzliche Bereinigung: Entferne WoundBonus Keywords und andere Fehler
            weapon.Keywords = weapon.Keywords.filter(k => 
                k && 
                k.trim() !== '' && 
                !k.startsWith('WoundBonus') &&
                !k.includes('undefined')
            );
            
            // Nochmals Duplikate entfernen zur Sicherheit
            weapon.Keywords = [...new Set(weapon.Keywords)];
            
            // Reset die Editing-Indizes
            delete window.editingWeaponGroupIndex;
            delete window.editingWeaponMemberIndex;
            delete window.editingWeaponIndex;
            
            updateAttackersList();
            resetWeaponForm();
            showSuccess('Waffe wurde erfolgreich aktualisiert!');
        }

        // Waffen-Formular zurücksetzen
        function resetWeaponForm() {
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponType').value = 'Ranged';
            document.getElementById('weaponAttacks').value = '1';
            document.getElementById('weaponToHit').value = 4;
            document.getElementById('weaponStrength').value = 4;
            document.getElementById('weaponAP').value = 0;
            document.getElementById('weaponDamage').value = '1';
            document.getElementById('weaponAmount').value = 1;
            
            // Reset Keywords
            window.currentWeaponKeywords = [];
            updateWeaponKeywordsDisplay();
            
            // Reset Attacker Selection to first option
            const attackerSelect = document.getElementById('weaponAttackerSelect');
            if (attackerSelect && attackerSelect.options.length > 0) {
                attackerSelect.selectedIndex = 0;
            }
        }

        // JSON Import/Export Funktionen
        window.exportJson = function() {
            const data = {
                attackers: window.attackers,
                defenders: window.defenders,
                version: "2.0",
                timestamp: new Date().toISOString()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `warhammer40k_simulation_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('JSON-Datei wurde heruntergeladen!');
        };

        window.importJson = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.attackers && data.defenders) {
                            // Bereinige Keywords vor dem Import
                            cleanupKeywords(data);
                            
                            window.attackers = data.attackers;
                            window.defenders = data.defenders;
                            
                            // Migration für neue Struktur ausführen
                            migrateAttackerData();
                            
                            updateAttackersList();
                            updateDefendersList();
                            updateAttackerSelect();
                            showSuccess('JSON-Daten erfolgreich importiert!');
                        } else if (data.Attackers && data.Defenders) {
                            // Support für das neue Format
                            // Bereinige Keywords vor dem Import
                            cleanupKeywords(data);
                            
                            // Konvertiere das neue Format in das alte
                            window.attackers = data.Attackers.map(attacker => ({
                                GroupName: attacker.Name,
                                Members: [{
                                    Name: attacker.Name,
                                    Count: 1,
                                    Weapons: attacker.Weapons || []
                                }]
                            }));
                            
                            window.defenders = data.Defenders.map(defender => ({
                                GroupName: defender.Name,
                                Members: [defender]
                            }));
                            
                            updateAttackersList();
                            updateDefendersList();
                            updateAttackerSelect();
                            showSuccess('JSON-Daten erfolgreich importiert!');
                        } else {
                            showError('Ungültiges JSON-Format. Bitte stellen Sie sicher, dass die Datei Angreifer und Verteidiger enthält.');
                        }
                    } catch (error) {
                        showError('Fehler beim Parsen der JSON-Datei: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        // Funktion zum Bereinigen von Keywords
        function cleanupKeywords(data) {
            // Bereinige Angreifer Keywords
            if (data.attackers) {
                data.attackers.forEach(group => {
                    if (group.Members) {
                        group.Members.forEach(member => {
                            if (member.Weapons) {
                                member.Weapons.forEach(weapon => {
                                    if (weapon.Keywords) {
                                        weapon.Keywords = [...new Set(weapon.Keywords)];
                                    }
                                });
                            }
                        });
                    }
                });
            }
            
            // Bereinige neues Format
            if (data.Attackers) {
                data.Attackers.forEach(attacker => {
                    if (attacker.Weapons) {
                        attacker.Weapons.forEach(weapon => {
                            if (weapon.Keywords) {
                                weapon.Keywords = [...new Set(weapon.Keywords)];
                            }
                        });
                    }
                });
            }
            
            // Bereinige Verteidiger Keywords
            if (data.defenders) {
                data.defenders.forEach(group => {
                    if (group.Members) {
                        group.Members.forEach(member => {
                            if (member.Keywords) {
                                member.Keywords = [...new Set(member.Keywords)];
                            }
                        });
                    }
                });
            }
            
            if (data.Defenders) {
                data.Defenders.forEach(defender => {
                    if (defender.Keywords) {
                        defender.Keywords = [...new Set(defender.Keywords)];
                    }
                });
            }
        }

        // PDF Export Funktion  
        window.exportResultsToPDF = function() {
            if (!window.simulationResults || window.simulationResults.length === 0) {
                showError('Keine Simulationsergebnisse zum Exportieren vorhanden. Führen Sie zuerst eine Simulation durch.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);
            
            // Helper function to check if new page is needed
            function checkNewPage(requiredSpace = 25) {
                if (yPos > pageHeight - requiredSpace) {
                    doc.addPage();
                    yPos = margin;
                    return true;
                }
                return false;
            }
            
            // Helper function to draw section divider
            function drawDivider() {
                doc.setDrawColor(100, 100, 100);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;
            }
            
            // Helper function to create chart canvas
            function createDistributionChart(distributionData, title, maxValue) {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Chart settings
                const chartArea = {
                    x: 50,
                    y: 30,
                    width: 300,
                    height: 120
                };
                
                // Draw title
                ctx.fillStyle = 'black';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(title, canvas.width / 2, 20);
                
                // Draw axes
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(chartArea.x, chartArea.y + chartArea.height);
                ctx.lineTo(chartArea.x + chartArea.width, chartArea.y + chartArea.height);
                ctx.moveTo(chartArea.x, chartArea.y);
                ctx.lineTo(chartArea.x, chartArea.y + chartArea.height);
                ctx.stroke();
                
                if (distributionData && distributionData.length > 0) {
                    const barWidth = chartArea.width / distributionData.length;
                    const maxPercentage = Math.max(...distributionData.map(d => d.percentage));
                    
                    distributionData.forEach((data, index) => {
                        const barHeight = (data.percentage / maxPercentage) * chartArea.height;
                        const x = chartArea.x + (index * barWidth);
                        const y = chartArea.y + chartArea.height - barHeight;
                        
                        // Draw bar
                        ctx.fillStyle = '#4CAF50';
                        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                        
                        // Draw value label
                        ctx.fillStyle = 'black';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`≥${data.value}`, x + barWidth/2, chartArea.y + chartArea.height + 15);
                        
                        // Draw percentage
                        ctx.font = '8px Arial';
                        ctx.fillText(`${data.percentage.toFixed(1)}%`, x + barWidth/2, y - 5);
                    });
                }
                
                // Y-axis labels
                ctx.fillStyle = 'black';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('100%', chartArea.x - 5, chartArea.y + 5);
                ctx.fillText('0%', chartArea.x - 5, chartArea.y + chartArea.height + 5);
                
                return canvas;
            }
            
            // Title Page
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Warhammer 40k', pageWidth / 2, 40, { align: 'center' });
            doc.text('Kampfsimulation - Bericht', pageWidth / 2, 55, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Erstellt am: ${new Date().toLocaleString('de-DE')}`, pageWidth / 2, 70, { align: 'center' });
            
            // Summary Box
            yPos = 90;
            doc.setDrawColor(0, 0, 0);
            doc.rect(margin, yPos, contentWidth, 40);
            
            yPos += 15;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Simulation Übersicht', margin + 10, yPos);
            
            yPos += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Anzahl Angreifer-Gruppen: ${window.simulationResults.length}`, margin + 10, yPos);
            
            const totalDefenders = window.simulationResults.reduce((sum, result) => sum + result.Target.length, 0);
            yPos += 6;
            doc.text(`Anzahl Verteidiger-Gruppen: ${totalDefenders}`, margin + 10, yPos);
            
            // Start detailed results on new page
            doc.addPage();
            yPos = margin;
            
            // Detailed Results
            window.simulationResults.forEach((attackerResult, attackerIndex) => {
                checkNewPage(40);
                
                // Angreifer-Gruppe Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 150);
                doc.text(`${attackerResult.Name}`, margin, yPos);
                yPos += 12;
                
                drawDivider();
                
                attackerResult.Target.forEach((targetResult, targetIndex) => {
                    checkNewPage(50);
                    
                    // Verteidiger-Gruppe
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(150, 0, 0);
                    doc.text(`Ziel: ${targetResult.Name}`, margin + 10, yPos);
                    yPos += 10;
                    
                    // Waffen-Ergebnisse Sektion
                    if (targetResult.Weapons && targetResult.Weapons.length > 0) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text('Waffen-Statistiken', margin + 20, yPos);
                        yPos += 8;
                        
                        // Waffen-Tabelle Header
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        const tableX = margin + 25;
                        doc.text('Waffe', tableX, yPos);
                        doc.text('Treffer', tableX + 80, yPos);
                        doc.text('Wunden', tableX + 110, yPos);
                        doc.text('Saves', tableX + 140, yPos);
                        doc.text('Schaden', tableX + 170, yPos);
                        yPos += 6;
                        
                        // Draw table line
                        doc.setDrawColor(200, 200, 200);
                        doc.line(tableX, yPos - 2, tableX + 200, yPos - 2);
                        yPos += 2;
                        
                        doc.setFont(undefined, 'normal');
                        targetResult.Weapons.forEach(weapon => {
                            checkNewPage();
                            
                            // Truncate weapon name if too long
                            let weaponName = weapon.Name;
                            if (weaponName.length > 25) {
                                weaponName = weaponName.substring(0, 22) + '...';
                            }
                            
                            doc.text(weaponName, tableX, yPos);
                            doc.text(weapon.Hits.toFixed(1), tableX + 80, yPos);
                            doc.text(weapon.Wounds.toFixed(1), tableX + 110, yPos);
                            doc.text(weapon.FailedSaves.toFixed(1), tableX + 140, yPos);
                            doc.text(weapon.AverageDamage.toFixed(1), tableX + 170, yPos);
                            yPos += 6;
                        });
                        
                        yPos += 5;
                    }
                    
                    // Member-Ergebnisse Sektion
                    if (targetResult.Members && targetResult.Members.length > 0) {
                        checkNewPage(30);
                        
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('Verteidiger-Ergebnisse', margin + 20, yPos);
                        yPos += 10;
                        
                        targetResult.Members.forEach(member => {
                            checkNewPage(35);
                            
                            const leaderText = member.IsLeader ? ' (Leader)' : '';
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${member.Name}${leaderText}`, margin + 25, yPos);
                            yPos += 8;
                            
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                            
                            // Stats in zwei Spalten
                            const leftCol = margin + 30;
                            const rightCol = margin + 120;
                            
                            doc.text(`Modelle vernichtet: ${member.ModelsDestroyed.toFixed(2)}/${member.MaximumModels}`, leftCol, yPos);
                            doc.text(`Gesamtschaden: ${member.TotalDamage.toFixed(2)}`, rightCol, yPos);
                            yPos += 6;
                            
                            doc.text(`Komplette Vernichtung: ${member.CompleteWipeoutChance.toFixed(1)}%`, leftCol, yPos);
                            yPos += 10;
                            
                            // Distribution Chart
                            if (member.KillDistribution && member.KillDistribution.length > 0) {
                                checkNewPage(60);
                                
                                const isSingleModel = member.MaximumModels === 1;
                                const chartTitle = isSingleModel ? 
                                    `Wahrscheinlichkeitsverteilung - Wunden (${member.Name})` : 
                                    `Wahrscheinlichkeitsverteilung - Kills (${member.Name})`;
                                
                                const canvas = createDistributionChart(member.KillDistribution, chartTitle, 
                                    isSingleModel ? member.MaxWounds : member.MaximumModels);
                                
                                // Convert canvas to image and add to PDF
                                const imgData = canvas.toDataURL('image/png');
                                const imgWidth = 120;
                                const imgHeight = 60;
                                
                                doc.addImage(imgData, 'PNG', margin + 25, yPos, imgWidth, imgHeight);
                                yPos += imgHeight + 10;
                            }
                        });
                    }
                    
                    yPos += 10;
                    drawDivider();
                });
                
                yPos += 10;
            });
            
            // Footer on each page
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Seite ${i} von ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                doc.text('Warhammer 40k Simulationsbericht', margin, pageHeight - 10);
            }
            
            // PDF speichern
            doc.save(`warhammer40k_simulation_${new Date().toISOString().split('T')[0]}.pdf`);
            showSuccess('Strukturierter PDF-Report mit Diagrammen wurde heruntergeladen!');
        };

        // Export Simulation Results to JSON
        window.exportResultsToJson = function() {
            if (!window.simulationResults || window.simulationResults.length === 0) {
                showError('Keine Simulationsergebnisse zum Exportieren vorhanden.');
                return;
            }
            
            const data = {
                simulationResults: window.simulationResults,
                attackers: window.attackers,
                defenders: window.defenders,
                version: "2.0",
                timestamp: new Date().toISOString()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `warhammer40k_simulation_results_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Simulationsergebnisse als JSON-Datei heruntergeladen!');
        };

        // Simulation ausführen
        window.runSimulation = function() {
            console.log('runSimulation called');
            console.log('Attackers:', window.attackers);
            console.log('Defenders:', window.defenders);
            
            if (window.attackers.length === 0) {
                showError('Bitte fügen Sie mindestens einen Angreifer hinzu.');
                return;
            }

            if (window.defenders.length === 0) {
                showError('Bitte fügen Sie mindestens einen Verteidiger hinzu.');
                return;
            }

            // Prüfen ob alle Angreifer Waffen haben
            const attackersWithoutWeapons = [];
            window.attackers.forEach(group => {
                group.Members.forEach(member => {
                    if (!member.Weapons || member.Weapons.length === 0) {
                        attackersWithoutWeapons.push(`${member.Name} (${group.GroupName})`);
                    }
                });
            });
            
            if (attackersWithoutWeapons.length > 0) {
                showError(`Die folgenden Angreifer haben keine Waffen: ${attackersWithoutWeapons.join(', ')}`);
                return;
            }

            const amount = parseInt(document.getElementById('simulationAmount').value);
            console.log('Simulation amount:', amount);
            
            // Loading anzeigen
            document.getElementById('loadingSpinner').classList.add('active');

            // Simulation in nächstem Frame starten (für Loading-Animation)
            setTimeout(() => {
                try {
                    // Konvertiere UI-Gruppen in das für die Simulation erwartete Format
                    const simulationData = {
                        Amount: amount,
                        Attackers: [],
                        Defenders: []
                    };

                    // Transformiere Verteidiger-Gruppen in das erwartete Format
                    window.defenders.forEach(group => {
                        simulationData.Defenders.push({
                            Name: group.GroupName,
                            Members: group.Members.map(member => ({
                                Name: member.Name,
                                type: member.type,
                                isLeader: member.isLeader || false,
                                toughness: member.toughness,
                                wounds: member.wounds,
                                models: member.models,
                                save: member.save,
                                invulnerable: member.invulnerable,
                                Keywords: member.Keywords
                            }))
                        });
                    });

                    // Transformiere Angreifer-Gruppen in das erwartete Format
                    window.attackers.forEach(group => {
                        group.Members.forEach(member => {
                            // Erstelle einen Angreifer für die gesamte Gruppe dieses Mitglieds
                            const attackerName = `${member.Name} (${group.GroupName})`;
                                
                            simulationData.Attackers.push({
                                Name: attackerName,
                                Weapons: member.Weapons.map(weapon => ({
                                    name: weapon.name,
                                    type: weapon.type,
                                    attacks: weapon.attacks,
                                    to_hit: weapon.to_hit,
                                    strength: weapon.strength,
                                    ap: weapon.ap,
                                    damage: weapon.damage,
                                    Keywords: weapon.Keywords,
                                    amount: weapon.amount // Don't multiply here - the amount field already represents total weapons
                                }))
                            });
                        });
                    });

                    console.log('Simulation data:', simulationData);
                    console.log('runCombatSimulation function type:', typeof window.runCombatSimulation);

                    if (typeof window.runCombatSimulation !== 'function') {
                        throw new Error('Simulation-Engine nicht verfügbar. Bitte laden Sie die Seite neu.');
                    }

                    window.simulationResults = window.runCombatSimulation(simulationData);
                    console.log('Simulation results:', window.simulationResults);
                    displayResults();
                    document.getElementById('resultsPanel').style.display = 'block';
                    
                    // Zu Ergebnissen scrollen
                    document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
                    
                    showSuccess('Simulation erfolgreich abgeschlossen!');
                } catch (error) {
                    console.error('Simulation Error:', error);
                    showError('Fehler bei der Simulation: ' + error.message);
                } finally {
                    document.getElementById('loadingSpinner').classList.remove('active');
                }
            }, 100);
        };

        // Ergebnisse anzeigen (komplett neu - sicher gegen undefined-Werte)
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            if (!window.simulationResults || window.simulationResults.length === 0) {
                container.innerHTML = '<p>Keine Ergebnisse verfügbar.</p>';
                return;
            }

            window.simulationResults.forEach((attackerResult, attackerIndex) => {
                const attackerDiv = document.createElement('div');
                attackerDiv.className = 'result-section';
                
                let attackerHtml = `
                    <h3>🗡️ ${safeString(attackerResult.Name || 'Unbekannter Angreifer')}</h3>
                `;

                if (attackerResult.Target && attackerResult.Target.length > 0) {
                    attackerResult.Target.forEach((targetResult, targetIndex) => {
                        attackerHtml += `
                            <div class="target-result">
                                <h4>🎯 vs. ${safeString(targetResult.Name || 'Unbekannter Verteidiger')}</h4>
                        `;

                        // Waffen-Ergebnisse (kollabierbar)
                        if (targetResult.Weapons && targetResult.Weapons.length > 0) {
                            attackerHtml += `
                                <div class="weapons-section">
                                    <button class="collapsible-btn" onclick="toggleCollapsible(this)">
                                        ⚔️ Waffen-Statistiken (${targetResult.Weapons.length}) 
                                        <span class="toggle-icon">▼</span>
                                    </button>
                                    <div class="collapsible-content">
                                        <div class="weapons-grid">
                            `;

                            targetResult.Weapons.forEach((weapon, weaponIndex) => {
                                attackerHtml += `
                                    <div class="weapon-card">
                                        <h5>${safeString(weapon.Name || 'Unbekannte Waffe')}</h5>
                                        <div class="weapon-stats">
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Treffer:</span>
                                                <span class="stat-value">${safeNumber(weapon.Hits).toFixed(2)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Verwundungen:</span>
                                                <span class="stat-value">${safeNumber(weapon.Wounds).toFixed(2)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Fehlgeschlagene Saves:</span>
                                                <span class="stat-value">${safeNumber(weapon.FailedSaves).toFixed(2)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Schaden:</span>
                                                <span class="stat-value">${safeNumber(weapon.AverageDamage).toFixed(2)}</span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            });

                            attackerHtml += `
                                        </div>
                                    </div>
                                </div>
                            `;
                        }

                        // Verteidiger-Ergebnisse
                        if (targetResult.Members && targetResult.Members.length > 0) {
                            attackerHtml += `
                                <div class="defenders-section">
                                    <h5>🛡️ Ergebnisse pro Verteidiger</h5>
                                    <div class="defenders-grid">
                            `;

                            targetResult.Members.forEach((member, memberIndex) => {
                                const leaderIcon = member.IsLeader ? '🎖️ ' : '';
                                const isSingleModel = member.MaximumModels === 1;
                                
                                attackerHtml += `
                                    <div class="defender-card ${member.IsLeader ? 'leader' : ''}">
                                        <h6>${leaderIcon}${safeString(member.Name || 'Unbekannter Verteidiger')}</h6>
                                        <div class="defender-stats">
                                `;
                                
                                if (isSingleModel) {
                                    // Für Einzelmodelle: Zeige Wunden statt Modelle
                                    attackerHtml += `
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Wunden zugefügt:</span>
                                                <span class="stat-value">${safeNumber(member.TotalDamage).toFixed(2)}/${member.MaxWounds || 'N/A'}</span>
                                            </div>
                                    `;
                                } else {
                                    // Für Mehrfachmodelle: Zeige Modelle vernichtet
                                    attackerHtml += `
                                            <div class="stat-item">
                                                <span class="stat-label">Modelle vernichtet:</span>
                                                <span class="stat-value">${safeNumber(member.ModelsDestroyed).toFixed(2)}/${safeNumber(member.MaximumModels)}</span>
                                            </div>
                                    `;
                                }
                                
                                attackerHtml += `
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Schaden:</span>
                                                <span class="stat-value">${safeNumber(member.TotalDamage).toFixed(2)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Komplette Vernichtung:</span>
                                                <span class="stat-value">${safeNumber(member.CompleteWipeoutChance).toFixed(1)}%</span>
                                            </div>
                                        </div>
                                `;

                                // Kill-Distribution anzeigen
                                if (member.KillDistribution && member.KillDistribution.length > 0) {
                                    const distributionTitle = isSingleModel ? 
                                        "Wahrscheinlichkeitsverteilung (≥X Wunden)" : 
                                        "Wahrscheinlichkeitsverteilung (≥X Kills)";
                                    
                                    attackerHtml += `
                                        <div class="kill-distribution">
                                            <h6>${distributionTitle}</h6>
                                            <div class="distribution-chart">
                                                <div class="chart-bars-row">
                                    `;

                                    member.KillDistribution.forEach(dist => {
                                        const barHeight = Math.max(3, (dist.percentage / 100) * 100); // 100px max height
                                        attackerHtml += `
                                            <div class="chart-bar-container">
                                                <div class="chart-bar" style="height: ${barHeight}px; background-color: #4CAF50;">
                                                    <span class="bar-label">${dist.percentage.toFixed(0)}%</span>
                                                </div>
                                                <span class="bar-text">≥${dist.value}</span>
                                            </div>
                                        `;
                                    });

                                    attackerHtml += `
                                                </div>
                                            </div>
                                            <div class="distribution-list">
                                    `;

                                    member.KillDistribution.forEach(dist => {
                                        const unit = isSingleModel ? "Wunden" : "Modelle";
                                        attackerHtml += `
                                            <div class="distribution-item">
                                                <span>≥${dist.value} ${unit}:</span>
                                                <span>${dist.percentage.toFixed(1)}%</span>
                                            </div>
                                        `;
                                    });

                                    attackerHtml += `
                                            </div>
                                        </div>
                                    `;
                                }

                                attackerHtml += `</div>`;
                            });

                            attackerHtml += `
                                    </div>
                                </div>
                            `;
                        }

                        attackerHtml += `</div>`;
                    });
                } else {
                    attackerHtml += '<p>Keine Ziele verfügbar.</p>';
                }

                attackerDiv.innerHTML = attackerHtml;
                container.appendChild(attackerDiv);
            });
        }

        // Hilfsfunktionen für sichere Werte
        function safeString(value) {
            return (value !== undefined && value !== null) ? String(value) : 'N/A';
        }

        function safeNumber(value, defaultValue = 0) {
            return (value !== undefined && value !== null && !isNaN(value)) ? value : defaultValue;
        }
    </script>
</body>
</html>
