<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warhammer 40k 10th Edition Kampfsimulator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e6ed;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #ffd700;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #b8c6db;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            font-size: 14px;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(224, 230, 237, 0.6);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
        }

        .keywords-section {
            margin-top: 15px;
        }

        .keywords-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .keywords-input input {
            flex: 1;
        }

        .help-btn {
            background: linear-gradient(45deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            transform: scale(1.1);
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .keyword-tag {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .keyword-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .unit-list {
            margin-top: 20px;
        }

        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 1.1rem;
        }

        .unit-controls {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #667eea;
            padding: 10px;
            margin: 5px 0;
            border-radius: 0 5px 5px 0;
        }

        .results-panel {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-item {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 5px;
            padding: 15px;
        }

        .result-header {
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .stat-label {
            color: #b8c6db;
        }

        .stat-value {
            color: #e0e6ed;
            font-weight: 600;
        }

        .json-section {
            margin-top: 20px;
        }

        .json-textarea {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .simulation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .simulation-controls label {
            color: #b8c6db;
            font-weight: 600;
        }

        .simulation-controls input {
            width: 100px;
        }

        .keyword-reference {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .keyword-reference h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .keyword-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .keyword-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 3px;
            border-left: 3px solid #667eea;
        }

        .keyword-name {
            font-weight: bold;
            color: #ffd700;
        }

        .keyword-desc {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .chart-container {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .chart-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 100px;
            margin: 10px 0;
        }

        .bar {
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 2px 2px 0 0;
            min-width: 12px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -15px;
            font-size: 9px;
            color: #b8c6db;
        }

        .probability-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .wipeout-chance {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e6ed;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ffd700;
        }
            .main-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .container {
                padding: 10px;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .simulation-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .simulation-controls input {
                width: 100%;
            }
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 215, 0, 0.3);
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.5);
            color: #e74c3c;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .success {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.5);
            color: #2ecc71;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .chart-container {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .chart-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 100px;
            margin: 10px 0;
        }

        .bar {
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 2px 2px 0 0;
            min-width: 12px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -15px;
            font-size: 9px;
            color: #b8c6db;
        }

        .probability-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .wipeout-chance {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e6ed;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ffd700;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öîÔ∏è Warhammer 40k 10th Edition Kampfsimulator ‚öîÔ∏è</h1>
            <p>Simuliere K√§mpfe zwischen Angreifern und Verteidigern mit allen 10th Edition Regeln</p>
        </div>

        <div class="main-grid">
            <!-- Angreifer Panel -->
            <div class="panel">
                <h2>üó°Ô∏è Angreifer verwalten</h2>
                
                <div class="form-group">
                    <label>Name des Angreifers:</label>
                    <input type="text" id="attackerName" placeholder="z.B. Space Marine Squad">
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addAttacker()">Angreifer hinzuf√ºgen</button>
                    <button class="btn" onclick="showAttackerJson()">Als JSON anzeigen</button>
                </div>

                <div class="unit-list" id="attackersList"></div>
            </div>

            <!-- Verteidiger Panel -->
            <div class="panel">
                <h2>üõ°Ô∏è Verteidiger verwalten</h2>
                
                <div class="form-group">
                    <label>Name des Verteidigers:</label>
                    <input type="text" id="defenderName" placeholder="z.B. Ork Boyz">
                </div>

                <div class="form-group">
                    <label>Anzahl Modelle:</label>
                    <input type="number" id="defenderModels" value="10" min="1">
                </div>

                <div class="form-group">
                    <label>Toughness:</label>
                    <input type="number" id="defenderToughness" value="4" min="1" max="12">
                </div>

                <div class="form-group">
                    <label>Wounds pro Modell:</label>
                    <input type="number" id="defenderWounds" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>Save (Armor Save):</label>
                    <input type="number" id="defenderSave" value="6" min="2" max="7">
                </div>
                <div class="form-group">
                    <label>Invulnerable Save (leer lassen wenn nicht vorhanden):</label>
                    <input type="number" id="defenderInvul" min="2" max="6" placeholder="z.B. 5">
                </div>

                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="defenderKeywordInput" placeholder="Keyword eingeben">
                        <button class="btn btn-small" onclick="addDefenderKeyword()">+</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="defenderKeywords"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addDefender()">Verteidiger hinzuf√ºgen</button>
                    <button class="btn" onclick="showDefenderJson()">Als JSON anzeigen</button>
                </div>

                <div class="unit-list" id="defendersList"></div>
            </div>

            <!-- Waffen Panel -->
            <div class="panel">
                <h2>‚öîÔ∏è Waffe hinzuf√ºgen</h2>
                
                <div class="form-group">
                    <label>Angreifer ausw√§hlen:</label>
                    <select id="weaponAttackerSelect">
                        <option value="">Bitte Angreifer ausw√§hlen</option>
                    </select>
                </div>

                <div class="form-group">
                <label>Waffenname:</label>
                <input type="text" id="weaponName" placeholder="z.B. Bolter">
            </div>
            <div class="form-group">
                <label>Anzahl identischer Waffen (Amount):</label>
                <input type="number" id="weaponAmount" value="1" min="1" max="20">
                </div>

                <div class="form-group">
                    <label>Waffentyp:</label>
                    <select id="weaponType">
                        <option value="Ranged">Ranged</option>
                        <option value="Melee">Melee</option>
                        <option value="Psychic">Psychic</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Attacks (kann D6, 2D3+1, etc. sein):</label>
                    <input type="text" id="weaponAttacks" value="1" placeholder="z.B. 2D6+3">
                </div>

                <div class="form-group">
                    <label>To Hit (W√ºrfelwurf ben√∂tigt):</label>
                    <input type="number" id="weaponToHit" value="4" min="2" max="6">
                </div>

                <div class="form-group">
                    <label>Strength:</label>
                    <input type="number" id="weaponStrength" value="4" min="1" max="20">
                </div>

                <div class="form-group">
                    <label>AP (Armor Penetration):</label>
                    <input type="number" id="weaponAP" value="0" min="0" max="6">
                </div>

                <div class="form-group">
                    <label>Damage (kann D6, D3+1, etc. sein):</label>
                    <input type="text" id="weaponDamage" value="1" placeholder="z.B. D6+2">
                </div>

                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="weaponKeywordInput" placeholder="Keyword eingeben">
                        <button class="btn btn-small" onclick="addWeaponKeyword()">+</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="weaponKeywords"></div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addWeapon()">Waffe hinzuf√ºgen</button>
                    <button class="btn" onclick="clearWeaponForm()">Formular leeren</button>
                </div>
            </div>

            <!-- Simulation Panel -->
            <div class="panel">
                <h2>üéØ Simulation</h2>
                
                <div class="simulation-controls">
                    <label>Anzahl Simulationen:</label>
                    <input type="number" id="simulationAmount" value="1000" min="10" max="100000">
                    
                    <button class="btn btn-primary" onclick="runSimulation()">Simulation starten</button>
                </div>

                <div class="loading" id="loadingSpinner">
                    <div class="spinner"></div>
                    <p>Simulation l√§uft...</p>
                </div>

                <div class="button-group">
                    <button class="btn" onclick="exportResults()">Ergebnisse exportieren</button>
                    <button class="btn" onclick="showFullJson()">Vollst√§ndige JSON anzeigen</button>
                    <button class="btn btn-danger" onclick="clearAll()">Alles zur√ºcksetzen</button>
                </div>
            </div>

            <!-- JSON Import/Export Panel -->
            <div class="panel">
                <h2>üìÑ JSON Import/Export</h2>
                
                <div class="json-section">
                    <label>JSON-Konfiguration importieren:</label>
                    <textarea class="json-textarea" id="jsonImport" placeholder="F√ºgen Sie hier Ihre JSON-Konfiguration ein..."></textarea>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="importJson()">JSON importieren</button>
                    <button class="btn" onclick="loadExample()">Beispiel laden</button>
                </div>
            </div>
        </div>

        <!-- Ergebnisse Panel -->
        <div class="panel results-panel" id="resultsPanel" style="display: none;">
            <h2>üìä Simulationsergebnisse</h2>
            <div class="results-grid" id="resultsContainer"></div>
        </div>
    </div>

    <!-- Keyword Help Modal -->
    <div id="keywordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordHelp()">&times;</span>
            <h2>üìñ Keyword-Referenz</h2>
            <div class="keyword-reference">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-grid" id="modalStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-grid" id="modalCustomKeywords"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Dice } from './src/scripts/dice.js';
        import { Attacker, Defender, Weapon } from './src/scripts/units.js';
        import run from './src/scripts/w40k.js';

        // Globale Variablen
        window.attackers = [];
        window.defenders = [];
        window.simulationResults = [];
        window.currentWeaponKeywords = [];
        window.currentDefenderKeywords = [];

        // Keyword-Definitionen
        const standardKeywords = {
            'lethal hits': 'Critical hits automatisch verwunden (case-insensitive)',
            'sustained hits X': 'Critical hits erzeugen X zus√§tzliche Hits (X kann Zahl oder W√ºrfel sein, case-insensitive)',
            'devastating wounds': 'Critical wounds ignorieren alle Saves (case-insensitive)',
            'anti-KEYWORD X+': 'Gegen Units mit KEYWORD: Critical wounds bei X+ (z.B. "anti-vehicle 5" oder "anti-infantry 4+", case-insensitive)',
            'twin-linked': 'Reroll alle failed wound rolls (case-insensitive)',
            'rapid fire X': 'Bei Range ‚â§ H√§lfte: +X Attacks (case-insensitive)',
            'blast': '+1 Attack pro 5 Modelle im Ziel (1-4=+0, 5-9=+1, 10-14=+2, etc., case-insensitive)',
            'hazardous': 'Bei Critical Fails: 1 Mortal Wound (case-insensitive, implementiert)',
            'lance': 'Charge: +1 to wound, +1 AP (case-insensitive)',
            'precision': 'Critical hits k√∂nnen Charaktere zuweisen (case-insensitive, implementiert)',
            'torrent': 'Automatische Hits, keine Hit-W√ºrfe erforderlich (case-insensitive, implementiert)',
            'ignores cover': 'Umgeht Cover-Save Bonus des Ziels (case-insensitive, implementiert)',
            'indirect fire': '-1 to hit, maximal 4+ to hit (case-insensitive, implementiert)',
            'psychic': 'Kann durch Deny the Witch gestoppt werden (case-insensitive, implementiert)',
            'melta X': 'Bei Range ‚â§ H√§lfte: +X Damage (case-insensitive)',
            '+1 to hit': 'Verbessert Hit-W√ºrfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to hit': 'Verschlechtert Hit-W√ºrfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)',
            '+1 to wound': 'Verbessert Wound-W√ºrfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to wound': 'Verschlechtert Wound-W√ºrfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)'
        };

        const customKeywords = {
            'RH1': 'Reroll 1s beim Hit-Wurf',
            'RW1': 'Reroll 1s beim Wound-Wurf',
            'RHMiss': 'Reroll alle fehlgeschlagenen Hit-W√ºrfe',
            'RWMiss': 'Reroll alle fehlgeschlagenen Wound-W√ºrfe',
            'RHNoCrit': 'Reroll 1s beim Hit-Wurf wenn kein Critical Hit',
            'RWNoCrit': 'Reroll 1s beim Wound-Wurf wenn kein Critical Wound',
            'CritHitX': 'Critical Hits bei X+ statt 6+ (z.B. CritHit5+)',
            'CritWoundX': 'Critical Wounds bei X+ statt 6+ (z.B. CritWound4+)',
            '+1D': 'Erh√∂ht ausgehenden Schaden um 1 (case-insensitive)',
            '-1D': 'Reduziert eingehenden Schaden um 1 (minimum 1, case-insensitive)',
            '/2D': 'Halbiert eingehenden Schaden (minimum 1, abgerundet, case-insensitive)',
            'feel no pain X': 'Ignoriert Schaden bei X+ auf 1W6 (z.B. "feel no pain 6", case-insensitive)',
            'feel no pain psychic X': 'Ignoriert Psychic Schaden bei X+ auf 1W6 (case-insensitive)',
            'cover': '+1 Save (au√üer gegen "ignores cover" Weapons, case-insensitive)'
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            populateKeywordModal();
            updateAttackerSelect();
        });

        // Keyword Modal Functions
        window.showKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'block';
        };

        window.closeKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'none';
        };

        // Click outside modal to close
        window.onclick = function(event) {
            const modal = document.getElementById('keywordModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };

        // Keyword-Referenz im Modal anzeigen
        function populateKeywordModal() {
            const standardContainer = document.getElementById('modalStandardKeywords');
            const customContainer = document.getElementById('modalCustomKeywords');

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        // Angreifer hinzuf√ºgen
        window.addAttacker = function() {
            const name = document.getElementById('attackerName').value.trim();
            if (!name) {
                showError('Bitte geben Sie einen Namen f√ºr den Angreifer ein.');
                return;
            }

            const attacker = {
                Name: name,
                Weapons: []
            };

            window.attackers.push(attacker);
            document.getElementById('attackerName').value = '';
            updateAttackersList();
            updateAttackerSelect();
            showSuccess(`Angreifer "${name}" wurde hinzugef√ºgt.`);
        };

        // Verteidiger hinzuf√ºgen
        window.addDefender = function() {
            const name = document.getElementById('defenderName').value.trim();
            const models = parseInt(document.getElementById('defenderModels').value);
            const toughness = parseInt(document.getElementById('defenderToughness').value);
            const wounds = parseInt(document.getElementById('defenderWounds').value);
            const save = parseInt(document.getElementById('defenderSave').value);
            const invul = document.getElementById('defenderInvul').value;

            if (!name) {
                showError('Bitte geben Sie einen Namen f√ºr den Verteidiger ein.');
                return;
            }

            const defender = {
                Name: name,
                type: 'Infantry',
                models: models,
                toughness: toughness,
                wounds: wounds,
                save: save,
                invulnerable: invul ? parseInt(invul) : 7,
                Keywords: [...window.currentDefenderKeywords]
            };

            window.defenders.push(defender);
            clearDefenderForm();
            updateDefendersList();
            showSuccess(`Verteidiger "${name}" wurde hinzugef√ºgt.`);
        };

        // Waffe hinzuf√ºgen
        window.addWeapon = function() {
            const attackerIndex = parseInt(document.getElementById('weaponAttackerSelect').value);
            const name = document.getElementById('weaponName').value.trim();
            const type = document.getElementById('weaponType').value;
            const attacks = document.getElementById('weaponAttacks').value.trim();
            const toHit = parseInt(document.getElementById('weaponToHit').value);
            const strength = parseInt(document.getElementById('weaponStrength').value);
            const ap = parseInt(document.getElementById('weaponAP').value);
            const damage = document.getElementById('weaponDamage').value.trim();
            const amount = parseInt(document.getElementById('weaponAmount').value) || 1;

            if (isNaN(attackerIndex)) {
                showError('Bitte w√§hlen Sie einen Angreifer aus.');
                return;
            }

            if (!name) {
                showError('Bitte geben Sie einen Namen f√ºr die Waffe ein.');
                return;
            }

            const weapon = {
                name: name,
                type: type,
                attacks: attacks,
                to_hit: toHit,
                strength: strength,
                ap: ap,
                damage: damage,
                amount: amount,
                Keywords: [...window.currentWeaponKeywords]
            };

            window.attackers[attackerIndex].Weapons.push(weapon);
            clearWeaponForm();
            updateAttackersList();
            showSuccess(`Waffe "${name}" wurde zu ${window.attackers[attackerIndex].Name} hinzugef√ºgt.`);
        };

        // Keyword-Funktionen
        window.addWeaponKeyword = function() {
            const input = document.getElementById('weaponKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentWeaponKeywords.includes(keyword)) {
                window.currentWeaponKeywords.push(keyword);
                input.value = '';
                updateWeaponKeywordsDisplay();
            }
        };

        window.addDefenderKeyword = function() {
            const input = document.getElementById('defenderKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentDefenderKeywords.includes(keyword)) {
                window.currentDefenderKeywords.push(keyword);
                input.value = '';
                updateDefenderKeywordsDisplay();
            }
        };

        function updateWeaponKeywordsDisplay() {
            const container = document.getElementById('weaponKeywords');
            container.innerHTML = '';
            window.currentWeaponKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeWeaponKeyword(${index})">√ó</span>
                `;
                container.appendChild(tag);
            });
        }

        function updateDefenderKeywordsDisplay() {
            const container = document.getElementById('defenderKeywords');
            container.innerHTML = '';
            window.currentDefenderKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeDefenderKeyword(${index})">√ó</span>
                `;
                container.appendChild(tag);
            });
        }

        window.removeWeaponKeyword = function(index) {
            window.currentWeaponKeywords.splice(index, 1);
            updateWeaponKeywordsDisplay();
        };

        window.removeDefenderKeyword = function(index) {
            window.currentDefenderKeywords.splice(index, 1);
            updateDefenderKeywordsDisplay();
        };

        // Listen aktualisieren
        function updateAttackersList() {
            const container = document.getElementById('attackersList');
            container.innerHTML = '';

            window.attackers.forEach((attacker, index) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${attacker.Name}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small btn-danger" onclick="removeAttacker(${index})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Waffen (${attacker.Weapons.length}):</strong>
                        ${attacker.Weapons.map((weapon, wIndex) => `
                            <div class="weapon-item">
                                <strong>${weapon.name}</strong> (${weapon.type})<br>
                                A: ${weapon.attacks} | Hit: ${weapon.to_hit}+ | S: ${weapon.strength} | AP: -${weapon.ap} | D: ${weapon.damage}<br>
                                Keywords: ${weapon.Keywords.join(', ') || 'Keine'}
                                <button class="btn btn-small btn-danger" onclick="removeWeapon(${index}, ${wIndex})" style="float: right; margin-top: 5px;">Waffe entfernen</button>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateDefendersList() {
            const container = document.getElementById('defendersList');
            container.innerHTML = '';

            window.defenders.forEach((defender, index) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${defender.Name}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small btn-danger" onclick="removeDefender(${index})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        Models: ${defender.models} | T: ${defender.toughness} | W: ${defender.wounds} | 
                        Save: ${defender.save}+ | Inv: ${defender.invulnerable < 7 ? defender.invulnerable + '+' : 'Keine'}<br>
                        Keywords: ${defender.Keywords.join(', ') || 'Keine'}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateAttackerSelect() {
            const select = document.getElementById('weaponAttackerSelect');
            select.innerHTML = '<option value="">Bitte Angreifer ausw√§hlen</option>';
            window.attackers.forEach((attacker, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = attacker.Name;
                select.appendChild(option);
            });
        }

        // Entfernen-Funktionen
        window.removeAttacker = function(index) {
            window.attackers.splice(index, 1);
            updateAttackersList();
            updateAttackerSelect();
        };

        window.removeDefender = function(index) {
            window.defenders.splice(index, 1);
            updateDefendersList();
        };

        window.removeWeapon = function(attackerIndex, weaponIndex) {
            window.attackers[attackerIndex].Weapons.splice(weaponIndex, 1);
            updateAttackersList();
        };

        // Formular-Funktionen
        function clearDefenderForm() {
            document.getElementById('defenderName').value = '';
            document.getElementById('defenderModels').value = '10';
            document.getElementById('defenderToughness').value = '4';
            document.getElementById('defenderWounds').value = '1';
            document.getElementById('defenderSave').value = '6';
            document.getElementById('defenderInvul').value = '';
            window.currentDefenderKeywords = [];
            updateDefenderKeywordsDisplay();
        }

        window.clearWeaponForm = function() {
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponType').value = 'Ranged';
            document.getElementById('weaponAttacks').value = '1';
            document.getElementById('weaponToHit').value = '4';
            document.getElementById('weaponStrength').value = '4';
            document.getElementById('weaponAP').value = '0';
            document.getElementById('weaponDamage').value = '1';
            document.getElementById('weaponAmount').value = '1';
            window.currentWeaponKeywords = [];
            updateWeaponKeywordsDisplay();
        };

        // Simulation
        window.runSimulation = function() {
            if (window.attackers.length === 0) {
                showError('Bitte f√ºgen Sie mindestens einen Angreifer hinzu.');
                return;
            }

            if (window.defenders.length === 0) {
                showError('Bitte f√ºgen Sie mindestens einen Verteidiger hinzu.');
                return;
            }

            // Pr√ºfen ob alle Angreifer Waffen haben
            const attackersWithoutWeapons = window.attackers.filter(a => a.Weapons.length === 0);
            if (attackersWithoutWeapons.length > 0) {
                showError(`Die folgenden Angreifer haben keine Waffen: ${attackersWithoutWeapons.map(a => a.Name).join(', ')}`);
                return;
            }

            const amount = parseInt(document.getElementById('simulationAmount').value);
            
            // Loading anzeigen
            document.getElementById('loadingSpinner').classList.add('active');

            // Simulation in n√§chstem Frame starten (f√ºr Loading-Animation)
            setTimeout(() => {
                try {
                    const simulationData = {
                        Amount: amount,
                        Attackers: window.attackers,
                        Defenders: window.defenders
                    };

                    window.simulationResults = run(simulationData);
                    displayResults();
                    document.getElementById('resultsPanel').style.display = 'block';
                    
                    // Zu Ergebnissen scrollen
                    document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
                    
                    showSuccess('Simulation erfolgreich abgeschlossen!');
                } catch (error) {
                    console.error('Simulation Error:', error);
                    showError('Fehler bei der Simulation: ' + error.message);
                } finally {
                    document.getElementById('loadingSpinner').classList.remove('active');
                }
            }, 100);
        };

        // Ergebnisse anzeigen
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            window.simulationResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                
                let content = `<div class="result-header">üó°Ô∏è ${result.Name}</div>`;
                
                result.Target.forEach(target => {
                    content += `
                        <div style="margin-bottom: 15px; border-left: 3px solid #667eea; padding-left: 10px;">
                            <div class="result-header" style="font-size: 1rem; margin-bottom: 8px;">
                                üõ°Ô∏è vs ${target.Name}
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">${target.MaximumModels === 1 ? 'Durchschnittsschaden:' : 'Vernichtete Modelle:'}</span>
                                <span class="stat-value">${target.MaximumModels === 1 ? 
                                    target.TotalDamage.toFixed(2) + ' / ' + target.MaxWounds + ' Wounds' :
                                    target.ModelsDestroyed.toFixed(2) + ' / ' + target.MaximumModels}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-label">${target.MaximumModels === 1 ? 'Lebensenergie verloren:' : 'Vernichtungsrate:'}</span>
                                <span class="stat-value">${target.MaximumModels === 1 ? 
                                    ((target.TotalDamage / target.MaxWounds) * 100).toFixed(1) + '%' :
                                    ((target.ModelsDestroyed / target.MaximumModels) * 100).toFixed(1) + '%'}</span>
                            </div>
                            
                            <div class="stat-row">
                                <span class="stat-label">${target.MaximumModels === 1 ? 'Komplette Vernichtung:' : 'Komplette Vernichtung:'}</span>
                                <span class="stat-value">${target.CompleteWipeoutChance.toFixed(1)}%</span>
                            </div>
                            
                            ${target.KillDistribution ? createKillDistributionChart(target) : ''}
                            
                            <div style="margin-top: 10px;">
                                <strong>Waffen-Details:</strong>
                                ${target.Weapons.map(weapon => `
                                    <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                                        <strong>${weapon.Name}:</strong><br>
                                        <div class="stat-row">
                                            <span class="stat-label">Durchschn. Treffer:</span>
                                            <span class="stat-value">${weapon.Hits.toFixed(2)}</span>
                                        </div>
                                        <div class="stat-row">
                                            <span class="stat-label">Durchschn. Verwundungen:</span>
                                            <span class="stat-value">${weapon.Wounds.toFixed(2)}</span>
                                        </div>
                                        <div class="stat-row">
                                            <span class="stat-label">Fehlgeschlagene Saves:</span>
                                            <span class="stat-value">${weapon.FailedSaves.toFixed(2)}</span>
                                        </div>
                                        <div class="stat-row">
                                            <span class="stat-label">Durchschn. Schaden:</span>
                                            <span class="stat-value">${weapon.AverageDamage.toFixed(2)}</span>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                resultDiv.innerHTML = content;
                container.appendChild(resultDiv);
            });
        }

        // Schadenverteilungs-Diagramm erstellen
        function createKillDistributionChart(target) {
            if (!target.KillDistribution || target.KillDistribution.length === 0) return '';
            
            const significantData = target.KillDistribution.filter(d => d.probability > 0.1); // Nur Werte > 0.1% anzeigen
            const maxProbability = Math.max(...significantData.map(d => d.probability));
            const isSingleModel = target.MaximumModels === 1;
            
            let chartHtml = `
                <div class="chart-container">
                    <div class="chart-title">${isSingleModel ? 'Schadenverteilung (Wounds)' : 'Schadenverteilung (Vernichtete Modelle)'}</div>
                    <div class="bar-chart">
            `;
            
            significantData.forEach(data => {
                const height = Math.max(5, (data.probability / maxProbability) * 90); // Min 5px H√∂he
                const label = isSingleModel ? `${data.kills}W` : `${data.kills}M`;
                chartHtml += `
                    <div class="bar" style="height: ${height}px;" title="${data.label}: ${data.probability.toFixed(1)}%">
                        <span class="bar-label">${label}</span>
                    </div>
                `;
            });
            
            chartHtml += `
                    </div>
                    <div class="probability-text">
                        ${isSingleModel ? 'W = Wounds verursacht' : 'M = Vernichtete Modelle'} | Y-Achse: Wahrscheinlichkeit
                    </div>
                </div>
            `;
            
            return chartHtml;
        }

        // JSON-Funktionen
        window.showAttackerJson = function() {
            const json = JSON.stringify(window.attackers, null, 2);
            alert('Angreifer JSON:\n\n' + json);
        };

        window.showDefenderJson = function() {
            const json = JSON.stringify(window.defenders, null, 2);
            alert('Verteidiger JSON:\n\n' + json);
        };

        window.showFullJson = function() {
            const fullData = {
                Amount: parseInt(document.getElementById('simulationAmount').value),
                Attackers: window.attackers,
                Defenders: window.defenders
            };
            const json = JSON.stringify(fullData, null, 2);
            document.getElementById('jsonImport').value = json;
        };

        window.importJson = function() {
            const jsonText = document.getElementById('jsonImport').value.trim();
            if (!jsonText) {
                showError('Bitte geben Sie JSON-Daten ein.');
                return;
            }

            try {
                const data = JSON.parse(jsonText);
                
                if (data.Attackers) {
                    window.attackers = data.Attackers;
                    updateAttackersList();
                    updateAttackerSelect();
                }
                
                if (data.Defenders) {
                    window.defenders = data.Defenders;
                    updateDefendersList();
                }
                
                if (data.Amount) {
                    document.getElementById('simulationAmount').value = data.Amount;
                }
                
                showSuccess('JSON-Daten erfolgreich importiert!');
            } catch (error) {
                showError('Fehler beim Parsen der JSON-Daten: ' + error.message);
            }
        };

        window.loadExample = function() {
            const exampleData = {
                "Amount": 1000,
                "Attackers": [
                    {
                        "Name": "Space Marine Tactical Squad",
                        "Weapons": [
                            {
                                "name": "Bolter",
                                "type": "Ranged",
                                "attacks": "2",
                                "to_hit": 3,
                                "strength": 4,
                                "ap": 0,
                                "damage": "1",
                                "amount": 1,
                                "Keywords": ["rapid fire 1"]
                            },
                            {
                                "name": "Chainsword",
                                "type": "Melee",
                                "attacks": "3",
                                "to_hit": 3,
                                "strength": 4,
                                "ap": 0,
                                "damage": "1",
                                "amount": 1,
                                "Keywords": []
                            }
                        ]
                    }
                ],
                "Defenders": [
                    {
                        "Name": "Ork Boyz",
                        "type": "Infantry",
                        "models": 10,
                        "toughness": 5,
                        "wounds": 1,
                        "save": 6,
                        "invulnerable": 7,
                        "Keywords": []
                    },
                    {
                        "Name": "Chaos Space Marines",
                        "type": "Infantry",
                        "models": 5,
                        "toughness": 4,
                        "wounds": 2,
                        "save": 3,
                        "invulnerable": 7,
                        "Keywords": []
                    }
                ]
            };

            document.getElementById('jsonImport').value = JSON.stringify(exampleData, null, 2);
            showSuccess('Beispiel-Daten geladen! Klicken Sie auf "JSON importieren" um sie zu verwenden.');
        };

        // Export-Funktionen
        window.exportResults = function() {
            if (window.simulationResults.length === 0) {
                showError('Keine Simulationsergebnisse zum Exportieren vorhanden.');
                return;
            }

            const dataStr = JSON.stringify(window.simulationResults, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'warhammer40k_simulation_results.json';
            link.click();
            URL.revokeObjectURL(url);
            
            showSuccess('Ergebnisse erfolgreich exportiert!');
        };

        // Utility-Funktionen
        window.clearAll = function() {
            if (confirm('M√∂chten Sie wirklich alle Daten zur√ºcksetzen?')) {
                window.attackers = [];
                window.defenders = [];
                window.simulationResults = [];
                window.currentWeaponKeywords = [];
                window.currentDefenderKeywords = [];
                
                updateAttackersList();
                updateDefendersList();
                updateAttackerSelect();
                updateWeaponKeywordsDisplay();
                updateDefenderKeywordsDisplay();
                
                document.getElementById('jsonImport').value = '';
                document.getElementById('resultsPanel').style.display = 'none';
                
                showSuccess('Alle Daten wurden zur√ºckgesetzt.');
            }
        };

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // Enter-Taste f√ºr Keyword-Eingaben
        document.getElementById('weaponKeywordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.addWeaponKeyword();
            }
        });

        document.getElementById('defenderKeywordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                window.addDefenderKeyword();
            }
        });
    </script>
</body>
</html>
