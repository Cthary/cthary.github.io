<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warhammer 40k 10th Edition Kampfsimulator</title>
    <meta name="description" content="Professioneller Kampfsimulator für Warhammer 40k 10th Edition mit allen Regeln und statistischen Analysen">
    
    <!-- Google Fonts für bessere Typografie -->
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;500;600;700&family=Orbitron:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!-- jsPDF für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        :root {
            /* Design-System: Farbschema - Warhammer 40k inspiriert */
            --primary-bg: #0a0a0f;
            --secondary-bg: #1a1a28;
            --accent-bg: #2a2a3e;
            --card-bg: rgba(42, 42, 62, 0.8);
            --panel-bg: rgba(26, 26, 40, 0.95);
            --input-bg: rgba(42, 42, 62, 0.6);
            
            --primary-gold: #d4af37;
            --secondary-gold: #f4d03f;
            --accent-gold: #fff200;
            
            --primary-red: #8b0000;
            --secondary-red: #dc143c;
            --accent-red: #ff4757;
            
            --primary-blue: #1e3a8a;
            --secondary-blue: #3b82f6;
            --accent-blue: #60a5fa;
            
            --success-green: #10b981;
            --warning-orange: #f59e0b;
            --error-color: #ef4444;
            --error-red: #ef4444;
            --success-color: #10b981;
            
            --text-primary: #ffffff;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --text-accent: var(--primary-gold);
            
            --border-color: rgba(212, 175, 55, 0.3);
            --border-accent: rgba(212, 175, 55, 0.6);
            --border-focus: rgba(212, 175, 55, 0.8);
            --focus-color: rgba(212, 175, 55, 0.8);
            
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.25);
            --shadow-xl: 0 16px 48px rgba(0, 0, 0, 0.4);
            --shadow-focus: 0 0 0 3px rgba(212, 175, 55, 0.2);
            
            --radius-sm: 6px;
            --radius-md: 12px;
            --radius-lg: 18px;
            --radius-xl: 24px;
            --radius-full: 9999px;
            
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-fast: all 0.15s ease-out;
            --transition-medium: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* Spacing-System */
            --space-xs: 4px;
            --space-sm: 8px;
            --space-md: 16px;
            --space-lg: 24px;
            --space-xl: 32px;
            --space-2xl: 48px;
            
            /* Typography-System */
            --font-size-xs: 0.75rem;
            --font-size-sm: 0.875rem;
            --font-size-base: 1rem;
            --font-size-lg: 1.125rem;
            --font-size-xl: 1.25rem;
            --font-size-2xl: 1.5rem;
            --font-size-3xl: 1.875rem;
            --font-size-4xl: 2.25rem;
            
            /* Animation Curves für bessere UX */
            --ease-out-quart: cubic-bezier(0.25, 1, 0.5, 1);
            --ease-in-out-quart: cubic-bezier(0.76, 0, 0.24, 1);
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Enhanced Base Styles with Performance Optimizations */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        *:focus {
            outline: 2px solid var(--focus-color);
            outline-offset: 2px;
        }

        /* Remove outline for mouse users, keep for keyboard users */
        *:focus:not(:focus-visible) {
            outline: none;
        }

        *:focus-visible {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px; /* Base font size for rem calculations */
        }

        body {
            font-family: 'Exo 2', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, var(--secondary-bg) 50%, var(--accent-bg) 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow-x: hidden;
            font-display: swap; /* Improve font loading performance */
        }

        /* Remove animations for users who prefer reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* High contrast mode support for accessibility */
        @media (prefers-contrast: high) {
            :root {
                --border-color: rgba(255, 255, 255, 0.8);
                --border-accent: rgba(255, 255, 255, 1);
                --text-muted: rgba(255, 255, 255, 0.9);
                --input-bg: rgba(0, 0, 0, 0.8);
            }
        }

        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-bg: #000000;
                --secondary-bg: #111111;
                --panel-bg: rgba(17, 17, 17, 0.95);
            }
        }

        /* Accessibility Components */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--primary-gold);
            color: var(--primary-bg);
            padding: var(--space-sm) var(--space-md);
            text-decoration: none;
            font-weight: 600;
            border-radius: var(--radius-md);
            z-index: 10000;
            transition: var(--transition-fast);
            border: 2px solid var(--primary-gold);
        }

        .skip-link:focus {
            top: 6px;
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
        }

        .skip-link:hover {
            background: var(--secondary-gold);
            border-color: var(--secondary-gold);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        /* Screen Reader Only Content */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        /* Live Region for Dynamic Content Announcements */
        .live-region {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Custom Properties for Better Scrollbars */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: var(--radius-sm);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
            border-radius: var(--radius-sm);
            border: 2px solid var(--secondary-bg);
            transition: var(--transition-fast);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--secondary-gold), var(--accent-gold));
        }

        ::-webkit-scrollbar-thumb:active {
            background: var(--accent-gold);
        }

        /* Container System */
        .container {
            max-width: 1400px;
            width: 100%;
            margin: 0 auto;
            padding: var(--space-lg);
            box-sizing: border-box;
        }

        @container (max-width: 768px) {
            .container {
                padding: var(--space-md);
            }
        }

        /* Enhanced Header Design System */
        .site-header {
            text-align: center;
            margin-bottom: var(--space-2xl);
            padding: var(--space-2xl) var(--space-xl);
            background: var(--panel-bg);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
            transition: var(--transition-medium);
        }

        .site-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold), var(--primary-gold));
            animation: shimmer 3s infinite;
        }

        .site-header:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-accent);
        }

        @keyframes shimmer {
            0%, 100% { 
                opacity: 0.8; 
                background-position: 0% 50%;
            }
            50% { 
                opacity: 1; 
                background-position: 100% 50%;
            }
        }

        .site-title {
            font-family: 'Orbitron', monospace;
            color: var(--text-accent);
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: var(--space-md);
            text-shadow: 
                0 0 20px rgba(212, 175, 55, 0.5),
                0 0 40px rgba(212, 175, 55, 0.3),
                2px 2px 8px rgba(0, 0, 0, 0.8);
            letter-spacing: 2px;
            line-height: 1.2;
            background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold), var(--accent-gold));
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: gradientShift 4s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .site-description {
            font-size: var(--font-size-lg);
            color: var(--text-secondary);
            opacity: 0.9;
            font-weight: 300;
            max-width: 600px;
            margin: 0 auto var(--space-md);
            line-height: 1.5;
        }

        .version-badge {
            display: inline-block;
            background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            padding: var(--space-sm) var(--space-md);
            border-radius: var(--radius-lg);
            font-size: var(--font-size-sm);
            font-weight: 600;
            box-shadow: var(--shadow-md);
            border: 2px solid transparent;
            transition: var(--transition-fast);
        }

        .version-badge:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-gold);
        }

        /* Enhanced Panel System - Atomic Design Principles */
        .panel {
            background: var(--panel-bg);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            transition: var(--transition-medium);
            position: relative;
            overflow: hidden;
            container-type: inline-size;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, var(--primary-gold), transparent);
            opacity: 0.6;
            transition: var(--transition-fast);
        }

        .panel:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-accent);
        }

        .panel:hover::before {
            opacity: 1;
        }

        .panel:focus-within {
            outline: 2px solid var(--focus-color);
            outline-offset: 2px;
        }

        .panel h2 {
            font-family: 'Orbitron', monospace;
            color: var(--text-accent);
            margin-bottom: var(--space-lg);
            font-size: var(--font-size-xl);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: var(--space-md);
            padding-bottom: var(--space-md);
            border-bottom: 2px solid var(--border-color);
        }

        .panel h2 .material-icons {
            font-size: 1.4rem;
            color: var(--primary-gold);
        }

        /* Main Layout System - Mobile-First Approach */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
        }

        @media (min-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-grid {
                gap: var(--space-lg);
            }
        }

        /* Enhanced Button System - Atomic Design */
        .btn {
            /* Base button styles */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-md) var(--space-lg);
            border: 2px solid transparent;
            border-radius: var(--radius-md);
            font-family: inherit;
            font-size: var(--font-size-base);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: var(--transition-fast);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            user-select: none;
            min-height: 44px; /* WCAG touch target minimum */
            
            /* Prevent double-tap zoom on iOS */
            touch-action: manipulation;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s var(--ease-out-expo);
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:focus-visible {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
        }

        .btn:disabled,
        .btn[aria-disabled="true"] {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        /* Button Variants */
        .btn-primary {
            background: linear-gradient(45deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            border-color: var(--primary-gold);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:hover:not(:disabled):not([aria-disabled="true"]) {
            background: linear-gradient(45deg, var(--secondary-gold), var(--accent-gold));
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary {
            background: var(--secondary-bg);
            color: var(--text-primary);
            border-color: var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .btn-secondary:hover:not(:disabled):not([aria-disabled="true"]) {
            background: var(--panel-bg);
            border-color: var(--border-accent);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-danger {
            background: linear-gradient(45deg, var(--error-color), #dc2626);
            color: white;
            border-color: var(--error-color);
            box-shadow: var(--shadow-md);
        }

        .btn-danger:hover:not(:disabled):not([aria-disabled="true"]) {
            background: linear-gradient(45deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-outline {
            background: transparent;
            color: var(--text-accent);
            border-color: var(--border-accent);
        }

        .btn-outline:hover:not(:disabled):not([aria-disabled="true"]) {
            background: var(--primary-gold);
            color: var(--primary-bg);
            border-color: var(--primary-gold);
        }

        /* Button Sizes */
        .btn-small {
            padding: var(--space-sm) var(--space-md);
            font-size: var(--font-size-sm);
            min-height: 36px;
        }

        .btn-large {
            padding: var(--space-lg) var(--space-2xl);
            font-size: var(--font-size-lg);
            min-height: 52px;
        }

        .btn-icon {
            padding: var(--space-sm);
            min-width: 44px;
            border-radius: var(--radius-full);
        }

        /* Button Groups */
        .button-group {
            display: flex;
            gap: var(--space-md);
            margin-top: var(--space-lg);
            flex-wrap: wrap;
        }

        .button-group .btn {
            flex: 1;
            min-width: 140px;
        }

        @media (max-width: 480px) {
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
            }
        }

        /* Collapsible Components - Enhanced Interaction */
        .collapsible-btn {
            background: linear-gradient(135deg, var(--card-bg), var(--accent-bg));
            color: var(--text-primary);
            cursor: pointer;
            padding: var(--space-lg) var(--space-xl);
            width: 100%;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            text-align: left;
            font-size: var(--font-size-base);
            font-weight: 600;
            margin: var(--space-md) 0;
            transition: var(--transition-medium);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow-sm);
        }

        .collapsible-btn:focus-visible {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
        }

        .collapsible-btn:hover {
            background: linear-gradient(135deg, var(--accent-bg), var(--card-bg));
            border-color: var(--border-accent);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .collapsible-btn.active {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            border-color: var(--accent-gold);
            box-shadow: var(--shadow-lg);
        }

        .toggle-icon {
            transition: transform var(--transition-medium) var(--ease-out-quart);
            font-size: 1.2rem;
            font-weight: bold;
        }

        .collapsible-btn.active .toggle-icon {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s var(--ease-out-quart);
            background: var(--card-bg);
            border-radius: 0 0 var(--radius-md) var(--radius-md);
            border: 2px solid var(--border-color);
            border-top: none;
        }

        .collapsible-content.active {
            padding: var(--space-xl);
            max-height: 2000px; /* Large enough value for content */
        }

        /* Enhanced Form System */
        .form-group {
            margin-bottom: var(--space-lg);
            position: relative;
        }

        .form-group label {
            display: block;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: var(--space-sm);
            font-size: var(--font-size-base);
        }

        .form-group label.required::after {
            content: ' *';
            color: var(--error-color);
            font-weight: bold;
        }

        .form-control {
            width: 100%;
            padding: var(--space-md) var(--space-lg);
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: var(--transition-fast);
            backdrop-filter: blur(10px);
            box-sizing: border-box;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background: var(--secondary-bg);
        }

        .form-control:hover:not(:focus) {
            border-color: var(--border-accent);
        }

        .form-control::placeholder {
            color: var(--text-muted);
            opacity: 0.8;
        }

        .form-control:invalid {
            border-color: var(--error-color);
        }

        .form-control:invalid:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        /* Select Enhancement */
        select.form-control {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23D4AF37' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right var(--space-md) center;
            background-size: 20px;
            padding-right: 48px;
        }

        select.form-control option {
            background: var(--secondary-bg);
            color: var(--text-primary);
            padding: var(--space-sm);
        }

        /* Form Help Text */
        .form-help {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            margin-top: var(--space-xs);
            line-height: 1.4;
        }

        .form-error {
            font-size: var(--font-size-sm);
            color: var(--error-color);
            margin-top: var(--space-xs);
            display: flex;
            align-items: center;
            gap: var(--space-xs);
        }
        .card {
            background: var(--panel-bg);
            border-radius: var(--radius-xl);
            backdrop-filter: blur(20px);
            border: 2px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            transition: var(--transition-medium);
            position: relative;
            overflow: hidden;
            padding: var(--space-xl);
            margin-bottom: var(--space-lg);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold));
            opacity: 0;
            transition: var(--transition-medium);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
            border-color: var(--border-accent);
        }

        .card:hover::before {
            opacity: 1;
        }

        .card:focus-within {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
            border-color: var(--focus-color);
        }

        .card-header {
            padding: var(--space-lg) var(--space-xl);
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, 
                rgba(212, 175, 55, 0.1) 0%, 
                rgba(184, 134, 11, 0.05) 100%);
            margin: calc(-1 * var(--space-xl)) calc(-1 * var(--space-xl)) var(--space-lg) calc(-1 * var(--space-xl));
        }

        .card-title {
            font-family: 'Orbitron', monospace;
            color: var(--text-accent);
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0;
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .card-body {
            padding: 0;
        }

        .card-footer {
            padding: var(--space-lg) var(--space-xl);
            border-top: 1px solid var(--border-color);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: var(--space-md);
            margin: var(--space-lg) calc(-1 * var(--space-xl)) calc(-1 * var(--space-xl)) calc(-1 * var(--space-xl));
        }

        /* Enhanced Form Design */
        .form-group {
            margin-bottom: var(--space-lg);
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            font-size: var(--font-size-base);
        }

        .form-label.required::after {
            content: ' *';
            color: var(--error-color);
            font-weight: bold;
        }

        .form-input {
            width: 100%;
            padding: var(--space-md);
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: var(--transition-fast);
            box-sizing: border-box;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background: var(--secondary-bg);
        }

        .form-input:hover:not(:focus) {
            border-color: var(--border-accent);
        }

        .form-input:invalid {
            border-color: var(--error-color);
        }

        .form-input:invalid:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }

        .form-select {
            width: 100%;
            padding: var(--space-md);
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: var(--transition-fast);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23D4AF37' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right var(--space-md) center;
            background-size: 20px;
            padding-right: 48px;
        }

        .form-select:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background-color: var(--secondary-bg);
        }

        /* Improved Weapon and Defender Cards */
        /* Improved Weapon and Defender Cards */
        .weapon-card,
        .defender-card {
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-md);
            transition: var(--transition-medium);
            position: relative;
            box-shadow: var(--shadow-sm);
        }

        .weapon-card:hover,
        .defender-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            border-color: var(--border-accent);
        }

        .weapon-card:focus-within,
        .defender-card:focus-within {
            outline: 2px solid var(--focus-color);
            outline-offset: 2px;
        }

        .weapon-card h3,
        .weapon-card h4,
        .weapon-card h5,
        .defender-card h3,
        .defender-card h4,
        .defender-card h5 {
            color: var(--text-accent);
            font-family: 'Orbitron', monospace;
            margin-top: 0;
            margin-bottom: var(--space-md);
            font-weight: 600;
        }

        .weapon-card h3,
        .defender-card h3 {
            font-size: var(--font-size-lg);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: var(--space-sm);
        }

        /* Grid Layout System */
        .grid {
            display: grid;
            gap: var(--space-lg);
        }

        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        .grid-3 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }

        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        /* Main Layout */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
            margin-bottom: var(--space-2xl);
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
            }
        }

        /* Input Styling */
        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: var(--space-md);
            background: var(--input-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: var(--font-size-base);
            font-family: inherit;
            transition: var(--transition-fast);
            box-sizing: border-box;
        }

        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: var(--focus-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2);
            background: var(--secondary-bg);
        }

        input[type="number"]:hover:not(:focus),
        input[type="text"]:hover:not(:focus),
        select:hover:not(:focus) {
            border-color: var(--border-accent);
        }

        /* Enhanced Labels */
        label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            font-size: var(--font-size-base);
        }

        /* Keyword Tags Enhancement */
        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: var(--space-xs);
            padding: var(--space-xs) var(--space-sm);
            background: rgba(212, 175, 55, 0.2);
            color: var(--text-accent);
            border-radius: var(--radius-md);
            border: 1px solid rgba(212, 175, 55, 0.3);
            font-size: var(--font-size-sm);
            font-weight: 500;
            margin: var(--space-xs);
            transition: var(--transition-fast);
            white-space: nowrap;
        }

        .keyword-tag:hover {
            background: rgba(212, 175, 55, 0.3);
            border-color: var(--border-accent);
            transform: translateY(-1px);
        }

        .keyword-tag[data-type="damage"] {
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .keyword-tag[data-type="special"] {
            background: rgba(168, 85, 247, 0.2);
            color: #c4b5fd;
            border-color: rgba(168, 85, 247, 0.3);
        }

        .keyword-tag[data-type="accuracy"] {
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            border-color: rgba(34, 197, 94, 0.3);
        }

        /* Form Enhancement */
        .form-help {
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            margin-top: var(--space-xs);
            line-height: 1.4;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }

        .form-checkbox {
            width: auto !important;
            margin: 0;
        }

        .checkbox-label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        /* Selected Items Display */
        .selected-items {
            margin-top: var(--space-lg);
            padding: var(--space-md);
            background: var(--secondary-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            min-height: 60px;
            position: relative;
        }

        .selected-items:empty::before {
            content: 'Keine Auswahl getroffen';
            color: var(--text-muted);
            font-style: italic;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* Enhanced Navigation System */
        .nav-container {
            background: linear-gradient(135deg, var(--secondary-bg), var(--card-bg));
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-color);
            margin: var(--space-lg) 0;
            overflow: hidden;
            box-shadow: var(--shadow-md);
        }

        .nav-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0;
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .nav-item {
            flex: 1;
            min-width: 120px;
        }

        .nav-link {
            display: block;
            padding: var(--space-lg) var(--space-xl);
            color: var(--text-primary);
            text-decoration: none;
            text-align: center;
            font-weight: 500;
            transition: var(--transition-fast);
            border-right: 1px solid var(--border-color);
            position: relative;
            background: transparent;
        }

        .nav-link:last-child {
            border-right: none;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold));
            transition: all var(--transition-medium) var(--ease-out-quart);
            transform: translateX(-50%);
        }

        .nav-link:hover {
            background: var(--accent-bg);
            color: var(--accent-gold);
        }

        .nav-link:hover::before {
            width: 80%;
        }

        .nav-link:focus-visible {
            outline: 2px solid var(--focus-color);
            outline-offset: -2px;
            z-index: 1;
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            font-weight: 600;
        }

        .nav-link.active::before {
            width: 100%;
            background: var(--primary-bg);
        }

        /* Tab System Enhancement */
        .tab-container {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-color);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            margin: var(--space-lg) 0;
        }

        .tab-nav {
            display: flex;
            background: var(--secondary-bg);
            border-bottom: 2px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-gold) var(--secondary-bg);
        }

        .tab-nav::-webkit-scrollbar {
            height: 4px;
        }

        .tab-nav::-webkit-scrollbar-track {
            background: var(--secondary-bg);
        }

        .tab-nav::-webkit-scrollbar-thumb {
            background: var(--accent-gold);
            border-radius: var(--radius-full);
        }

        .tab-btn {
            background: transparent;
            border: none;
            padding: var(--space-lg) var(--space-xl);
            color: var(--text-muted);
            font-size: var(--font-size-base);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-fast);
            border-bottom: 3px solid transparent;
            white-space: nowrap;
            position: relative;
            flex-shrink: 0;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--accent-bg);
        }

        .tab-btn:focus-visible {
            outline: 2px solid var(--focus-color);
            outline-offset: -2px;
            z-index: 1;
        }

        .tab-btn.active {
            color: var(--accent-gold);
            background: var(--primary-bg);
            border-bottom-color: var(--accent-gold);
            font-weight: 600;
        }

        .tab-content {
            padding: var(--space-xl);
            min-height: 200px;
        }

        .tab-panel {
            display: none;
            animation: fadeInUp 0.3s var(--ease-out-quart);
        }

        .tab-panel.active {
            display: block;
        }

        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(20px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }

        /* Breadcrumb Navigation */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            margin: var(--space-lg) 0;
            padding: var(--space-md) var(--space-lg);
            background: var(--accent-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            font-size: var(--font-size-sm);
        }

        .breadcrumb-item {
            color: var(--text-muted);
            text-decoration: none;
            transition: var(--transition-fast);
        }

        .breadcrumb-item:hover {
            color: var(--accent-gold);
        }

        .breadcrumb-item.active {
            color: var(--text-primary);
            font-weight: 600;
        }

        .breadcrumb-separator {
            color: var(--text-muted);
            margin: 0 var(--space-xs);
        }

        /* Loading States */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-content {
            background: var(--panel-bg);
            padding: var(--space-2xl);
            border-radius: var(--radius-xl);
            border: 2px solid var(--border-color);
            text-align: center;
            box-shadow: var(--shadow-xl);
            max-width: 400px;
            width: 90%;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--space-lg);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: var(--space-lg);
            right: var(--space-lg);
            background: var(--panel-bg);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            box-shadow: var(--shadow-xl);
            z-index: 10001;
            max-width: 400px;
            animation: slideInRight 0.3s ease-out;
        }

        .toast-error {
            border-color: var(--error-color);
            background: linear-gradient(135deg, 
                rgba(239, 68, 68, 0.1) 0%, 
                rgba(239, 68, 68, 0.05) 100%);
        }

        .toast-content {
            display: flex;
            align-items: center;
            gap: var(--space-md);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: var(--space-xs);
            margin-left: auto;
            border-radius: var(--radius-sm);
            transition: var(--transition-fast);
        }

        .toast-close:hover {
            background: var(--secondary-bg);
            color: var(--text-primary);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Help Section */
        .help-section {
            margin-top: var(--space-2xl);
        }

        .help-section details {
            margin-bottom: 0;
        }

        .help-section summary {
            cursor: pointer;
            list-style: none;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: var(--transition-fast);
        }

        .help-section summary::-webkit-details-marker {
            display: none;
        }

        .help-section summary::after {
            content: 'expand_more';
            font-family: 'Material Icons';
            transition: var(--transition-fast);
        }

        .help-section details[open] summary::after {
            transform: rotate(180deg);
        }

        .help-section h3 {
            color: var(--text-accent);
            font-family: 'Orbitron', monospace;
            font-size: var(--font-size-lg);
            margin-bottom: var(--space-md);
        }

        .help-section ul {
            list-style: none;
            padding: 0;
        }

        .help-section li {
            padding: var(--space-sm) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .help-section li:last-child {
            border-bottom: none;
        }

        .help-section kbd {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            padding: var(--space-xs) var(--space-sm);
            font-family: 'Courier New', monospace;
            font-size: var(--font-size-sm);
            font-weight: bold;
        }

        /* Results Actions */
        .results-actions {
            display: flex;
            gap: var(--space-md);
            flex-wrap: wrap;
        }

        /* Error States */
        .form-input:invalid,
        .form-select:invalid {
            border-color: var(--error-color);
        }

        .form-input:invalid + .form-help,
        .form-select:invalid + .form-help {
            color: var(--error-color);
        }

        /* Focus Indicators */
        details:focus-within summary {
            outline: 2px solid var(--focus-color);
            outline-offset: 2px;
        }

        /* Responsive Improvements */
        @media (max-width: 1024px) {
            .container {
                padding: var(--space-md);
            }
            
            .grid-3 {
                grid-template-columns: 1fr;
            }
            
            .toast {
                top: var(--space-md);
                right: var(--space-md);
                left: var(--space-md);
                max-width: none;
            }
        }

        @media (max-width: 768px) {
            .site-header {
                padding: var(--space-lg);
                margin-bottom: var(--space-lg);
            }
            
            .card-header,
            .card-body,
            .card-footer {
                padding: var(--space-md);
            }
            
            .loading-content {
                padding: var(--space-lg);
            }
        }

        @media (max-width: 480px) {
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .results-actions {
                flex-direction: column;
            }
            
            .results-actions .btn {
                width: 100%;
            }
        }

        /* Print Styles */
        @media print {
            .skip-link,
            .loading-overlay,
            .toast,
            .help-section,
            .card-footer {
                display: none !important;
            }
            
            .card {
                border: 1px solid #000;
                box-shadow: none;
                page-break-inside: avoid;
                margin-bottom: 20px;
            }
            
            .site-header {
                border: none;
                box-shadow: none;
            }
        }

        /* Enhanced Results Display */
        .results-header {
            background: var(--secondary-bg);
            padding: var(--space-lg);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-lg);
            border: 1px solid var(--border-color);
        }

        .results-meta {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
        }

        .results-meta p {
            margin: 0;
            padding: var(--space-sm);
            background: var(--panel-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
        }

        .result-weapon-section {
            margin-bottom: var(--space-2xl);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            background: var(--panel-bg);
            overflow: hidden;
        }

        .result-weapon-title {
            background: linear-gradient(135deg, 
                rgba(212, 175, 55, 0.2) 0%, 
                rgba(184, 134, 11, 0.1) 100%);
            color: var(--text-accent);
            font-family: 'Orbitron', monospace;
            font-size: var(--font-size-xl);
            font-weight: 600;
            margin: 0;
            padding: var(--space-lg);
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            outline-offset: -2px;
        }

        .result-weapon-title:focus {
            outline: 2px solid var(--focus-color);
            background: linear-gradient(135deg, 
                rgba(212, 175, 55, 0.3) 0%, 
                rgba(184, 134, 11, 0.15) 100%);
        }

        .result-defenders {
            padding: var(--space-lg);
            display: grid;
            gap: var(--space-lg);
        }

        .result-defender-card {
            background: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: var(--transition-fast);
        }

        .result-defender-card:hover {
            border-color: var(--border-accent);
            box-shadow: var(--shadow-sm);
        }

        .result-defender-title {
            color: var(--text-accent);
            font-family: 'Orbitron', monospace;
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin: 0 0 var(--space-lg) 0;
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .result-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-md);
            margin-bottom: var(--space-lg);
        }

        .result-stat {
            background: var(--input-bg);
            padding: var(--space-md);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            text-align: center;
        }

        .stat-label {
            display: block;
            font-size: var(--font-size-sm);
            color: var(--text-muted);
            margin-bottom: var(--space-xs);
            font-weight: 500;
        }

        .stat-value {
            display: block;
            font-size: var(--font-size-xl);
            font-weight: 700;
            font-family: 'Orbitron', monospace;
        }

        .stat-value.primary {
            color: var(--primary-gold);
        }

        .stat-value.success {
            color: #22c55e;
        }

        .stat-value.warning {
            color: #f59e0b;
        }

        .stat-value.danger {
            color: var(--error-color);
        }

        /* Damage Distribution Chart */
        .damage-distribution {
            margin-top: var(--space-lg);
        }

        .damage-distribution h5 {
            color: var(--text-accent);
            font-family: 'Orbitron', monospace;
            font-size: var(--font-size-base);
            margin: 0 0 var(--space-md) 0;
            text-align: center;
        }

        .chart-container {
            display: flex;
            align-items: end;
            justify-content: center;
            gap: var(--space-xs);
            height: 120px;
            background: var(--primary-bg);
            padding: var(--space-sm);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .chart-bar {
            position: relative;
            background: linear-gradient(to top, var(--primary-gold), var(--secondary-gold));
            min-width: 30px;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            transition: var(--transition-fast);
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .chart-bar:hover {
            background: linear-gradient(to top, var(--secondary-gold), var(--accent-gold));
            transform: translateY(-2px);
        }

        .bar-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: var(--font-size-xs);
            color: var(--text-muted);
            font-weight: 600;
        }

        .bar-percentage {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: var(--font-size-xs);
            color: var(--text-primary);
            font-weight: 600;
            background: var(--panel-bg);
            padding: var(--space-xs);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            white-space: nowrap;
            opacity: 0;
            transition: var(--transition-fast);
        }

        .chart-bar:hover .bar-percentage {
            opacity: 1;
        }

        /* Stats Grid Enhancement */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-sm);
            margin-top: var(--space-md);
        }

        .stat-item {
            padding: var(--space-sm);
            background: var(--input-bg);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border-color);
            font-size: var(--font-size-sm);
            text-align: center;
        }

        /* Weapon/Defender Card Headers */
        .weapon-card-header,
        .defender-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
            padding-bottom: var(--space-sm);
            border-bottom: 1px solid var(--border-color);
        }

        .weapon-name,
        .defender-name {
            color: var(--text-accent);
            font-family: 'Orbitron', monospace;
            font-size: var(--font-size-lg);
            font-weight: 600;
            margin: 0;
        }

        .weapon-stats,
        .defender-stats {
            margin-bottom: var(--space-md);
        }

        .weapon-keywords,
        .defender-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-xs);
            margin-top: var(--space-md);
        }

        /* Enhanced Utility Classes */
        .visually-hidden {
            position: absolute !important;
            width: 1px !important;
            height: 1px !important;
            padding: 0 !important;
            margin: -1px !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            white-space: nowrap !important;
            border: 0 !important;
        }

        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }
        .text-justify { text-align: justify; }

        .font-weight-light { font-weight: 300; }
        .font-weight-normal { font-weight: 400; }
        .font-weight-medium { font-weight: 500; }
        .font-weight-semibold { font-weight: 600; }
        .font-weight-bold { font-weight: 700; }

        .text-primary { color: var(--text-primary) !important; }
        .text-secondary { color: var(--text-muted) !important; }
        .text-accent { color: var(--accent-gold) !important; }
        .text-error { color: var(--error-color) !important; }
        .text-success { color: var(--success-color) !important; }

        .bg-primary { background-color: var(--primary-bg) !important; }
        .bg-secondary { background-color: var(--secondary-bg) !important; }
        .bg-accent { background-color: var(--accent-bg) !important; }
        .bg-card { background-color: var(--card-bg) !important; }

        .border-primary { border-color: var(--border-color) !important; }
        .border-accent { border-color: var(--border-accent) !important; }
        .border-none { border: none !important; }

        .rounded-sm { border-radius: var(--radius-sm) !important; }
        .rounded { border-radius: var(--radius-md) !important; }
        .rounded-lg { border-radius: var(--radius-lg) !important; }
        .rounded-xl { border-radius: var(--radius-xl) !important; }
        .rounded-full { border-radius: var(--radius-full) !important; }

        .shadow-sm { box-shadow: var(--shadow-sm) !important; }
        .shadow { box-shadow: var(--shadow-md) !important; }
        .shadow-lg { box-shadow: var(--shadow-lg) !important; }
        .shadow-xl { box-shadow: var(--shadow-xl) !important; }
        .shadow-none { box-shadow: none !important; }

        .d-none { display: none !important; }
        .d-block { display: block !important; }
        .d-inline { display: inline !important; }
        .d-inline-block { display: inline-block !important; }
        .d-flex { display: flex !important; }
        .d-inline-flex { display: inline-flex !important; }
        .d-grid { display: grid !important; }

        .flex-row { flex-direction: row !important; }
        .flex-column { flex-direction: column !important; }
        .flex-wrap { flex-wrap: wrap !important; }
        .flex-nowrap { flex-wrap: nowrap !important; }

        .justify-start { justify-content: flex-start !important; }
        .justify-center { justify-content: center !important; }
        .justify-end { justify-content: flex-end !important; }
        .justify-between { justify-content: space-between !important; }
        .justify-around { justify-content: space-around !important; }
        .justify-evenly { justify-content: space-evenly !important; }

        .align-start { align-items: flex-start !important; }
        .align-center { align-items: center !important; }
        .align-end { align-items: flex-end !important; }
        .align-stretch { align-items: stretch !important; }

        .gap-xs { gap: var(--space-xs) !important; }
        .gap-sm { gap: var(--space-sm) !important; }
        .gap-md { gap: var(--space-md) !important; }
        .gap-lg { gap: var(--space-lg) !important; }
        .gap-xl { gap: var(--space-xl) !important; }

        .m-0 { margin: 0 !important; }
        .m-auto { margin: auto !important; }
        .mt-0 { margin-top: 0 !important; }
        .mt-sm { margin-top: var(--space-sm) !important; }
        .mt-md { margin-top: var(--space-md) !important; }
        .mt-lg { margin-top: var(--space-lg) !important; }
        .mt-xl { margin-top: var(--space-xl) !important; }

        .mb-0 { margin-bottom: 0 !important; }
        .mb-sm { margin-bottom: var(--space-sm) !important; }
        .mb-md { margin-bottom: var(--space-md) !important; }
        .mb-lg { margin-bottom: var(--space-lg) !important; }
        .mb-xl { margin-bottom: var(--space-xl) !important; }

        .ml-0 { margin-left: 0 !important; }
        .ml-auto { margin-left: auto !important; }
        .mr-0 { margin-right: 0 !important; }
        .mr-auto { margin-right: auto !important; }

        .p-0 { padding: 0 !important; }
        .pt-0 { padding-top: 0 !important; }
        .pt-sm { padding-top: var(--space-sm) !important; }
        .pt-md { padding-top: var(--space-md) !important; }
        .pt-lg { padding-top: var(--space-lg) !important; }
        .pt-xl { padding-top: var(--space-xl) !important; }

        .pb-0 { padding-bottom: 0 !important; }
        .pb-sm { padding-bottom: var(--space-sm) !important; }
        .pb-md { padding-bottom: var(--space-md) !important; }
        .pb-lg { padding-bottom: var(--space-lg) !important; }
        .pb-xl { padding-bottom: var(--space-xl) !important; }

        .w-25 { width: 25% !important; }
        .w-50 { width: 50% !important; }
        .w-75 { width: 75% !important; }
        .w-100 { width: 100% !important; }
        .w-auto { width: auto !important; }

        .h-25 { height: 25% !important; }
        .h-50 { height: 50% !important; }
        .h-75 { height: 75% !important; }
        .h-100 { height: 100% !important; }
        .h-auto { height: auto !important; }

        .position-static { position: static !important; }
        .position-relative { position: relative !important; }
        .position-absolute { position: absolute !important; }
        .position-fixed { position: fixed !important; }
        .position-sticky { position: sticky !important; }

        .overflow-hidden { overflow: hidden !important; }
        .overflow-auto { overflow: auto !important; }
        .overflow-visible { overflow: visible !important; }
        .overflow-scroll { overflow: scroll !important; }

        .cursor-pointer { cursor: pointer !important; }
        .cursor-default { cursor: default !important; }
        .cursor-not-allowed { cursor: not-allowed !important; }

        .user-select-none { user-select: none !important; }
        .user-select-all { user-select: all !important; }
        .user-select-text { user-select: text !important; }

        .transition-none { transition: none !important; }
        .transition-fast { transition: var(--transition-fast) !important; }
        .transition-medium { transition: var(--transition-medium) !important; }
        .transition-slow { transition: var(--transition-slow) !important; }

        .transform-none { transform: none !important; }
        .scale-95 { transform: scale(0.95) !important; }
        .scale-100 { transform: scale(1) !important; }
        .scale-105 { transform: scale(1.05) !important; }
        .scale-110 { transform: scale(1.1) !important; }

        .rotate-0 { transform: rotate(0deg) !important; }
        .rotate-90 { transform: rotate(90deg) !important; }
        .rotate-180 { transform: rotate(180deg) !important; }
        .rotate-270 { transform: rotate(270deg) !important; }

        .opacity-0 { opacity: 0 !important; }
        .opacity-25 { opacity: 0.25 !important; }
        .opacity-50 { opacity: 0.5 !important; }
        .opacity-75 { opacity: 0.75 !important; }
        .opacity-100 { opacity: 1 !important; }

        .z-0 { z-index: 0 !important; }
        .z-10 { z-index: 10 !important; }
        .z-20 { z-index: 20 !important; }
        .z-30 { z-index: 30 !important; }
        .z-40 { z-index: 40 !important; }
        .z-50 { z-index: 50 !important; }

        /* Mobile-First Responsive Utilities */
        @media (min-width: 768px) {
            .md\:d-none { display: none !important; }
            .md\:d-block { display: block !important; }
            .md\:d-flex { display: flex !important; }
            .md\:d-grid { display: grid !important; }
            
            .md\:flex-row { flex-direction: row !important; }
            .md\:flex-column { flex-direction: column !important; }
            
            .md\:text-left { text-align: left !important; }
            .md\:text-center { text-align: center !important; }
            .md\:text-right { text-align: right !important; }
            
            .md\:w-25 { width: 25% !important; }
            .md\:w-50 { width: 50% !important; }
            .md\:w-75 { width: 75% !important; }
            .md\:w-100 { width: 100% !important; }
            .md\:w-auto { width: auto !important; }
        }

        @media (min-width: 1024px) {
            .lg\:d-none { display: none !important; }
            .lg\:d-block { display: block !important; }
            .lg\:d-flex { display: flex !important; }
            .lg\:d-grid { display: grid !important; }
            
            .lg\:flex-row { flex-direction: row !important; }
            .lg\:flex-column { flex-direction: column !important; }
            
            .lg\:text-left { text-align: left !important; }
            .lg\:text-center { text-align: center !important; }
            .lg\:text-right { text-align: right !important; }
            
            .lg\:w-25 { width: 25% !important; }
            .lg\:w-50 { width: 50% !important; }
            .lg\:w-75 { width: 75% !important; }
            .lg\:w-100 { width: 100% !important; }
            .lg\:w-auto { width: auto !important; }
        }

        @media (min-width: 1280px) {
            .xl\:d-none { display: none !important; }
            .xl\:d-block { display: block !important; }
            .xl\:d-flex { display: flex !important; }
            .xl\:d-grid { display: grid !important; }
            
            .xl\:flex-row { flex-direction: row !important; }
            .xl\:flex-column { flex-direction: column !important; }
            
            .xl\:text-left { text-align: left !important; }
            .xl\:text-center { text-align: center !important; }
            .xl\:text-right { text-align: right !important; }
            
            .xl\:w-25 { width: 25% !important; }
            .xl\:w-50 { width: 50% !important; }
            .xl\:w-75 { width: 75% !important; }
            .xl\:w-100 { width: 100% !important; }
            .xl\:w-auto { width: auto !important; }
        }

        /* Enhanced Responsive Design */
        @media (max-width: 1200px) {
            .result-stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .result-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .results-meta {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 100px;
                padding: var(--space-xs);
            }
            
            .chart-bar {
                min-width: 25px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .weapon-card-header,
            .defender-card-header {
                flex-direction: column;
                align-items: stretch;
                gap: var(--space-sm);
            }
            
            .weapon-name,
            .defender-name {
                text-align: center;
            }
        }

        /* Performance Optimizations */
        .card,
        .weapon-card,
        .defender-card,
        .result-defender-card {
            contain: layout style paint;
        }

        /* Animation Performance */
        .btn,
        .card,
        .chart-bar {
            will-change: transform;
        }

        .btn:not(:hover),
        .card:not(:hover),
        .chart-bar:not(:hover) {
            will-change: auto;
        }

        /* Focus Improvements */
        .result-weapon-title:focus-visible,
        .btn:focus-visible,
        .form-input:focus-visible,
        .form-select:focus-visible {
            outline: 3px solid var(--focus-color);
            outline-offset: 2px;
        }

        /* Custom Scrollbar for Results */
        .chart-container::-webkit-scrollbar {
            height: 8px;
        }

        .chart-container::-webkit-scrollbar-track {
            background: var(--secondary-bg);
            border-radius: var(--radius-sm);
        }

        .chart-container::-webkit-scrollbar-thumb {
            background: var(--primary-gold);
            border-radius: var(--radius-sm);
        }

        .chart-container::-webkit-scrollbar-thumb:hover {
            background: var(--secondary-gold);
        }
        .defender-card h4,
        .defender-card h5,
        .defender-card h6 {
            color: var(--text-accent);
            margin-bottom: 15px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Grid Layouts */
        .weapons-grid,
        .defenders-grid {
            display: grid;
            gap: 20px;
            margin-top: 20px;
        }

        .weapons-grid {
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
        }

        .defenders-grid {
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        /* Stats Display */
        .weapon-stats,
        .defender-stats {
            display: grid;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .stat-value {
            color: var(--text-primary);
            font-weight: 600;
            font-family: 'Orbitron', monospace;
        }

        /* Keyword Tags */
        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .keyword-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: var(--radius-lg);
            font-size: 0.875rem;
            font-weight: 500;
            border: 1px solid;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .keyword-tag::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.3s;
        }

        .keyword-tag:hover::before {
            left: 100%;
        }

        .keyword-tag.lethal {
            background: linear-gradient(135deg, var(--primary-red), var(--secondary-red));
            color: var(--text-primary);
            border-color: var(--accent-red);
        }

        .keyword-tag.devastating {
            background: linear-gradient(135deg, #8b5a00, #cd853f);
            color: var(--text-primary);
            border-color: #daa520;
        }

        .keyword-tag.sustained {
            background: linear-gradient(135deg, var(--secondary-blue), var(--accent-blue));
            color: var(--text-primary);
            border-color: var(--accent-blue);
        }

        .keyword-tag.crit {
            background: linear-gradient(135deg, var(--primary-gold), var(--secondary-gold));
            color: var(--primary-bg);
            border-color: var(--accent-gold);
        }

        .keyword-tag.anti {
            background: linear-gradient(135deg, #6b46c1, #8b5cf6);
            color: var(--text-primary);
            border-color: #a78bfa;
        }

        .keyword-tag.melta {
            background: linear-gradient(135deg, #dc2626, #f59e0b);
            color: var(--text-primary);
            border-color: #fbbf24;
        }

        .keyword-tag.reroll {
            background: linear-gradient(135deg, #059669, #10b981);
            color: var(--text-primary);
            border-color: #34d399;
        }

        .keyword-tag.hazardous {
            background: linear-gradient(135deg, #7c2d12, #ea580c);
            color: var(--text-primary);
            border-color: #fb923c;
        }

        .keyword-tag.blast {
            background: linear-gradient(135deg, #4338ca, #6366f1);
            color: var(--text-primary);
            border-color: #818cf8;
        }

        .keyword-tag.torrent {
            background: linear-gradient(135deg, #0891b2, #06b6d4);
            color: var(--text-primary);
            border-color: #22d3ee;
        }

        .keyword-tag .remove {
            cursor: pointer;
            font-weight: bold;
            margin-left: 4px;
            opacity: 0.7;
            transition: var(--transition-fast);
        }

        .keyword-tag .remove:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        /* Help Button */
        .help-btn {
            background: linear-gradient(135deg, var(--secondary-blue), var(--accent-blue));
            color: var(--text-primary);
            border: 2px solid var(--accent-blue);
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
            background: linear-gradient(135deg, var(--accent-blue), var(--secondary-blue));
        }

        /* Keywords Input */
        .keywords-section {
            margin-top: 20px;
        }

        .keywords-input {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            align-items: center;
        }

        .keywords-input input {
            flex: 1;
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .unit-list {
            margin-top: 20px;
        }

        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 1.1rem;
        }

        .unit-controls {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #667eea;
            padding: 10px;
            margin: 5px 0;
            border-radius: 0 5px 5px 0;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .weapon-info {
            flex: 1;
            margin-bottom: 8px;
        }

        .weapon-controls {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            align-items: center;
        }

        .weapon-controls .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 60px;
        }

        /* Results Panel */
        .results-panel {
            grid-column: 1 / -1;
            margin-top: 40px;
            background: var(--panel-bg);
            border-radius: var(--radius-xl);
            padding: 30px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(20px);
            position: relative;
        }

        .results-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold), var(--primary-gold));
            border-radius: var(--radius-xl) var(--radius-xl) 0 0;
        }

        .results-grid {
            display: flex;
            flex-direction: column;
            gap: 25px;
            margin-top: 25px;
            width: 100%;
            overflow-x: hidden;
        }

        .result-section {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 25px;
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
            overflow-wrap: break-word;
            transition: var(--transition);
            position: relative;
            box-shadow: var(--shadow-md);
        }

        .result-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary-gold), var(--secondary-gold));
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            opacity: 0.7;
        }

        .result-section:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--border-accent);
        }

        .result-section h3,
        .result-section h4 {
            color: var(--text-accent);
            margin: 0 0 20px 0;
            font-size: 1.4rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border-color);
            font-family: 'Orbitron', monospace;
        }

        .attacker-group-header h2 {
            font-family: 'Orbitron', monospace;
            color: var(--text-accent);
            font-size: 1.6rem;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .target-result h4 {
            color: var(--accent-blue);
            font-size: 1.3rem;
            margin-bottom: 20px;
        }

        .result-item {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 5px;
            padding: 15px;
        }

        .result-header {
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .stat-label {
            color: #b8c6db;
        }

        .stat-value {
            color: #e0e6ed;
            font-weight: 600;
        }

        .json-section {
            margin-top: 20px;
        }

        .json-textarea {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        /* Loading Spinner */
        .loading-spinner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-spinner.active {
            opacity: 1;
            visibility: visible;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-gold);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Simulation Controls */
        .simulation-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            margin: 25px 0;
            padding: 20px;
            background: var(--card-bg);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            flex-wrap: wrap;
            box-shadow: var(--shadow-sm);
        }

        .simulation-controls label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-right: 8px;
        }

        .simulation-controls input {
            width: 120px;
            padding: 8px 12px;
        }

        .keyword-reference {
            margin-top: 30px;
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 25px;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
        }

        .keyword-reference h3 {
            color: var(--text-accent);
            margin-bottom: 20px;
            font-family: 'Orbitron', monospace;
        }

        .keyword-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .weapons-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
            margin: 10px 0;
            width: 100%;
        }

        .weapons-section {
            width: 100%;
        }

        .collapsible-content {
            width: 100%;
            padding: 15px 0;
        }

        .defenders-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 10px 0;
            width: 100%;
        }

        .targets-section {
            width: 100%;
            margin-top: 20px;
        }

        .weapon-card, .defender-card {
            background: rgba(255, 255, 255, 0.07);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            transition: all 0.3s ease;
        }

        .weapon-card:hover, .defender-card:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 215, 0, 0.5);
            transform: translateY(-2px);
        }

        .defender-card.leader {
            border-color: rgba(255, 215, 0, 0.6);
            background: rgba(255, 215, 0, 0.05);
        }

        .weapon-card h5, .defender-card h6 {
            color: #ffd700;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }

        .weapon-stats, .defender-stats {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-label {
            color: #b8c6db;
            font-size: 0.9rem;
        }

        .stat-value {
            color: #fff;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .keyword-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 3px;
            border-left: 3px solid #667eea;
        }

        /* Neue Keyword-Tag Styles */
        .weapon-keywords {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
        }

        .keyword-tag {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .keyword-tag.lethal {
            background: #e74c3c;
            color: white;
        }

        .keyword-tag.devastating {
            background: #8e44ad;
            color: white;
        }

        .keyword-tag.sustained {
            background: #f39c12;
            color: white;
        }

        .keyword-tag.crit {
            background: #2ecc71;
            color: white;
        }

        .keyword-tag.anti {
            background: #34495e;
            color: white;
        }

        .keyword-tag.melta {
            background: #e67e22;
            color: white;
        }

        .keyword-tag.reroll {
            background: #3498db;
            color: white;
        }

        .keyword-tag.hazardous {
            background: #c0392b;
            color: white;
        }

        .keyword-tag.blast {
            background: #d35400;
            color: white;
        }

        .keyword-tag.torrent {
            background: #27ae60;
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 25px 20px;
                margin-bottom: 25px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .main-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .panel {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group .btn {
                width: 100%;
                margin-bottom: 10px;
            }
            
            .simulation-controls {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            .keywords-input {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 768px) {
            .weapons-grid {
                grid-template-columns: 1fr;
            }
            
            .defenders-grid {
                grid-template-columns: 1fr;
            }
            
            .results-panel {
                padding: 20px;
                max-height: none;
                height: auto;
                overflow-y: visible;
            }
            
            .result-section {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2.5rem;
            }
            
            .panel h2 {
                font-size: 1.3rem;
            }
            
            .simulation-controls {
                padding: 15px;
            }
        }

        @media (min-width: 769px) and (max-width: 1024px) {
            .weapons-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .defenders-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
        }

        @media (min-width: 1025px) and (max-width: 1399px) {
            .weapons-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
            
            .defenders-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
        }

        @media (min-width: 1400px) {
            .weapons-grid {
                grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            }
            
            .defenders-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
            
            .container {
                max-width: 1600px;
            }
        }

        @media (min-width: 1800px) {
            .weapons-grid {
                grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            }
            
            .main-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        .keyword-name {
            font-weight: bold;
            color: #ffd700;
        }

        .keyword-desc {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .chart-container {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .chart-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 100px;
            margin: 10px 0;
        }

        .bar {
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 2px 2px 0 0;
            min-width: 12px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -15px;
            font-size: 9px;
            color: #b8c6db;
        }

        .probability-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .wipeout-chance {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e6ed;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ffd700;
        }

        /* Collapsible Button für Ergebnisse */
        .collapsible-btn {
            background: rgba(102, 126, 234, 0.2);
            color: #e0e6ed;
            cursor: pointer;
            padding: 12px 20px;
            width: 100%;
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 8px;
            text-align: left;
            outline: none;
            font-size: 1.1rem;
            font-weight: 600;
            margin: 10px 0;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-sizing: border-box;
        }

        .collapsible-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.6);
        }

        .collapsible-btn.active {
            background: rgba(255, 215, 0, 0.15);
            border-color: rgba(255, 215, 0, 0.4);
            color: #ffd700;
        }

        .toggle-icon {
            transition: transform 0.3s ease;
            font-size: 0.9rem;
        }

        .collapsible-btn.active .toggle-icon {
            transform: rotate(180deg);
        }

        /* Success and Error Messages */
        .success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .error {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        /* Loading Overlay */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .loading.active {
            display: flex;
        }

        .spinner {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 215, 0, 0.2);
            border-top: 6px solid #ffd700;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .loading-text {
            color: #ffd700;
            font-size: 1.2rem;
            font-weight: bold;
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Unit and Weapon Management Styles */
        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-header h3 {
            margin: 0;
            color: #ffd700;
        }

        .unit-stats p {
            margin: 5px 0;
        }

        .weapons-list {
            margin-top: 10px;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .weapon-item button {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .btn-small {
            padding: 3px 8px;
            font-size: 0.8rem;
        }

        .keyword-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .keyword-selection-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .keyword-selection-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        .keyword-selection-item.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .keyword-selection-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .keyword-selection-desc {
            font-size: 0.85rem;
            color: #b8c6db;
        }

        .keyword-parameter-inputs {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
        }

        .keyword-parameter-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .keyword-parameter-label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #ffd700;
        }

        .keyword-parameter-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            font-size: 0.9rem;
        }

        .simulation-start-panel {
            text-align: center;
            margin: 30px 0;
        }

        .simulation-final-controls p {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #b8c6db;
        }

        .btn-large {
            font-size: 1.2rem !important;
            padding: 15px 30px !important;
        }

        /* Chart Styles */
        .distribution-chart {
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            overflow-x: auto; /* Allow horizontal scrolling if needed */
        }

        .chart-bar-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 3px;
            min-width: 30px;
            max-width: 60px;
            flex: 1;
        }

        .chart-bars-row {
            display: flex;
            align-items: flex-end;
            height: 120px;
            margin-bottom: 10px;
            padding: 0 5px;
            min-width: fit-content;
        }

        .chart-bar {
            width: 100%;
            border-radius: 3px 3px 0 0;
            position: relative;
            min-height: 3px;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .chart-bar:hover {
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
        }

        .bar-label {
            color: white;
            font-size: 0.65rem;
            font-weight: bold;
            padding: 1px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .bar-text {
            color: #ccc;
            font-size: 0.7rem;
            margin-top: 3px;
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body>
    <!-- Skip Links für bessere Zugänglichkeit -->
    <a href="#main-content" class="skip-link">Zum Hauptinhalt springen</a>
    <a href="#simulation-controls" class="skip-link">Zu den Simulationseinstellungen springen</a>
    <a href="#results" class="skip-link">Zu den Ergebnissen springen</a>

    <div class="container">
        <!-- Hauptheader mit semantischer Struktur -->
        <header class="site-header" role="banner">
            <h1 class="site-title">Warhammer 40k Combat Simulator</h1>
            <p class="site-description">
                Präzise mathematische Simulation für Warhammer 40.000 Kampfszenarien
            </p>
            <span class="version-badge" aria-label="Version 2.1">v2.1</span>
        </header>

        <!-- Hauptinhalt mit verbesserter Semantik -->
        <main id="main-content" role="main" aria-labelledby="main-heading">
            <h2 id="main-heading" class="sr-only">Combat Simulator Interface</h2>
            
            <!-- Hauptlayout Grid -->
            <div class="main-grid">
                <!-- Waffen-Sektion -->
                <section class="card" aria-labelledby="weapons-heading">
                    <header class="card-header">
                        <h2 id="weapons-heading" class="card-title">
                            <i class="material-icons" aria-hidden="true">gps_fixed</i>
                            Waffen Konfiguration
                        </h2>
                    </header>
                    
                    <div class="card-body">
                        <!-- Waffen-Upload -->
                        <div class="form-group">
                            <label for="weapon-upload" class="form-label required">
                                Waffen-Datei hochladen (.json)
                            </label>
                            <input 
                                type="file" 
                                id="weapon-upload" 
                                class="form-input" 
                                accept=".json"
                                aria-describedby="weapon-upload-help"
                                onchange="loadWeapons(event)"
                                required
                            />
                            <div id="weapon-upload-help" class="form-help">
                                JSON-Datei mit Waffenstatistiken auswählen
                            </div>
                        </div>

                        <!-- Waffen-Auswahl -->
                        <div class="form-group">
                            <label for="weapon-select" class="form-label required">
                                Waffe auswählen
                            </label>
                            <select 
                                id="weapon-select" 
                                class="form-select"
                                aria-describedby="weapon-select-help"
                                onchange="selectWeapon()"
                                required
                            >
                                <option value="">-- Waffe auswählen --</option>
                            </select>
                            <div id="weapon-select-help" class="form-help">
                                Verfügbare Waffe aus der geladenen Datei wählen
                            </div>
                        </div>

                        <!-- Gewählte Waffen Anzeige -->
                        <div 
                            id="selected-weapons" 
                            class="selected-items"
                            role="region"
                            aria-labelledby="selected-weapons-heading"
                            aria-live="polite"
                        >
                            <h3 id="selected-weapons-heading" class="sr-only">Ausgewählte Waffen</h3>
                        </div>
                    </div>
                </section>

                <!-- Verteidiger-Sektion -->
                <section class="card" aria-labelledby="defenders-heading">
                    <header class="card-header">
                        <h2 id="defenders-heading" class="card-title">
                            <i class="material-icons" aria-hidden="true">shield</i>
                            Verteidiger Konfiguration
                        </h2>
                    </header>
                    
                    <div class="card-body">
                        <!-- Verteidiger-Upload -->
                        <div class="form-group">
                            <label for="defender-upload" class="form-label required">
                                Verteidiger-Datei hochladen (.json)
                            </label>
                            <input 
                                type="file" 
                                id="defender-upload" 
                                class="form-input" 
                                accept=".json"
                                aria-describedby="defender-upload-help"
                                onchange="loadDefenders(event)"
                                required
                            />
                            <div id="defender-upload-help" class="form-help">
                                JSON-Datei mit Verteidigerstatistiken auswählen
                            </div>
                        </div>

                        <!-- Verteidiger-Auswahl -->
                        <div class="form-group">
                            <label for="defender-select" class="form-label required">
                                Verteidiger auswählen
                            </label>
                            <select 
                                id="defender-select" 
                                class="form-select"
                                aria-describedby="defender-select-help"
                                onchange="selectDefender()"
                                required
                            >
                                <option value="">-- Verteidiger auswählen --</option>
                            </select>
                            <div id="defender-select-help" class="form-help">
                                Verfügbaren Verteidiger aus der geladenen Datei wählen
                            </div>
                        </div>

                        <!-- Gewählte Verteidiger Anzeige -->
                        <div 
                            id="selected-defenders" 
                            class="selected-items"
                            role="region"
                            aria-labelledby="selected-defenders-heading"
                            aria-live="polite"
                        >
                            <h3 id="selected-defenders-heading" class="sr-only">Ausgewählte Verteidiger</h3>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Simulations-Steuerung -->
            <section 
                id="simulation-controls" 
                class="card" 
                aria-labelledby="simulation-heading"
            >
                <header class="card-header">
                    <h2 id="simulation-heading" class="card-title">
                        <i class="material-icons" aria-hidden="true">analytics</i>
                        Simulation starten
                    </h2>
                </header>
                
                <div class="card-body">
                    <div class="grid grid-3">
                        <!-- Simulation Parameter -->
                        <div class="form-group">
                            <label for="iterations" class="form-label">
                                Anzahl Simulationen
                            </label>
                            <input 
                                type="number" 
                                id="iterations" 
                                class="form-input"
                                value="10000" 
                                min="100" 
                                max="1000000"
                                aria-describedby="iterations-help"
                            />
                            <div id="iterations-help" class="form-help">
                                Mehr Simulationen = genauere Ergebnisse (100-1.000.000)
                            </div>
                        </div>

                        <!-- Exportoptionen -->
                        <div class="form-group">
                            <label for="export-pdf" class="form-label">
                                PDF Export
                            </label>
                            <div class="checkbox-group">
                                <input 
                                    type="checkbox" 
                                    id="export-pdf" 
                                    class="form-checkbox"
                                    aria-describedby="export-pdf-help"
                                />
                                <label for="export-pdf" class="checkbox-label">
                                    Ergebnisse als PDF exportieren
                                </label>
                            </div>
                            <div id="export-pdf-help" class="form-help">
                                Automatischer PDF-Download nach Simulation
                            </div>
                        </div>

                        <!-- Simulation Button -->
                        <div class="form-group">
                            <label class="form-label">&nbsp;</label>
                            <button 
                                id="simulate-btn" 
                                class="btn btn-primary btn-large"
                                onclick="runSimulation()"
                                aria-describedby="simulate-help"
                                disabled
                            >
                                <i class="material-icons" aria-hidden="true">play_arrow</i>
                                Simulation starten
                            </button>
                            <div id="simulate-help" class="form-help">
                                Waffe und Verteidiger müssen ausgewählt sein
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Ergebnisse Sektion -->
            <section 
                id="results" 
                class="card" 
                aria-labelledby="results-heading"
                aria-live="polite"
                style="display: none;"
            >
                <header class="card-header">
                    <h2 id="results-heading" class="card-title">
                        <i class="material-icons" aria-hidden="true">assessment</i>
                        Simulationsergebnisse
                    </h2>
                </header>
                
                <div class="card-body">
                    <div id="results-content" role="region" aria-label="Simulationsergebnisse">
                        <!-- Ergebnisse werden hier dynamisch eingefügt -->
                    </div>
                </div>
                
                <footer class="card-footer">
                    <div class="results-actions">
                        <button 
                            class="btn btn-secondary"
                            onclick="exportToPDF()"
                            aria-label="Ergebnisse als PDF exportieren"
                        >
                            <i class="material-icons" aria-hidden="true">download</i>
                            PDF Export
                        </button>
                        
                        <button 
                            class="btn btn-secondary"
                            onclick="clearResults()"
                            aria-label="Ergebnisse löschen"
                        >
                            <i class="material-icons" aria-hidden="true">clear</i>
                            Ergebnisse löschen
                        </button>
                    </div>
                </footer>
            </section>
        </main>

        <!-- Help & Info Sektion -->
        <aside class="help-section" role="complementary" aria-labelledby="help-heading">
            <details class="card">
                <summary class="card-header" id="help-heading">
                    <h2 class="card-title">
                        <i class="material-icons" aria-hidden="true">help</i>
                        Hilfe & Informationen
                    </h2>
                </summary>
                
                <div class="card-body">
                    <div class="grid grid-2">
                        <div>
                            <h3>Dateiformate</h3>
                            <ul>
                                <li><strong>Waffen:</strong> JSON-Datei mit Waffenstatistiken</li>
                                <li><strong>Verteidiger:</strong> JSON-Datei mit Einheitenstatistiken</li>
                                <li><strong>Export:</strong> PDF-Bericht der Simulationsergebnisse</li>
                            </ul>
                        </div>
                        
                        <div>
                            <h3>Tastaturkürzel</h3>
                            <ul>
                                <li><kbd>Tab</kbd> - Navigation zwischen Elementen</li>
                                <li><kbd>Enter</kbd> - Button aktivieren</li>
                                <li><kbd>Space</kbd> - Checkbox togglen</li>
                                <li><kbd>Esc</kbd> - Modalfenster schließen</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </details>
        </aside>
    </div>

    <!-- Loading Overlay -->
    <div 
        id="loading-overlay" 
        class="loading-overlay" 
        role="dialog" 
        aria-modal="true" 
        aria-labelledby="loading-title"
        style="display: none;"
    >
        <div class="loading-content">
            <div class="loading-spinner" aria-hidden="true"></div>
            <h2 id="loading-title">Simulation läuft...</h2>
            <p id="loading-progress" aria-live="polite">Wird geladen...</p>
        </div>
    </div>

    <!-- Error Toast -->
    <div 
        id="error-toast" 
        class="toast toast-error" 
        role="alert" 
        aria-live="assertive"
        style="display: none;"
    >
        <div class="toast-content">
            <i class="material-icons" aria-hidden="true">error</i>
            <span id="error-message"></span>
            <button 
                class="toast-close" 
                onclick="hideErrorToast()"
                aria-label="Fehlermeldung schließen"
            >
                <i class="material-icons" aria-hidden="true">close</i>
            </button>
        </div>
    </div>
        <div class="header">
            <h1>⚔️ Warhammer 40k 10th Edition Kampfsimulator ⚔️</h1>
            <p>Simuliere Kämpfe zwischen Angreifern und Verteidigern mit allen 10th Edition Regeln</p>
            <div class="version-badge">Version 2.0</div>
        </div>

        <!-- Simulation Panel -->
        <div class="panel simulation-panel">
            <h2><span class="material-icons">settings</span>Simulation Setup</h2>
            
            <div class="simulation-controls">
                <label>Anzahl Simulationen:</label>
                <input type="number" id="simulationAmount" value="1000" min="10" max="100000">
            </div>

            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <div class="loading-text">
                    Simulation läuft...<br>
                    <small>Bitte warten Sie, während die Berechnung durchgeführt wird.</small>
                </div>
            </div>

            <!-- JSON Import/Export als aufklappbar -->
            <button class="collapsible" onclick="toggleCollapsible(this)">
                📄 JSON Import/Export
            </button>
            <div class="collapsible-content">
                <div class="form-group">
                    <label>📥 Konfiguration aus Datei laden:</label>
                    <input type="file" id="jsonFileInput" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="importFromFile()">Datei importieren</button>
                </div>

                <div class="form-group">
                    <label>📤 Aktuelle Konfiguration speichern:</label>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="exportJson()">Als Datei exportieren</button>
                        <button class="btn" onclick="showFullJson()">JSON anzeigen</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>📝 Oder JSON manuell eingeben:</label>
                    <textarea class="json-textarea" id="jsonImport" placeholder="Fügen Sie hier Ihre JSON-Konfiguration ein..."></textarea>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="importJson()">JSON importieren</button>
                        <button class="btn" onclick="loadExample()">Beispiel laden</button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="showFullJson()">Vollständige JSON anzeigen</button>
                <button class="btn btn-danger" onclick="clearAll()">Alles zurücksetzen</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Angreifer Panel -->
            <div class="panel">
                <h2><span class="material-icons">swords</span>Angreifer verwalten</h2>
                
                <div class="form-group">
                    <label>Gruppen-Name (z.B. "Space Marine Squad"):</label>
                    <input type="text" id="attackerGroupName" placeholder="z.B. Space Marine Squad">
                </div>

                <div class="form-group">
                    <label>Name des Angreifers:</label>
                    <input type="text" id="attackerName" placeholder="z.B. Sergeant, Marine">
                </div>

                <div class="form-group">
                    <label>Anzahl dieses Modell-Typs:</label>
                    <input type="number" id="attackerCount" value="1" min="1" max="20">
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addAttacker()">Angreifer hinzufügen</button>
                </div>

                <div class="unit-list" id="attackersList"></div>

                <!-- Waffe hinzufügen als aufklappbar -->
                <button class="collapsible" onclick="toggleCollapsible(this)">
                    ⚔️ Waffe hinzufügen
                </button>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label>Angreifer auswählen:</label>
                        <select id="weaponAttackerSelect">
                            <option value="">Bitte Angreifer auswählen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Waffenname:</label>
                        <input type="text" id="weaponName" placeholder="z.B. Bolter">
                    </div>
                    
                    <div class="form-group">
                        <label>Anzahl identischer Waffen (Amount):</label>
                        <input type="number" id="weaponAmount" value="1" min="1" max="20">
                    </div>

                    <div class="form-group">
                        <label>Waffentyp:</label>
                        <select id="weaponType">
                            <option value="Ranged">Ranged</option>
                            <option value="Melee">Melee</option>
                            <option value="Psychic">Psychic</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Attacks (kann D6, 2D3+1, etc. sein):</label>
                        <input type="text" id="weaponAttacks" value="1" placeholder="z.B. 2D6+3">
                    </div>

                    <div class="form-group">
                        <label>To Hit (Würfelwurf benötigt):</label>
                        <input type="number" id="weaponToHit" value="4" min="2" max="6">
                    </div>

                    <div class="form-group">
                        <label>Strength:</label>
                        <input type="number" id="weaponStrength" value="4" min="1" max="20">
                    </div>

                    <div class="form-group">
                        <label>AP (Armor Penetration):</label>
                        <input type="number" id="weaponAP" value="0" min="0" max="6">
                    </div>

                    <div class="form-group">
                        <label>Damage (kann D6, D3+1, etc. sein):</label>
                        <input type="text" id="weaponDamage" value="1" placeholder="z.B. D6+2">
                    </div>                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="weaponKeywordInput" placeholder="Keyword eingeben oder aus Liste wählen">
                        <button class="btn btn-small" onclick="addWeaponKeyword()">+</button>
                        <button class="btn btn-small" onclick="showKeywordSelector('weapon')" title="Aus Keyword-Liste auswählen">📋</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="weaponKeywords"></div>
                    
                    <!-- Parameter-Input für Keywords wie "Melta X", "Anti-X Y+", etc. -->
                    <div id="weaponKeywordParameters" style="margin-top: 10px; display: none;">
                        <div class="keyword-parameter-inputs"></div>
                    </div>
                </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="addWeapon()">Waffe hinzufügen</button>
                        <button class="btn" onclick="clearWeaponForm()">Formular leeren</button>
                    </div>
                </div>
            </div>

            <!-- Verteidiger Panel -->
            <div class="panel">
                <h2><span class="material-icons">shield</span>Verteidiger verwalten</h2>
                
                <div class="form-group">
                    <label>Gruppen-Name (z.B. "Space Marine Squad"):</label>
                    <input type="text" id="defenderGroupName" placeholder="z.B. Space Marine Squad">
                </div>
                
                <div class="form-group">
                    <label>Name des Verteidigers:</label>
                    <input type="text" id="defenderName" placeholder="z.B. Sergeant, Marine">
                </div>

                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 10px;">
                        <input type="checkbox" id="defenderIsLeader" style="margin: 0;">
                        <span>🎖️ Leader (erhält Schaden zuletzt)</span>
                    </label>
                </div>

                <div class="form-group">
                    <label>Anzahl Modelle:</label>
                    <input type="number" id="defenderModels" value="10" min="1">
                </div>

                <div class="form-group">
                    <label>Toughness:</label>
                    <input type="number" id="defenderToughness" value="4" min="1" max="12">
                </div>

                <div class="form-group">
                    <label>Wounds pro Modell:</label>
                    <input type="number" id="defenderWounds" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>Save (Armor Save):</label>
                    <input type="number" id="defenderSave" value="6" min="2" max="7">
                </div>
                <div class="form-group">
                    <label>Invulnerable Save (leer lassen wenn nicht vorhanden):</label>
                    <input type="number" id="defenderInvul" min="2" max="6" placeholder="z.B. 5">
                </div>

                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="defenderKeywordInput" placeholder="Keyword eingeben oder aus Liste wählen">
                        <button class="btn btn-small" onclick="addDefenderKeyword()">+</button>
                        <button class="btn btn-small" onclick="showKeywordSelector('defender')" title="Aus Keyword-Liste auswählen">📋</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="defenderKeywords"></div>
                    
                    <!-- Parameter-Input für Keywords -->
                    <div id="defenderKeywordParameters" style="margin-top: 10px; display: none;">
                        <div class="keyword-parameter-inputs"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addDefender()">Verteidiger hinzufügen</button>
                </div>

                <div class="unit-list" id="defendersList"></div>
            </div>
        </div>

        <!-- Simulation starten -->
        <div class="panel simulation-start-panel">
            <h2>🚀 Simulation starten</h2>
            <div class="simulation-final-controls">
                <p>Alle Angreifer und Verteidiger sind konfiguriert? Dann kann die Simulation gestartet werden!</p>
                <button class="btn btn-primary btn-large" onclick="runSimulation()" style="font-size: 1.2rem; padding: 15px 30px;">
                    ⚔️ Simulation starten
                </button>
            </div>
        </div>

        <!-- Ergebnisse Panel -->
        <div class="panel results-panel" id="resultsPanel" style="display: none;">
            <h2>📊 Simulationsergebnisse</h2>
            <div class="results-grid" id="resultsContainer"></div>
            
            <!-- Export Button am Ende der Ergebnisse -->
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="exportResultsToPDF()">📄 PDF-Report erstellen</button>
                <button class="btn btn-secondary" onclick="exportResultsToJson()">📄 JSON exportieren</button>
            </div>
        </div>
    </div>

    <!-- Keyword Help Modal -->
    <div id="keywordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordHelp()">&times;</span>
            <h2>📖 Keyword-Referenz</h2>
            <div class="keyword-reference">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-grid" id="modalStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-grid" id="modalCustomKeywords"></div>
            </div>
        </div>
    </div>

    <!-- Keyword Selector Modal -->
    <div id="keywordSelectorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordSelector()">&times;</span>
            <h2>🔖 Keywords auswählen</h2>
            <div class="keyword-selector">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-selection-grid" id="selectorStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-selection-grid" id="selectorCustomKeywords"></div>
            </div>
        </div>
    </div>

    <script>
        // ===== ENHANCED GLOBAL VARIABLES & STATE MANAGEMENT =====
        let weaponsData = [];
        let defendersData = [];
        let selectedWeapons = [];
        let selectedDefenders = [];
        let currentResults = null;

        // Accessibility & UX Enhancement Functions
        function announceToScreenReader(message) {
            const announcement = document.createElement('div');
            announcement.setAttribute('aria-live', 'polite');
            announcement.setAttribute('aria-atomic', 'true');
            announcement.className = 'sr-only';
            announcement.textContent = message;
            document.body.appendChild(announcement);
            
            setTimeout(() => {
                document.body.removeChild(announcement);
            }, 1000);
        }

        function showErrorToast(message) {
            const toast = document.getElementById('error-toast');
            const messageElement = document.getElementById('error-message');
            messageElement.textContent = message;
            toast.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideErrorToast();
            }, 5000);
            
            announceToScreenReader(`Fehler: ${message}`);
        }

        function hideErrorToast() {
            const toast = document.getElementById('error-toast');
            toast.style.display = 'none';
        }

        function showLoadingOverlay(message = 'Wird geladen...') {
            const overlay = document.getElementById('loading-overlay');
            const progressElement = document.getElementById('loading-progress');
            progressElement.textContent = message;
            overlay.style.display = 'flex';
            
            // Focus management
            const previousFocus = document.activeElement;
            overlay.setAttribute('data-previous-focus', previousFocus.id || '');
            overlay.focus();
        }

        function hideLoadingOverlay() {
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'none';
            
            // Restore focus
            const previousFocusId = overlay.getAttribute('data-previous-focus');
            if (previousFocusId) {
                const previousElement = document.getElementById(previousFocusId);
                if (previousElement) {
                    previousElement.focus();
                }
            }
        }

        function updateSimulateButtonState() {
            const btn = document.getElementById('simulate-btn');
            const hasWeapons = selectedWeapons.length > 0;
            const hasDefenders = selectedDefenders.length > 0;
            
            btn.disabled = !(hasWeapons && hasDefenders);
            
            if (btn.disabled) {
                btn.setAttribute('aria-describedby', 'simulate-help');
            } else {
                btn.removeAttribute('aria-describedby');
            }
        }

        // ===== ENHANCED FILE LOADING WITH ACCESSIBILITY =====
        async function loadWeapons(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoadingOverlay('Lade Waffendaten...');
            
            try {
                const text = await file.text();
                weaponsData = JSON.parse(text);
                
                if (!Array.isArray(weaponsData) || weaponsData.length === 0) {
                    throw new Error('Ungültige Waffendatei: Keine Waffen gefunden');
                }

                populateWeaponSelect();
                announceToScreenReader(`${weaponsData.length} Waffen erfolgreich geladen`);
                
            } catch (error) {
                console.error('Error loading weapons:', error);
                showErrorToast(`Fehler beim Laden der Waffendatei: ${error.message}`);
                weaponsData = [];
            } finally {
                hideLoadingOverlay();
                updateSimulateButtonState();
            }
        }

        async function loadDefenders(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoadingOverlay('Lade Verteidigerdaten...');
            
            try {
                const text = await file.text();
                defendersData = JSON.parse(text);
                
                if (!Array.isArray(defendersData) || defendersData.length === 0) {
                    throw new Error('Ungültige Verteidigerdatei: Keine Verteidiger gefunden');
                }

                populateDefenderSelect();
                announceToScreenReader(`${defendersData.length} Verteidiger erfolgreich geladen`);
                
            } catch (error) {
                console.error('Error loading defenders:', error);
                showErrorToast(`Fehler beim Laden der Verteidigerdatei: ${error.message}`);
                defendersData = [];
            } finally {
                hideLoadingOverlay();
                updateSimulateButtonState();
            }
        }

        function populateWeaponSelect() {
            const select = document.getElementById('weapon-select');
            select.innerHTML = '<option value="">-- Waffe auswählen --</option>';
            
            weaponsData.forEach((weapon, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = weapon.name || `Waffe ${index + 1}`;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        function populateDefenderSelect() {
            const select = document.getElementById('defender-select');
            select.innerHTML = '<option value="">-- Verteidiger auswählen --</option>';
            
            defendersData.forEach((defender, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = defender.name || `Verteidiger ${index + 1}`;
                select.appendChild(option);
            });
            
            select.disabled = false;
        }

        // ===== ENHANCED SELECTION FUNCTIONS =====
        function selectWeapon() {
            const select = document.getElementById('weapon-select');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') return;
            
            const weapon = weaponsData[selectedIndex];
            if (!weapon) return;
            
            // Check if already selected
            if (selectedWeapons.find(w => w.name === weapon.name)) {
                showErrorToast('Diese Waffe ist bereits ausgewählt');
                select.value = '';
                return;
            }
            
            selectedWeapons.push({ ...weapon, id: Date.now() });
            updateSelectedWeaponsDisplay();
            updateSimulateButtonState();
            select.value = '';
            
            announceToScreenReader(`Waffe ${weapon.name} hinzugefügt`);
        }

        function selectDefender() {
            const select = document.getElementById('defender-select');
            const selectedIndex = select.value;
            
            if (selectedIndex === '') return;
            
            const defender = defendersData[selectedIndex];
            if (!defender) return;
            
            // Check if already selected
            if (selectedDefenders.find(d => d.name === defender.name)) {
                showErrorToast('Dieser Verteidiger ist bereits ausgewählt');
                select.value = '';
                return;
            }
            
            selectedDefenders.push({ ...defender, id: Date.now() });
            updateSelectedDefendersDisplay();
            updateSimulateButtonState();
            select.value = '';
            
            announceToScreenReader(`Verteidiger ${defender.name} hinzugefügt`);
        }

        function updateSelectedWeaponsDisplay() {
            const container = document.getElementById('selected-weapons');
            container.innerHTML = '';
            
            selectedWeapons.forEach(weapon => {
                const weaponCard = createWeaponCard(weapon);
                container.appendChild(weaponCard);
            });
        }

        function updateSelectedDefendersDisplay() {
            const container = document.getElementById('selected-defenders');
            container.innerHTML = '';
            
            selectedDefenders.forEach(defender => {
                const defenderCard = createDefenderCard(defender);
                container.appendChild(defenderCard);
            });
        }

        function createWeaponCard(weapon) {
            const card = document.createElement('div');
            card.className = 'weapon-card';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-labelledby', `weapon-title-${weapon.id}`);
            
            card.innerHTML = `
                <div class="weapon-card-header">
                    <h4 id="weapon-title-${weapon.id}" class="weapon-name">${weapon.name}</h4>
                    <button 
                        class="btn btn-icon btn-danger"
                        onclick="removeWeapon(${weapon.id})"
                        aria-label="Waffe ${weapon.name} entfernen"
                        title="Waffe entfernen"
                    >
                        <i class="material-icons" aria-hidden="true">delete</i>
                    </button>
                </div>
                <div class="weapon-stats">
                    ${createStatsDisplay(weapon)}
                </div>
                ${weapon.keywords ? `<div class="weapon-keywords">${createKeywordTags(weapon.keywords)}</div>` : ''}
            `;
            
            return card;
        }

        function createDefenderCard(defender) {
            const card = document.createElement('div');
            card.className = 'defender-card';
            card.setAttribute('role', 'article');
            card.setAttribute('aria-labelledby', `defender-title-${defender.id}`);
            
            card.innerHTML = `
                <div class="defender-card-header">
                    <h4 id="defender-title-${defender.id}" class="defender-name">${defender.name}</h4>
                    <button 
                        class="btn btn-icon btn-danger"
                        onclick="removeDefender(${defender.id})"
                        aria-label="Verteidiger ${defender.name} entfernen"
                        title="Verteidiger entfernen"
                    >
                        <i class="material-icons" aria-hidden="true">delete</i>
                    </button>
                </div>
                <div class="defender-stats">
                    ${createStatsDisplay(defender)}
                </div>
                ${defender.keywords ? `<div class="defender-keywords">${createKeywordTags(defender.keywords)}</div>` : ''}
            `;
            
            return card;
        }

        function removeWeapon(weaponId) {
            const weapon = selectedWeapons.find(w => w.id === weaponId);
            if (!weapon) return;
            
            selectedWeapons = selectedWeapons.filter(w => w.id !== weaponId);
            updateSelectedWeaponsDisplay();
            updateSimulateButtonState();
            
            announceToScreenReader(`Waffe ${weapon.name} entfernt`);
        }

        function removeDefender(defenderId) {
            const defender = selectedDefenders.find(d => d.id === defenderId);
            if (!defender) return;
            
            selectedDefenders = selectedDefenders.filter(d => d.id !== defenderId);
            updateSelectedDefendersDisplay();
            updateSimulateButtonState();
            
            announceToScreenReader(`Verteidiger ${defender.name} entfernt`);
        }

        function createStatsDisplay(unit) {
            const stats = [];
            
            // Common stats to display
            const statKeys = ['attacks', 'skill', 'strength', 'damage', 'ap', 'toughness', 'wounds', 'save'];
            
            statKeys.forEach(key => {
                if (unit[key] !== undefined) {
                    const label = getStatLabel(key);
                    stats.push(`<span class="stat-item"><strong>${label}:</strong> ${unit[key]}</span>`);
                }
            });
            
            return `<div class="stats-grid">${stats.join('')}</div>`;
        }

        function getStatLabel(key) {
            const labels = {
                'attacks': 'Angriffe',
                'skill': 'Fertigkeit',
                'strength': 'Stärke',
                'damage': 'Schaden',
                'ap': 'AP',
                'toughness': 'Widerstandskraft',
                'wounds': 'Lebenspunkte',
                'save': 'Rettungswurf'
            };
            return labels[key] || key;
        }

        function createKeywordTags(keywords) {
            if (!keywords || keywords.length === 0) return '';
            
            return keywords.map(keyword => {
                const type = getKeywordType(keyword);
                return `<span class="keyword-tag" data-type="${type}" title="${keyword}">${keyword}</span>`;
            }).join('');
        }

        function getKeywordType(keyword) {
            const lowerKeyword = keyword.toLowerCase();
            
            if (lowerKeyword.includes('damage') || lowerKeyword.includes('wound')) {
                return 'damage';
            } else if (lowerKeyword.includes('hit') || lowerKeyword.includes('accuracy')) {
                return 'accuracy';
            } else {
                return 'special';
            }
        }

        // ===== ENHANCED SIMULATION ENGINE =====
        async function runSimulation() {
            if (selectedWeapons.length === 0 || selectedDefenders.length === 0) {
                showErrorToast('Bitte wählen Sie mindestens eine Waffe und einen Verteidiger aus');
                return;
            }

            const iterations = parseInt(document.getElementById('iterations').value) || 10000;
            
            if (iterations < 100 || iterations > 1000000) {
                showErrorToast('Anzahl Simulationen muss zwischen 100 und 1.000.000 liegen');
                return;
            }

            showLoadingOverlay('Führe Kampfsimulation durch...');
            
            try {
                // Run simulation in chunks to prevent UI blocking
                const results = await runSimulationAsync(selectedWeapons, selectedDefenders, iterations);
                currentResults = results;
                
                displayResults(results);
                
                // Auto-export if requested
                const shouldExportPDF = document.getElementById('export-pdf').checked;
                if (shouldExportPDF) {
                    await exportToPDF();
                }
                
                announceToScreenReader('Simulation erfolgreich abgeschlossen');
                
            } catch (error) {
                console.error('Simulation error:', error);
                showErrorToast(`Fehler bei der Simulation: ${error.message}`);
            } finally {
                hideLoadingOverlay();
            }
        }

        async function runSimulationAsync(weapons, defenders, iterations) {
            const results = {
                weapons: weapons,
                defenders: defenders,
                iterations: iterations,
                timestamp: new Date().toISOString(),
                combatResults: []
            };

            const chunkSize = Math.min(1000, Math.floor(iterations / 10));
            let completedIterations = 0;

            for (let weaponIndex = 0; weaponIndex < weapons.length; weaponIndex++) {
                const weapon = weapons[weaponIndex];
                results.combatResults[weaponIndex] = {
                    weapon: weapon,
                    defenderResults: []
                };

                for (let defenderIndex = 0; defenderIndex < defenders.length; defenderIndex++) {
                    const defender = defenders[defenderIndex];
                    const defenderResult = {
                        defender: defender,
                        totalDamage: 0,
                        averageDamage: 0,
                        damageDistribution: {},
                        killProbability: 0,
                        hits: 0,
                        wounds: 0,
                        saves: 0,
                        totalKills: 0
                    };

                    // Run simulation in chunks
                    for (let chunk = 0; chunk < iterations; chunk += chunkSize) {
                        const currentChunkSize = Math.min(chunkSize, iterations - chunk);
                        
                        for (let i = 0; i < currentChunkSize; i++) {
                            const result = simulateCombat(weapon, defender);
                            defenderResult.totalDamage += result.damage;
                            defenderResult.hits += result.hits;
                            defenderResult.wounds += result.wounds;
                            defenderResult.saves += result.saves;
                            
                            if (result.damage >= defender.wounds) {
                                defenderResult.totalKills++;
                            }

                            // Track damage distribution
                            const damageKey = result.damage.toString();
                            defenderResult.damageDistribution[damageKey] = 
                                (defenderResult.damageDistribution[damageKey] || 0) + 1;
                        }

                        completedIterations += currentChunkSize;
                        
                        // Update progress
                        const progress = Math.round((completedIterations / (iterations * weapons.length * defenders.length)) * 100);
                        const progressElement = document.getElementById('loading-progress');
                        if (progressElement) {
                            progressElement.textContent = `Simulation läuft... ${progress}%`;
                        }

                        // Allow UI to update
                        if (chunk % (chunkSize * 5) === 0) {
                            await new Promise(resolve => setTimeout(resolve, 1));
                        }
                    }

                    // Calculate statistics
                    defenderResult.averageDamage = defenderResult.totalDamage / iterations;
                    defenderResult.killProbability = defenderResult.totalKills / iterations;
                    defenderResult.averageHits = defenderResult.hits / iterations;
                    defenderResult.averageWounds = defenderResult.wounds / iterations;
                    defenderResult.averageSaves = defenderResult.saves / iterations;

                    results.combatResults[weaponIndex].defenderResults.push(defenderResult);
                }
            }

            return results;
        }

        function simulateCombat(weapon, defender) {
            const result = {
                hits: 0,
                wounds: 0,
                saves: 0,
                damage: 0
            };

            const attacks = parseStatValue(weapon.attacks);
            const skill = parseStatValue(weapon.skill);
            const strength = parseStatValue(weapon.strength);
            const damage = parseStatValue(weapon.damage);
            const ap = parseStatValue(weapon.ap) || 0;
            
            const toughness = parseStatValue(defender.toughness);
            const save = parseStatValue(defender.save);
            const wounds = parseStatValue(defender.wounds);

            // Hit rolls
            for (let i = 0; i < attacks; i++) {
                const hitRoll = rollD6();
                if (hitRoll >= skill) {
                    result.hits++;
                    
                    // Wound rolls
                    const woundTarget = calculateWoundTarget(strength, toughness);
                    const woundRoll = rollD6();
                    if (woundRoll >= woundTarget) {
                        result.wounds++;
                        
                        // Save rolls
                        const modifiedSave = Math.max(save + ap, 7); // 7+ means no save
                        if (modifiedSave <= 6) {
                            const saveRoll = rollD6();
                            if (saveRoll >= modifiedSave) {
                                result.saves++;
                            } else {
                                // Damage applied
                                result.damage += damage;
                            }
                        } else {
                            // No save possible
                            result.damage += damage;
                        }
                    }
                }
            }

            return result;
        }

        function parseStatValue(stat) {
            if (typeof stat === 'number') return stat;
            if (typeof stat === 'string') {
                // Handle dice notation like "2D6", "D3", etc.
                if (stat.includes('D') || stat.includes('d')) {
                    return rollDice(stat);
                }
                // Handle ranges like "2-6"
                if (stat.includes('-')) {
                    const [min, max] = stat.split('-').map(Number);
                    return Math.floor(Math.random() * (max - min + 1)) + min;
                }
                // Handle simple numbers with +
                return parseInt(stat.replace('+', '')) || 0;
            }
            return 0;
        }

        function rollDice(notation) {
            const lowerNotation = notation.toLowerCase();
            
            if (lowerNotation === 'd3') {
                return Math.floor(Math.random() * 3) + 1;
            }
            
            if (lowerNotation === 'd6') {
                return rollD6();
            }
            
            // Handle XdY notation
            const match = lowerNotation.match(/(\d*)d(\d+)/);
            if (match) {
                const count = parseInt(match[1]) || 1;
                const sides = parseInt(match[2]);
                let total = 0;
                for (let i = 0; i < count; i++) {
                    total += Math.floor(Math.random() * sides) + 1;
                }
                return total;
            }
            
            return 1;
        }

        function rollD6() {
            return Math.floor(Math.random() * 6) + 1;
        }

        function calculateWoundTarget(strength, toughness) {
            if (strength >= toughness * 2) return 2;
            if (strength > toughness) return 3;
            if (strength === toughness) return 4;
            if (strength * 2 <= toughness) return 6;
            return 5;
        }

        // ===== ENHANCED RESULTS DISPLAY =====
        function displayResults(results) {
            const resultsSection = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = createResultsHTML(results);
            resultsSection.style.display = 'block';
            
            // Scroll to results
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Focus management
            const firstResult = resultsContent.querySelector('h3');
            if (firstResult) {
                firstResult.focus();
            }
        }

        function createResultsHTML(results) {
            let html = `
                <div class="results-header">
                    <div class="results-meta">
                        <p><strong>Simulationen:</strong> ${results.iterations.toLocaleString()}</p>
                        <p><strong>Zeitstempel:</strong> ${new Date(results.timestamp).toLocaleString()}</p>
                        <p><strong>Waffen:</strong> ${results.weapons.length}</p>
                        <p><strong>Verteidiger:</strong> ${results.defenders.length}</p>
                    </div>
                </div>
            `;

            results.combatResults.forEach((weaponResult, weaponIndex) => {
                const weapon = weaponResult.weapon;
                const cleanWeaponName = cleanWeaponName ? cleanWeaponName(weapon.name) : weapon.name;
                
                html += `
                    <div class="result-weapon-section">
                        <h3 class="result-weapon-title" tabindex="0">
                            <i class="material-icons" aria-hidden="true">gps_fixed</i>
                            ${cleanWeaponName}
                        </h3>
                        
                        <div class="result-defenders">
                `;

                weaponResult.defenderResults.forEach((defenderResult, defenderIndex) => {
                    const defender = defenderResult.defender;
                    
                    html += `
                        <div class="result-defender-card">
                            <h4 class="result-defender-title">
                                <i class="material-icons" aria-hidden="true">shield</i>
                                vs ${defender.name}
                            </h4>
                            
                            <div class="result-stats-grid">
                                <div class="result-stat">
                                    <span class="stat-label">Durchschnittlicher Schaden</span>
                                    <span class="stat-value primary">${defenderResult.averageDamage.toFixed(2)}</span>
                                </div>
                                
                                <div class="result-stat">
                                    <span class="stat-label">Tötungswahrscheinlichkeit</span>
                                    <span class="stat-value ${defenderResult.killProbability > 0.5 ? 'success' : 'warning'}">
                                        ${(defenderResult.killProbability * 100).toFixed(1)}%
                                    </span>
                                </div>
                                
                                <div class="result-stat">
                                    <span class="stat-label">Durchschnittliche Treffer</span>
                                    <span class="stat-value">${defenderResult.averageHits.toFixed(2)}</span>
                                </div>
                                
                                <div class="result-stat">
                                    <span class="stat-label">Durchschnittliche Verwundungen</span>
                                    <span class="stat-value">${defenderResult.averageWounds.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            ${createDamageDistributionChart(defenderResult.damageDistribution, results.iterations)}
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;
            });

            return html;
        }

        function createDamageDistributionChart(distribution, totalIterations) {
            const maxDamage = Math.max(...Object.keys(distribution).map(Number));
            let chartHTML = '<div class="damage-distribution"><h5>Schadensverteilung</h5><div class="chart-container">';
            
            for (let i = 0; i <= maxDamage; i++) {
                const count = distribution[i.toString()] || 0;
                const percentage = ((count / totalIterations) * 100).toFixed(1);
                const barHeight = (count / totalIterations) * 100;
                
                chartHTML += `
                    <div class="chart-bar" style="height: ${barHeight}%" title="${i} Schaden: ${percentage}% (${count.toLocaleString()})">
                        <span class="bar-label">${i}</span>
                        <span class="bar-percentage">${percentage}%</span>
                    </div>
                `;
            }
            
            chartHTML += '</div></div>';
            return chartHTML;
        }

        // ===== PDF EXPORT ENHANCEMENT =====
        async function exportToPDF() {
            if (!currentResults) {
                showErrorToast('Keine Ergebnisse zum Exportieren verfügbar');
                return;
            }

            showLoadingOverlay('Erstelle PDF...');
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // PDF content generation
                await generatePDFContent(doc, currentResults);
                
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `warhammer40k-simulation-${timestamp}.pdf`;
                
                doc.save(filename);
                announceToScreenReader('PDF erfolgreich exportiert');
                
            } catch (error) {
                console.error('PDF export error:', error);
                showErrorToast(`Fehler beim PDF-Export: ${error.message}`);
            } finally {
                hideLoadingOverlay();
            }
        }

        async function generatePDFContent(doc, results) {
            let yPosition = 20;
            
            // Title
            doc.setFontSize(20);
            doc.text('Warhammer 40k Combat Simulation', 20, yPosition);
            yPosition += 20;
            
            // Meta information
            doc.setFontSize(12);
            doc.text(`Datum: ${new Date(results.timestamp).toLocaleString()}`, 20, yPosition);
            yPosition += 10;
            doc.text(`Simulationen: ${results.iterations.toLocaleString()}`, 20, yPosition);
            yPosition += 20;
            
            // Results
            results.combatResults.forEach(weaponResult => {
                const weapon = weaponResult.weapon;
                const cleanName = cleanWeaponName ? cleanWeaponName(weapon.name) : weapon.name;
                
                // Check page space
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                doc.setFontSize(16);
                doc.text(`Waffe: ${cleanName}`, 20, yPosition);
                yPosition += 15;
                
                weaponResult.defenderResults.forEach(defenderResult => {
                    if (yPosition > 240) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    
                    doc.setFontSize(14);
                    doc.text(`vs ${defenderResult.defender.name}`, 30, yPosition);
                    yPosition += 10;
                    
                    doc.setFontSize(10);
                    doc.text(`Durchschnittlicher Schaden: ${defenderResult.averageDamage.toFixed(2)}`, 30, yPosition);
                    yPosition += 8;
                    doc.text(`Tötungswahrscheinlichkeit: ${(defenderResult.killProbability * 100).toFixed(1)}%`, 30, yPosition);
                    yPosition += 8;
                    doc.text(`Durchschnittliche Treffer: ${defenderResult.averageHits.toFixed(2)}`, 30, yPosition);
                    yPosition += 8;
                    doc.text(`Durchschnittliche Verwundungen: ${defenderResult.averageWounds.toFixed(2)}`, 30, yPosition);
                    yPosition += 15;
                });
            });
        }

        // ===== UTILITY FUNCTIONS =====
        function clearResults() {
            const resultsSection = document.getElementById('results');
            const resultsContent = document.getElementById('results-content');
            
            resultsContent.innerHTML = '';
            resultsSection.style.display = 'none';
            currentResults = null;
            
            announceToScreenReader('Ergebnisse gelöscht');
        }

        // Clean weapon names (remove nested parentheses)
        function cleanWeaponName(name) {
            if (!name) return name;
            
            // Remove nested parentheses and clean up
            let cleaned = name;
            
            // Remove content within parentheses that contain other parentheses
            cleaned = cleaned.replace(/\([^()]*\([^()]*\)[^()]*\)/g, '');
            
            // Clean up multiple spaces and trim
            cleaned = cleaned.replace(/\s+/g, ' ').trim();
            
            return cleaned;
        }

        // ===== KEYBOARD NAVIGATION ENHANCEMENT =====
        document.addEventListener('keydown', function(event) {
            // ESC key handling
            if (event.key === 'Escape') {
                // Close loading overlay
                const loadingOverlay = document.getElementById('loading-overlay');
                if (loadingOverlay.style.display !== 'none') {
                    hideLoadingOverlay();
                    return;
                }
                
                // Close error toast
                const errorToast = document.getElementById('error-toast');
                if (errorToast.style.display !== 'none') {
                    hideErrorToast();
                    return;
                }
            }
            
            // Enter key for simulation
            if (event.key === 'Enter' && event.target.id === 'simulate-btn') {
                runSimulation();
            }
        });

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize tooltips and accessibility features
            updateSimulateButtonState();
            
            // Set focus to first interactive element
            const firstInput = document.getElementById('weapon-upload');
            if (firstInput) {
                firstInput.focus();
            }
            
            announceToScreenReader('Warhammer 40k Combat Simulator geladen');
        });
    </script>
        // Einfacher Test ohne Module
        console.log('Basic script loading...');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            document.body.style.backgroundColor = 'red'; // Visueller Test
        });
    </script>
    
    <script type="module">
        import { Dice } from './src/scripts/dice.js';
        import { Attacker, Defender, Weapon } from './src/scripts/units.js';
        import run from './src/scripts/w40k.js';

        console.log('Scripts loaded successfully');
        console.log('run function:', typeof run);
        console.log('Dice class:', typeof Dice);
        console.log('Attacker class:', typeof Attacker);
        
        // Test basic functionality
        try {
            const testDice = new Dice();
            console.log('Dice test roll:', testDice.roll());
        } catch (error) {
            console.error('Error testing modules:', error);
            alert('Fehler beim Testen der JavaScript-Module: ' + error.message);
        }

        // Globale Variablen
        window.attackers = [];
        window.defenders = [];
        window.simulationResults = [];
        window.currentWeaponKeywords = [];
        window.currentDefenderKeywords = [];

        // Mache run-Funktion global verfügbar
        window.runCombatSimulation = run;
        
        // Mache auch die Klassen global verfügbar für Debug-Zwecke
        window.Weapon = Weapon;
        window.Attacker = Attacker;
        window.Defender = Defender;
        window.Dice = Dice;

        // Migration: Stelle sicher, dass alle Angreifer-Mitglieder ein Weapons-Array haben
        function migrateAttackerData() {
            window.attackers.forEach(group => {
                // Migriere alte Struktur mit Waffen auf Gruppen-Ebene
                if (group.Weapons && !group.Members.some(m => m.Weapons)) {
                    // Teile Waffen auf alle Mitglieder auf (alte Struktur)
                    group.Members.forEach(member => {
                        if (!member.Weapons) {
                            member.Weapons = [...group.Weapons];
                        }
                    });
                    delete group.Weapons; // Entferne alte Waffen-Referenz
                }
                
                // Stelle sicher, dass alle Mitglieder ein Weapons-Array haben
                group.Members.forEach(member => {
                    if (!member.Weapons) {
                        member.Weapons = [];
                    }
                });
            });
        }

        // Collapsible-Funktionalität
        window.toggleCollapsible = function(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            const icon = element.querySelector('.toggle-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                if (icon) icon.textContent = '▼';
            } else {
                content.classList.add('active');
                if (icon) icon.textContent = '▲';
            }
        };

        // Keyword-Definitionen
        const standardKeywords = {
            'lethal hits': 'Critical hits automatisch verwunden (case-insensitive)',
            'sustained hits X': 'Critical hits erzeugen X zusätzliche Hits (X kann Zahl oder Würfel sein, case-insensitive)',
            'devastating wounds': 'Critical wounds ignorieren alle Saves (case-insensitive)',
            'anti-KEYWORD X+': 'Gegen Units mit KEYWORD: Critical wounds bei X+ (z.B. "anti-vehicle 5" oder "anti-infantry 4+", case-insensitive)',
            'twin-linked': 'Reroll alle failed wound rolls (case-insensitive)',
            'rapid fire X': 'Bei Range ≤ Hälfte: +X Attacks (case-insensitive)',
            'blast': '+1 Attack pro 5 Modelle im Ziel (1-4=+0, 5-9=+1, 10-14=+2, etc., case-insensitive)',
            'hazardous': 'Bei Critical Fails: 1 Mortal Wound (case-insensitive, implementiert)',
            'lance': 'Charge: +1 to wound, +1 AP (case-insensitive)',
            'precision': 'Critical hits können Charaktere zuweisen (case-insensitive, implementiert)',
            'torrent': 'Automatische Hits, keine Hit-Würfe erforderlich (case-insensitive, implementiert)',
            'ignores cover': 'Umgeht Cover-Save Bonus des Ziels (case-insensitive, implementiert)',
            'indirect fire': '-1 to hit, maximal 4+ to hit (case-insensitive, implementiert)',
            'psychic': 'Kann durch Deny the Witch gestoppt werden (case-insensitive, implementiert)',
            'melta X': 'Bei Range ≤ Hälfte: +X Damage (case-insensitive, benötigt Parameter X)',
            '+1 to hit': 'Verbessert Hit-Würfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to hit': 'Verschlechtert Hit-Würfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)',
            '+1 to wound': 'Verbessert Wound-Würfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to wound': 'Verschlechtert Wound-Würfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)'
        };

        const customKeywords = {
            'RH1': 'Reroll 1s beim Hit-Wurf',
            'RW1': 'Reroll 1s beim Wound-Wurf',
            'RHMiss': 'Reroll alle fehlgeschlagenen Hit-Würfe',
            'RWMiss': 'Reroll alle fehlgeschlagenen Wound-Würfe',
            'RHNoCrit': 'Reroll alle Hit-Würfe die keine Critical Hits sind',
            'RWNoCrit': 'Reroll alle Wound-Würfe die keine Critical Wounds sind',
            'CritHitX': 'Critical Hits bei X+ statt 6+ (z.B. CritHit5+)',
            'CritWoundX': 'Critical Wounds bei X+ statt 6+ (z.B. CritWound4+)',
            'KnightHitReroll': '1x Hit Reroll pro Model (Knights)',
            'KnightWoundReroll': '1x Wound Reroll pro Model (Knights)',
            'KnightDamageReroll': '1x Damage Reroll pro Model (Knights)',
            'RerollDamageLow3': 'Reroll Damage wenn <3',
            '+1D': 'Erhöht ausgehenden Schaden um 1 (case-insensitive)',
            '-1D': 'Reduziert eingehenden Schaden um 1 (minimum 1, case-insensitive)',
            '/2D': 'Halbiert eingehenden Schaden (minimum 1, abgerundet, case-insensitive)',
            'feel no pain X': 'Ignoriert Schaden bei X+ auf 1W6 (z.B. "feel no pain 6", case-insensitive)',
            'feel no pain psychic X': 'Ignoriert Psychic Schaden bei X+ auf 1W6 (case-insensitive)',
            'cover': '+1 Save (außer gegen "ignores cover" Weapons, case-insensitive)',
            '-1 wound when stronger': 'Wenn Stärke > Toughness: -1 to wound (case-insensitive)'
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            populateKeywordModal();
            updateAttackerSelect();
            migrateAttackerData(); // Migration der Angreifer-Daten
            
            // Sicherstellen, dass der Loading-Spinner beim Start versteckt ist
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.classList.remove('active');
            }
        });

        // Utility Functions für UI-Feedback
        window.showError = function(message) {
            console.error(message);
            alert('Fehler: ' + message);
        };

        window.showSuccess = function(message) {
            console.log(message);
            // Temporärer visueller Indikator (könnte später durch Toast-Nachricht ersetzt werden)
            const tempDiv = document.createElement('div');
            tempDiv.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: linear-gradient(45deg, #28a745, #20c997); 
                color: white; padding: 10px 15px; border-radius: 5px; 
                z-index: 10000; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            `;
            tempDiv.textContent = message;
            document.body.appendChild(tempDiv);
            
            setTimeout(() => {
                if (tempDiv.parentNode) {
                    tempDiv.parentNode.removeChild(tempDiv);
                }
            }, 3000);
        };

        // Keyword Modal Functions
        window.showKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'block';
        };

        window.closeKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'none';
        };

        // Keyword Selector Functions
        let currentKeywordTarget = null; // 'weapon' or 'defender'

        window.showKeywordSelector = function(target) {
            currentKeywordTarget = target;
            populateKeywordSelector();
            document.getElementById('keywordSelectorModal').style.display = 'block';
        };

        window.closeKeywordSelector = function() {
            document.getElementById('keywordSelectorModal').style.display = 'none';
            currentKeywordTarget = null;
        };

        function populateKeywordSelector() {
            const standardContainer = document.getElementById('selectorStandardKeywords');
            const customContainer = document.getElementById('selectorCustomKeywords');
            
            // Clear existing content
            standardContainer.innerHTML = '';
            customContainer.innerHTML = '';

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-selection-item';
                keywordElement.onclick = () => selectKeyword(keyword);
                keywordElement.innerHTML = `
                    <div class="keyword-selection-name">${keyword}</div>
                    <div class="keyword-selection-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-selection-item';
                keywordElement.onclick = () => selectKeyword(keyword);
                keywordElement.innerHTML = `
                    <div class="keyword-selection-name">${keyword}</div>
                    <div class="keyword-selection-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        function selectKeyword(keyword) {
            if (currentKeywordTarget === 'weapon') {
                if (!window.currentWeaponKeywords.includes(keyword)) {
                    window.currentWeaponKeywords.push(keyword);
                    updateWeaponKeywordsDisplay();
                }
            } else if (currentKeywordTarget === 'defender') {
                if (!window.currentDefenderKeywords.includes(keyword)) {
                    window.currentDefenderKeywords.push(keyword);
                    updateDefenderKeywordsDisplay();
                }
            }
            closeKeywordSelector();
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const keywordModal = document.getElementById('keywordModal');
            const selectorModal = document.getElementById('keywordSelectorModal');
            if (event.target == keywordModal) {
                keywordModal.style.display = 'none';
            }
            if (event.target == selectorModal) {
                selectorModal.style.display = 'none';
                currentKeywordTarget = null;
            }
        };

        // Keyword-Referenz im Modal anzeigen
        function populateKeywordModal() {
            const standardContainer = document.getElementById('modalStandardKeywords');
            const customContainer = document.getElementById('modalCustomKeywords');

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        // Angreifer hinzufügen
        window.addAttacker = function() {
            const groupName = document.getElementById('attackerGroupName').value.trim();
            const name = document.getElementById('attackerName').value.trim();
            const count = parseInt(document.getElementById('attackerCount').value) || 1;
            
            if (!groupName) {
                showError('Bitte geben Sie einen Gruppen-Namen ein.');
                return;
            }
            if (!name) {
                showError('Bitte geben Sie einen Namen für den Angreifer ein.');
                return;
            }

            // Prüfe ob Gruppe bereits existiert
            let group = window.attackers.find(g => g.GroupName === groupName);
            
            if (!group) {
                // Neue Gruppe erstellen
                group = {
                    GroupName: groupName,
                    Members: []
                    // Waffen sind jetzt bei den einzelnen Mitgliedern
                };
                window.attackers.push(group);
            }
            
            // Mitglied zur Gruppe hinzufügen
            const member = {
                Name: name,
                Count: count,
                Weapons: []  // Jedes Mitglied hat seine eigenen Waffen
            };
            
            group.Members.push(member);
            
            // Formular leeren
            document.getElementById('attackerGroupName').value = '';
            document.getElementById('attackerName').value = '';
            document.getElementById('attackerCount').value = '1';
            
            updateAttackersList();
            updateAttackerSelect();
            showSuccess(`${count}x ${name} wurde zur Gruppe "${groupName}" hinzugefügt.`);
        };

        // Verteidiger hinzufügen
        window.addDefender = function() {
            const groupName = document.getElementById('defenderGroupName').value.trim();
            const name = document.getElementById('defenderName').value.trim();
            const isLeader = document.getElementById('defenderIsLeader').checked;
            const models = parseInt(document.getElementById('defenderModels').value);
            const toughness = parseInt(document.getElementById('defenderToughness').value);
            const wounds = parseInt(document.getElementById('defenderWounds').value);
            const save = parseInt(document.getElementById('defenderSave').value);
            const invul = document.getElementById('defenderInvul').value;

            if (!groupName) {
                showError('Bitte geben Sie einen Gruppen-Namen ein.');
                return;
            }
            if (!name) {
                showError('Bitte geben Sie einen Namen für den Verteidiger ein.');
                return;
            }

            // Prüfe ob Gruppe bereits existiert
            let group = window.defenders.find(g => g.GroupName === groupName);
            
            if (!group) {
                // Neue Gruppe erstellen
                group = {
                    GroupName: groupName,
                    Members: []
                };
                window.defenders.push(group);
            }
            
            // Mitglied zur Gruppe hinzufügen
            const member = {
                Name: name,
                type: 'Infantry',
                isLeader: isLeader,
                models: models,
                toughness: toughness,
                wounds: wounds,
                save: save,
                invulnerable: invul ? parseInt(invul) : 7,
                Keywords: [...window.currentDefenderKeywords]
            };
            
            group.Members.push(member);

            clearDefenderForm();
            updateDefendersList();
            const leaderText = isLeader ? ' (Leader)' : '';
            showSuccess(`${models}x ${name}${leaderText} wurde zur Gruppe "${groupName}" hinzugefügt.`);
        };

        // Waffe hinzufügen
        window.addWeapon = function() {
            const attackerValue = document.getElementById('weaponAttackerSelect').value;
            const name = document.getElementById('weaponName').value.trim();
            const type = document.getElementById('weaponType').value;
            const attacks = document.getElementById('weaponAttacks').value.trim();
            const toHit = parseInt(document.getElementById('weaponToHit').value);
            const strength = parseInt(document.getElementById('weaponStrength').value);
            const ap = parseInt(document.getElementById('weaponAP').value);
            const damage = document.getElementById('weaponDamage').value.trim();
            const amount = parseInt(document.getElementById('weaponAmount').value) || 1;

            if (!attackerValue) {
                showError('Bitte wählen Sie einen Angreifer aus.');
                return;
            }

            if (!name) {
                showError('Bitte geben Sie einen Namen für die Waffe ein.');
                return;
            }

            // Parse groupIndex und memberIndex aus dem Wert "groupIndex-memberIndex"
            const [groupIndex, memberIndex] = attackerValue.split('-').map(i => parseInt(i));

            const weapon = {
                name: name,
                type: type,
                attacks: attacks,
                to_hit: toHit,
                strength: strength,
                ap: ap,
                damage: damage,
                amount: amount,
                Keywords: [...new Set(window.currentWeaponKeywords)] // Entferne Duplikate
            };

            // Waffe zum spezifischen Angreifer hinzufügen
            window.attackers[groupIndex].Members[memberIndex].Weapons.push(weapon);
            clearWeaponForm();
            updateAttackersList();
            
            // Waffen-Menü zuklappen nach dem Hinzufügen
            const weaponCollapsible = document.querySelector('button.collapsible');
            const weaponCollapsibles = document.querySelectorAll('button.collapsible');
            let weaponMenuCollapsible = null;
            
            weaponCollapsibles.forEach(collapsible => {
                if (collapsible.textContent.includes('Waffe hinzufügen')) {
                    weaponMenuCollapsible = collapsible;
                }
            });
            
            if (weaponMenuCollapsible && weaponMenuCollapsible.classList.contains('active')) {
                const weaponContent = weaponMenuCollapsible.nextElementSibling;
                weaponMenuCollapsible.classList.remove('active');
                weaponContent.classList.remove('active');
            }
            
            const attackerName = window.attackers[groupIndex].Members[memberIndex].Name;
            const groupName = window.attackers[groupIndex].GroupName;
            showSuccess(`Waffe "${name}" wurde zu ${attackerName} (${groupName}) hinzugefügt.`);
        };

        // Keyword-Funktionen
        window.addWeaponKeyword = function() {
            const input = document.getElementById('weaponKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentWeaponKeywords.includes(keyword)) {
                window.currentWeaponKeywords.push(keyword);
                input.value = '';
                updateWeaponKeywordsDisplay();
            }
        };

        window.addDefenderKeyword = function() {
            const input = document.getElementById('defenderKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentDefenderKeywords.includes(keyword)) {
                window.currentDefenderKeywords.push(keyword);
                input.value = '';
                updateDefenderKeywordsDisplay();
            }
        };

        // Form clearing functions
        window.clearWeaponForm = function() {
            document.getElementById('weaponAttackerSelect').value = '';
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponAmount').value = '1';
            document.getElementById('weaponType').value = 'Ranged';
            document.getElementById('weaponAttacks').value = '1';
            document.getElementById('weaponToHit').value = '4';
            document.getElementById('weaponStrength').value = '4';
            document.getElementById('weaponAP').value = '0';
            document.getElementById('weaponDamage').value = '1';
            document.getElementById('weaponKeywordInput').value = '';
            
            // Keywords leeren
            window.currentWeaponKeywords = [];
            updateWeaponKeywordsDisplay();
        };

        function clearDefenderForm() {
            document.getElementById('defenderGroupName').value = '';
            document.getElementById('defenderName').value = '';
            document.getElementById('defenderIsLeader').checked = false;
            document.getElementById('defenderModels').value = '1';
            document.getElementById('defenderToughness').value = '4';
            document.getElementById('defenderWounds').value = '1';
            document.getElementById('defenderSave').value = '3';
            document.getElementById('defenderInvul').value = '';
            document.getElementById('defenderKeywordInput').value = '';
            
            // Keywords leeren
            window.currentDefenderKeywords = [];
            updateDefenderKeywordsDisplay();
        };

        // Keywords mit Parametern (benötigen X-Werte)
        const parametricKeywords = {
            'melta': { pattern: /^melta\s*(\d+)?$/i, description: 'Bei Range ≤ Hälfte: +X Damage', paramName: 'Bonus-Damage' },
            'anti-': { pattern: /^anti-([^0-9]+)\s*(\d+)\+?$/i, description: 'Gegen KEYWORD: Critical wounds bei X+', paramName: 'Critical-Threshold' },
            'sustained hits': { pattern: /^sustained\s+hits\s*(\d+|d\d+)?$/i, description: 'Critical hits erzeugen X zusätzliche Hits', paramName: 'Extra-Hits' },
            'rapid fire': { pattern: /^rapid\s+fire\s*(\d+)?$/i, description: 'Bei Range ≤ Hälfte: +X Attacks', paramName: 'Bonus-Attacks' },
            'feel no pain': { pattern: /^feel\s+no\s+pain\s*(\d+)\+?$/i, description: 'Ignoriert Schaden bei X+ auf 1W6', paramName: 'Save-Threshold' },
            'crithit': { pattern: /^crithit(\d+)\+?$/i, description: 'Critical Hits bei X+ statt 6+', paramName: 'Hit-Threshold' },
            'critwound': { pattern: /^critwound(\d+)\+?$/i, description: 'Critical Wounds bei X+ statt 6+', paramName: 'Wound-Threshold' }
        };

        function needsParameter(keyword) {
            const keywordLower = keyword.toLowerCase();
            for (const [key, config] of Object.entries(parametricKeywords)) {
                if (keywordLower.includes(key.toLowerCase()) || config.pattern.test(keyword)) {
                    // Prüfe ob bereits ein Parameter vorhanden ist
                    const match = config.pattern.exec(keyword);
                    if (match && match[1]) {
                        return null; // Bereits parametrisiert
                    }
                    return config;
                }
            }
            return null;
        }

        function updateWeaponKeywordsDisplay() {
            const container = document.getElementById('weaponKeywords');
            const paramContainer = document.getElementById('weaponKeywordParameters');
            const paramInputs = paramContainer.querySelector('.keyword-parameter-inputs');
            
            container.innerHTML = '';
            paramInputs.innerHTML = '';
            
            let hasParameters = false;
            
            window.currentWeaponKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeWeaponKeyword(${index})">×</span>
                `;
                container.appendChild(tag);
                
                // Prüfe ob Parameter benötigt wird
                const paramConfig = needsParameter(keyword);
                if (paramConfig) {
                    hasParameters = true;
                    const paramItem = document.createElement('div');
                    paramItem.className = 'keyword-parameter-item';
                    paramItem.innerHTML = `
                        <span class="keyword-parameter-label">${keyword} - ${paramConfig.paramName}:</span>
                        <input type="text" class="keyword-parameter-input" 
                               id="weaponParam_${index}" 
                               placeholder="X" 
                               onchange="updateParametricKeyword('weapon', ${index}, this.value)">
                    `;
                    paramInputs.appendChild(paramItem);
                }
            });
            
            paramContainer.style.display = hasParameters ? 'block' : 'none';
        }

        function updateDefenderKeywordsDisplay() {
            const container = document.getElementById('defenderKeywords');
            const paramContainer = document.getElementById('defenderKeywordParameters');
            const paramInputs = paramContainer.querySelector('.keyword-parameter-inputs');
            
            container.innerHTML = '';
            paramInputs.innerHTML = '';
            
            let hasParameters = false;
            
            window.currentDefenderKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeDefenderKeyword(${index})">×</span>
                `;
                container.appendChild(tag);
                
                // Prüfe ob Parameter benötigt wird
                const paramConfig = needsParameter(keyword);
                if (paramConfig) {
                    hasParameters = true;
                    const paramItem = document.createElement('div');
                    paramItem.className = 'keyword-parameter-item';
                    paramItem.innerHTML = `
                        <span class="keyword-parameter-label">${keyword} - ${paramConfig.paramName}:</span>
                        <input type="text" class="keyword-parameter-input" 
                               id="defenderParam_${index}" 
                               placeholder="X" 
                               onchange="updateParametricKeyword('defender', ${index}, this.value)">
                    `;
                    paramInputs.appendChild(paramItem);
                }
            });
            
            paramContainer.style.display = hasParameters ? 'block' : 'none';
        }

        window.updateParametricKeyword = function(type, index, value) {
            const keywords = type === 'weapon' ? window.currentWeaponKeywords : window.currentDefenderKeywords;
            const keyword = keywords[index];
            const paramConfig = needsParameter(keyword);
            
            if (paramConfig && value) {
                // Ersetze das Keyword mit dem parametrisierten Wert
                let newKeyword = keyword;
                if (keyword.toLowerCase().includes('melta')) {
                    newKeyword = `melta ${value}`;
                } else if (keyword.toLowerCase().includes('anti-')) {
                    // Extrahiere das Anti-Target und füge den Wert hinzu
                    const match = keyword.match(/anti-([^0-9]+)/i);
                    if (match) {
                        newKeyword = `anti-${match[1].trim()} ${value}+`;
                    }
                } else if (keyword.toLowerCase().includes('sustained hits')) {
                    newKeyword = `sustained hits ${value}`;
                } else if (keyword.toLowerCase().includes('rapid fire')) {
                    newKeyword = `rapid fire ${value}`;
                } else if (keyword.toLowerCase().includes('feel no pain')) {
                    newKeyword = `feel no pain ${value}+`;
                } else if (keyword.toLowerCase().includes('crithit')) {
                    newKeyword = `CritHit${value}+`;
                } else if (keyword.toLowerCase().includes('critwound')) {
                    newKeyword = `CritWound${value}+`;
                }
                
                keywords[index] = newKeyword;
                
                if (type === 'weapon') {
                    updateWeaponKeywordsDisplay();
                } else {
                    updateDefenderKeywordsDisplay();
                }
            }
        };

        window.removeWeaponKeyword = function(index) {
            window.currentWeaponKeywords.splice(index, 1);
            updateWeaponKeywordsDisplay();
        };

        window.removeDefenderKeyword = function(index) {
            window.currentDefenderKeywords.splice(index, 1);
            updateDefenderKeywordsDisplay();
        };

        // Listen aktualisieren
        function updateAttackersList() {
            const container = document.getElementById('attackersList');
            container.innerHTML = '';

            window.attackers.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${group.GroupName}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small" onclick="editAttackerGroup(${groupIndex})">Bearbeiten</button>
                            <button class="btn btn-small btn-danger" onclick="removeAttackerGroup(${groupIndex})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Mitglieder:</strong><br>
                        ${group.Members.map((member, mIndex) => `
                            <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.03); border-radius: 3px;">
                                <div style="margin-bottom: 5px;">
                                    ${member.Count}x ${member.Name}
                                    <button class="btn btn-small" onclick="editAttackerMember(${groupIndex}, ${mIndex})" style="float: right; margin-left: 5px;">Bearbeiten</button>
                                    <button class="btn btn-small btn-danger" onclick="removeAttackerMember(${groupIndex}, ${mIndex})" style="float: right;">Entfernen</button>
                                </div>
                                ${member.Weapons && member.Weapons.length > 0 ? `
                                    <div style="margin-left: 10px; font-size: 0.9em; color: #b8c6db;">
                                        <strong>Waffen (${member.Weapons.length}):</strong><br>
                                        ${member.Weapons.map((weapon, wIndex) => `
                                            <div style="margin: 2px 0; padding: 3px; background: rgba(255,255,255,0.05); border-radius: 2px;">
                                                <strong>${weapon.name}</strong> (${weapon.type})<br>
                                                A: ${weapon.attacks} | Hit: ${weapon.to_hit}+ | S: ${weapon.strength} | AP: -${weapon.ap} | D: ${weapon.damage} | Amount: ${weapon.amount}<br>
                                                Keywords: ${weapon.Keywords.join(', ') || 'Keine'}
                                                <div style="margin-top: 3px;">
                                                    <button class="btn btn-small" onclick="editWeapon(${groupIndex}, ${mIndex}, ${wIndex})">Bearbeiten</button>
                                                    <button class="btn btn-small btn-danger" onclick="removeWeapon(${groupIndex}, ${mIndex}, ${wIndex})">Entfernen</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div style="margin-left: 10px; font-size: 0.9em; color: #888;">Keine Waffen</div>'}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateDefendersList() {
            const container = document.getElementById('defendersList');
            container.innerHTML = '';

            window.defenders.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${group.GroupName}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small" onclick="editDefenderGroup(${groupIndex})">Bearbeiten</button>
                            <button class="btn btn-small btn-danger" onclick="removeDefenderGroup(${groupIndex})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Mitglieder:</strong><br>
                        ${group.Members.map((member, mIndex) => `
                            <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 3px;">
                                <strong>${member.models}x ${member.Name}${member.isLeader ? ' 🎖️ (Leader)' : ''}</strong><br>
                                T: ${member.toughness} | W: ${member.wounds} | Save: ${member.save}+ | 
                                Inv: ${member.invulnerable < 7 ? member.invulnerable + '+' : 'Keine'}<br>
                                Keywords: ${member.Keywords.join(', ') || 'Keine'}
                                <div style="margin-top: 5px;">
                                    <button class="btn btn-small" onclick="editDefenderMember(${groupIndex}, ${mIndex})">Bearbeiten</button>
                                    <button class="btn btn-small btn-danger" onclick="removeDefenderMember(${groupIndex}, ${mIndex})">Entfernen</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateAttackerSelect() {
            const select = document.getElementById('weaponAttackerSelect');
            select.innerHTML = '<option value="">Bitte Angreifer auswählen</option>';
            
            window.attackers.forEach((group, groupIndex) => {
                group.Members.forEach((member, memberIndex) => {
                    const option = document.createElement('option');
                    option.value = `${groupIndex}-${memberIndex}`;
                    option.textContent = `${member.Name} (${group.GroupName}) - ${member.Count}x`;
                    select.appendChild(option);
                });
            });
        }

        // Entfernen-Funktionen für Gruppen
        window.removeAttackerGroup = function(groupIndex) {
            const group = window.attackers[groupIndex];
            if (confirm(`Möchten Sie die gesamte Gruppe "${group.GroupName}" entfernen?`)) {
                window.attackers.splice(groupIndex, 1);
                updateAttackersList();
                updateAttackerSelect();
            }
        };

        window.removeDefenderGroup = function(groupIndex) {
            const group = window.defenders[groupIndex];
            if (confirm(`Möchten Sie die gesamte Gruppe "${group.GroupName}" entfernen?`)) {
                window.defenders.splice(groupIndex, 1);
                updateDefendersList();
            }
        };

        window.removeAttackerMember = function(groupIndex, memberIndex) {
            const group = window.attackers[groupIndex];
            const member = group.Members[memberIndex];
            if (confirm(`Möchten Sie ${member.Count}x ${member.Name} entfernen?`)) {
                group.Members.splice(memberIndex, 1);
                // Wenn keine Mitglieder mehr, Gruppe entfernen
                if (group.Members.length === 0) {
                    window.attackers.splice(groupIndex, 1);
                    updateAttackerSelect();
                }
                updateAttackersList();
            }
        };

        window.removeDefenderMember = function(groupIndex, memberIndex) {
            const group = window.defenders[groupIndex];
            const member = group.Members[memberIndex];
            if (confirm(`Möchten Sie ${member.models}x ${member.Name} entfernen?`)) {
                group.Members.splice(memberIndex, 1);
                // Wenn keine Mitglieder mehr, Gruppe entfernen
                if (group.Members.length === 0) {
                    window.defenders.splice(groupIndex, 1);
                }
                updateDefendersList();
            }
        };

        window.removeWeapon = function(groupIndex, memberIndex, weaponIndex) {
            window.attackers[groupIndex].Members[memberIndex].Weapons.splice(weaponIndex, 1);
            updateAttackersList();
        };

        window.editWeapon = function(groupIndex, memberIndex, weaponIndex) {
            const weapon = window.attackers[groupIndex].Members[memberIndex].Weapons[weaponIndex];
            
            // Lade die aktuellen Werte in das Waffen-Formular
            document.getElementById('weaponName').value = weapon.name;
            document.getElementById('weaponType').value = weapon.type;
            document.getElementById('weaponAttacks').value = weapon.attacks;
            document.getElementById('weaponToHit').value = weapon.to_hit;
            document.getElementById('weaponStrength').value = weapon.strength;
            document.getElementById('weaponAP').value = weapon.ap;
            document.getElementById('weaponDamage').value = weapon.damage;
            document.getElementById('weaponAmount').value = weapon.amount;
            
            // Lade Keywords - entferne Duplikate und bereinige
            let cleanKeywords = weapon.Keywords || [];
            if (Array.isArray(cleanKeywords)) {
                cleanKeywords = cleanKeywords.filter(k => 
                    k && 
                    k.trim() !== '' && 
                    !k.startsWith('WoundBonus') &&
                    !k.includes('undefined')
                );
                cleanKeywords = [...new Set(cleanKeywords)]; // Entferne Duplikate
            } else {
                cleanKeywords = [];
            }
            window.currentWeaponKeywords = cleanKeywords;
            updateWeaponKeywordsDisplay();
            
            // Speichere die Indizes für das Update
            window.editingWeaponGroupIndex = groupIndex;
            window.editingWeaponMemberIndex = memberIndex;
            window.editingWeaponIndex = weaponIndex;
            
            // Ändere den Button-Text und die Funktion
            const addButton = document.querySelector('button[onclick="addWeapon()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Waffe aktualisieren';
            addButton.onclick = function() {
                updateWeapon();
                addButton.textContent = originalText;
                addButton.onclick = window.addWeapon;
                // Schließe das Menü nach dem Update
                const weaponCollapsible = document.querySelector('.collapsible');
                if (weaponCollapsible && weaponCollapsible.textContent.includes('Waffe hinzufügen')) {
                    const content = weaponCollapsible.nextElementSibling;
                    if (content && content.style.display === 'block') {
                        weaponCollapsible.classList.remove('active');
                        content.style.display = 'none';
                    }
                }
            };
            
            // Öffne das Waffen-Menü
            const weaponCollapsible = document.querySelector('.collapsible');
            if (weaponCollapsible && weaponCollapsible.textContent.includes('Waffe hinzufügen')) {
                const content = weaponCollapsible.nextElementSibling;
                if (content) {
                    weaponCollapsible.classList.add('active');
                    content.style.display = 'block';
                }
            }
            
            showSuccess('Waffen-Daten in das Formular geladen. Bearbeiten Sie die Werte und klicken Sie "Waffe aktualisieren".');
        };

        // Debug: Überprüfe ob editWeapon verfügbar ist
        console.log('editWeapon function available:', typeof window.editWeapon);

        // Notfall-Funktion: Bereinige alle Keywords aller Waffen
        window.cleanupAllWeaponKeywords = function() {
            let totalCleaned = 0;
            
            window.attackers.forEach((group, groupIndex) => {
                group.Members.forEach((member, memberIndex) => {
                    member.Weapons.forEach((weapon, weaponIndex) => {
                        if (weapon.Keywords) {
                            const originalLength = weapon.Keywords.length;
                            
                            // Entferne alle WoundBonus Keywords
                            weapon.Keywords = weapon.Keywords.filter(k => !k.startsWith('WoundBonus'));
                            
                            // Entferne Duplikate
                            weapon.Keywords = [...new Set(weapon.Keywords)];
                            
                            // Entferne leere oder undefined Keywords
                            weapon.Keywords = weapon.Keywords.filter(k => k && k.trim() !== '');
                            
                            totalCleaned += (originalLength - weapon.Keywords.length);
                        }
                    });
                });
            });
            
            updateAttackersList();
            showSuccess(`Keyword-Bereinigung abgeschlossen! ${totalCleaned} doppelte/fehlerhafte Keywords entfernt.`);
        };

        // Verbesserte updateWeapon Funktion mit zusätzlicher Keyword-Bereinigung
        function updateWeapon() {
            const groupIndex = window.editingWeaponGroupIndex;
            const memberIndex = window.editingWeaponMemberIndex;
            const weaponIndex = window.editingWeaponIndex;
            
            if (groupIndex === undefined || memberIndex === undefined || weaponIndex === undefined) {
                showError('Fehler beim Update: Waffen-Indizes nicht gefunden.');
                return;
            }
            
            const weapon = window.attackers[groupIndex].Members[memberIndex].Weapons[weaponIndex];
            
            // Update die Waffen-Daten
            weapon.name = document.getElementById('weaponName').value.trim();
            weapon.type = document.getElementById('weaponType').value;
            weapon.attacks = document.getElementById('weaponAttacks').value;
            weapon.to_hit = parseInt(document.getElementById('weaponToHit').value);
            weapon.strength = parseInt(document.getElementById('weaponStrength').value);
            weapon.ap = parseInt(document.getElementById('weaponAP').value);
            weapon.damage = document.getElementById('weaponDamage').value;
            weapon.amount = parseInt(document.getElementById('weaponAmount').value) || 1;
            weapon.Keywords = [...new Set(window.currentWeaponKeywords)]; // Entferne Duplikate
            
            // Zusätzliche Bereinigung: Entferne WoundBonus Keywords und andere Fehler
            weapon.Keywords = weapon.Keywords.filter(k => 
                k && 
                k.trim() !== '' && 
                !k.startsWith('WoundBonus') &&
                !k.includes('undefined')
            );
            
            // Nochmals Duplikate entfernen zur Sicherheit
            weapon.Keywords = [...new Set(weapon.Keywords)];
            
            // Reset die Editing-Indizes
            delete window.editingWeaponGroupIndex;
            delete window.editingWeaponMemberIndex;
            delete window.editingWeaponIndex;
            
            updateAttackersList();
            resetWeaponForm();
            showSuccess('Waffe wurde erfolgreich aktualisiert!');
        }

        // Waffen-Formular zurücksetzen
        function resetWeaponForm() {
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponType').value = 'Ranged';
            document.getElementById('weaponAttacks').value = '1';
            document.getElementById('weaponToHit').value = 4;
            document.getElementById('weaponStrength').value = 4;
            document.getElementById('weaponAP').value = 0;
            document.getElementById('weaponDamage').value = '1';
            document.getElementById('weaponAmount').value = 1;
            
            // Reset Keywords
            window.currentWeaponKeywords = [];
            updateWeaponKeywordsDisplay();
            
            // Reset Attacker Selection to first option
            const attackerSelect = document.getElementById('weaponAttackerSelect');
            if (attackerSelect && attackerSelect.options.length > 0) {
                attackerSelect.selectedIndex = 0;
            }
        }

        // JSON Import/Export Funktionen
        window.exportJson = function() {
            const data = {
                attackers: window.attackers,
                defenders: window.defenders,
                version: "2.0",
                timestamp: new Date().toISOString()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `warhammer40k_simulation_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('JSON-Datei wurde heruntergeladen!');
        };

        window.importJson = function() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.attackers && data.defenders) {
                            // Bereinige Keywords vor dem Import
                            cleanupKeywords(data);
                            
                            window.attackers = data.attackers;
                            window.defenders = data.defenders;
                            
                            // Migration für neue Struktur ausführen
                            migrateAttackerData();
                            
                            updateAttackersList();
                            updateDefendersList();
                            updateAttackerSelect();
                            showSuccess('JSON-Daten erfolgreich importiert!');
                        } else if (data.Attackers && data.Defenders) {
                            // Support für das neue Format
                            // Bereinige Keywords vor dem Import
                            cleanupKeywords(data);
                            
                            // Konvertiere das neue Format in das alte
                            window.attackers = data.Attackers.map(attacker => ({
                                GroupName: attacker.Name,
                                Members: [{
                                    Name: attacker.Name,
                                    Count: 1,
                                    Weapons: attacker.Weapons || []
                                }]
                            }));
                            
                            window.defenders = data.Defenders.map(defender => ({
                                GroupName: defender.Name,
                                Members: [defender]
                            }));
                            
                            updateAttackersList();
                            updateDefendersList();
                            updateAttackerSelect();
                            showSuccess('JSON-Daten erfolgreich importiert!');
                        } else {
                            showError('Ungültiges JSON-Format. Bitte stellen Sie sicher, dass die Datei Angreifer und Verteidiger enthält.');
                        }
                    } catch (error) {
                        showError('Fehler beim Parsen der JSON-Datei: ' + error.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        };

        // Funktion zum Bereinigen von Keywords
        function cleanupKeywords(data) {
            // Bereinige Angreifer Keywords
            if (data.attackers) {
                data.attackers.forEach(group => {
                    if (group.Members) {
                        group.Members.forEach(member => {
                            if (member.Weapons) {
                                member.Weapons.forEach(weapon => {
                                    if (weapon.Keywords) {
                                        weapon.Keywords = [...new Set(weapon.Keywords)];
                                    }
                                });
                            }
                        });
                    }
                });
            }
            
            // Bereinige neues Format
            if (data.Attackers) {
                data.Attackers.forEach(attacker => {
                    if (attacker.Weapons) {
                        attacker.Weapons.forEach(weapon => {
                            if (weapon.Keywords) {
                                weapon.Keywords = [...new Set(weapon.Keywords)];
                            }
                        });
                    }
                });
            }
            
            // Bereinige Verteidiger Keywords
            if (data.defenders) {
                data.defenders.forEach(group => {
                    if (group.Members) {
                        group.Members.forEach(member => {
                            if (member.Keywords) {
                                member.Keywords = [...new Set(member.Keywords)];
                            }
                        });
                    }
                });
            }
            
            if (data.Defenders) {
                data.Defenders.forEach(defender => {
                    if (defender.Keywords) {
                        defender.Keywords = [...new Set(defender.Keywords)];
                    }
                });
            }
        }

        // PDF Export Funktion  
        window.exportResultsToPDF = function() {
            if (!window.simulationResults || window.simulationResults.length === 0) {
                showError('Keine Simulationsergebnisse zum Exportieren vorhanden. Führen Sie zuerst eine Simulation durch.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            let yPos = 20;
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;
            const margin = 20;
            const contentWidth = pageWidth - (2 * margin);
            
            // Helper function to check if new page is needed
            function checkNewPage(requiredSpace = 25) {
                if (yPos > pageHeight - requiredSpace) {
                    doc.addPage();
                    yPos = margin;
                    return true;
                }
                return false;
            }
            
            // Helper function to draw section divider
            function drawDivider() {
                doc.setDrawColor(100, 100, 100);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 8;
            }
            
            // Helper function to create chart canvas
            function createDistributionChart(distributionData, title, maxValue) {
                const canvas = document.createElement('canvas');
                canvas.width = 400;
                canvas.height = 200;
                const ctx = canvas.getContext('2d');
                
                // Clear canvas
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Chart settings
                const chartArea = {
                    x: 50,
                    y: 30,
                    width: 300,
                    height: 120
                };
                
                // Draw title
                ctx.fillStyle = 'black';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(title, canvas.width / 2, 20);
                
                // Draw axes
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(chartArea.x, chartArea.y + chartArea.height);
                ctx.lineTo(chartArea.x + chartArea.width, chartArea.y + chartArea.height);
                ctx.moveTo(chartArea.x, chartArea.y);
                ctx.lineTo(chartArea.x, chartArea.y + chartArea.height);
                ctx.stroke();
                
                if (distributionData && distributionData.length > 0) {
                    const barWidth = chartArea.width / distributionData.length;
                    const maxPercentage = Math.max(...distributionData.map(d => d.percentage));
                    
                    distributionData.forEach((data, index) => {
                        const barHeight = (data.percentage / maxPercentage) * chartArea.height;
                        const x = chartArea.x + (index * barWidth);
                        const y = chartArea.y + chartArea.height - barHeight;
                        
                        // Draw bar
                        ctx.fillStyle = '#4CAF50';
                        ctx.fillRect(x + 2, y, barWidth - 4, barHeight);
                        
                        // Draw value label
                        ctx.fillStyle = 'black';
                        ctx.font = '10px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(`≥${data.value}`, x + barWidth/2, chartArea.y + chartArea.height + 15);
                        
                        // Draw percentage
                        ctx.font = '8px Arial';
                        ctx.fillText(`${data.percentage.toFixed(1)}%`, x + barWidth/2, y - 5);
                    });
                }
                
                // Y-axis labels
                ctx.fillStyle = 'black';
                ctx.font = '10px Arial';
                ctx.textAlign = 'right';
                ctx.fillText('100%', chartArea.x - 5, chartArea.y + 5);
                ctx.fillText('0%', chartArea.x - 5, chartArea.y + chartArea.height + 5);
                
                return canvas;
            }
            
            // Title Page
            doc.setFontSize(20);
            doc.setFont(undefined, 'bold');
            doc.text('Warhammer 40k', pageWidth / 2, 40, { align: 'center' });
            doc.text('Kampfsimulation - Bericht', pageWidth / 2, 55, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(`Erstellt am: ${new Date().toLocaleString('de-DE')}`, pageWidth / 2, 70, { align: 'center' });
            
            // Summary Box
            yPos = 90;
            doc.setDrawColor(0, 0, 0);
            doc.rect(margin, yPos, contentWidth, 40);
            
            yPos += 15;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('Simulation Übersicht', margin + 10, yPos);
            
            yPos += 10;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Anzahl Angreifer-Gruppen: ${window.simulationResults.length}`, margin + 10, yPos);
            
            const totalDefenders = window.simulationResults.reduce((sum, result) => sum + result.Target.length, 0);
            yPos += 6;
            doc.text(`Anzahl Verteidiger-Gruppen: ${totalDefenders}`, margin + 10, yPos);
            
            // Start detailed results on new page
            doc.addPage();
            yPos = margin;
            
            // Detailed Results
            window.simulationResults.forEach((attackerResult, attackerIndex) => {
                checkNewPage(40);
                
                // Angreifer-Gruppe Header
                doc.setFontSize(16);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 150);
                doc.text(`${attackerResult.Name}`, margin, yPos);
                yPos += 12;
                
                drawDivider();
                
                attackerResult.Target.forEach((targetResult, targetIndex) => {
                    checkNewPage(50);
                    
                    // Verteidiger-Gruppe
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(150, 0, 0);
                    doc.text(`Ziel: ${targetResult.Name}`, margin + 10, yPos);
                    yPos += 10;
                    
                    // Waffen-Ergebnisse Sektion
                    if (targetResult.Weapons && targetResult.Weapons.length > 0) {
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text('Waffen-Statistiken', margin + 20, yPos);
                        yPos += 8;
                        
                        // Waffen-Tabelle Header
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'bold');
                        const tableX = margin + 25;
                        doc.text('Waffe', tableX, yPos);
                        doc.text('Treffer', tableX + 80, yPos);
                        doc.text('Wunden', tableX + 110, yPos);
                        doc.text('Saves', tableX + 140, yPos);
                        doc.text('Schaden', tableX + 170, yPos);
                        yPos += 6;
                        
                        // Draw table line
                        doc.setDrawColor(200, 200, 200);
                        doc.line(tableX, yPos - 2, tableX + 200, yPos - 2);
                        yPos += 2;
                        
                        doc.setFont(undefined, 'normal');
                        targetResult.Weapons.forEach(weapon => {
                            checkNewPage();
                            
                            // Clean and truncate weapon name if too long
                            let weaponName = cleanWeaponName(weapon.Name);
                            if (weaponName.length > 25) {
                                weaponName = weaponName.substring(0, 22) + '...';
                            }
                            
                            doc.text(weaponName, tableX, yPos);
                            doc.text(weapon.Hits.toFixed(1), tableX + 80, yPos);
                            doc.text(weapon.Wounds.toFixed(1), tableX + 110, yPos);
                            doc.text(weapon.FailedSaves.toFixed(1), tableX + 140, yPos);
                            doc.text(weapon.AverageDamage.toFixed(1), tableX + 170, yPos);
                            yPos += 6;
                        });
                        
                        yPos += 5;
                    }
                    
                    // Member-Ergebnisse Sektion
                    if (targetResult.Members && targetResult.Members.length > 0) {
                        checkNewPage(30);
                        
                        doc.setFontSize(12);
                        doc.setFont(undefined, 'bold');
                        doc.text('Verteidiger-Ergebnisse', margin + 20, yPos);
                        yPos += 10;
                        
                        targetResult.Members.forEach(member => {
                            checkNewPage(35);
                            
                            const leaderText = member.IsLeader ? ' (Leader)' : '';
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.text(`${member.Name}${leaderText}`, margin + 25, yPos);
                            yPos += 8;
                            
                            doc.setFontSize(9);
                            doc.setFont(undefined, 'normal');
                            
                            // Stats in zwei Spalten
                            const leftCol = margin + 30;
                            const rightCol = margin + 120;
                            
                            doc.text(`Modelle vernichtet: ${member.ModelsDestroyed.toFixed(2)}/${member.MaximumModels}`, leftCol, yPos);
                            doc.text(`Gesamtschaden: ${member.TotalDamage.toFixed(2)}`, rightCol, yPos);
                            yPos += 6;
                            
                            doc.text(`Komplette Vernichtung: ${member.CompleteWipeoutChance.toFixed(1)}%`, leftCol, yPos);
                            yPos += 10;
                            
                            // Distribution Chart
                            if (member.KillDistribution && member.KillDistribution.length > 0) {
                                checkNewPage(60);
                                
                                const isSingleModel = member.MaximumModels === 1;
                                const chartTitle = isSingleModel ? 
                                    `Wahrscheinlichkeitsverteilung - Wunden (${member.Name})` : 
                                    `Wahrscheinlichkeitsverteilung - Kills (${member.Name})`;
                                
                                const canvas = createDistributionChart(member.KillDistribution, chartTitle, 
                                    isSingleModel ? member.MaxWounds : member.MaximumModels);
                                
                                // Convert canvas to image and add to PDF
                                const imgData = canvas.toDataURL('image/png');
                                const imgWidth = 120;
                                const imgHeight = 60;
                                
                                doc.addImage(imgData, 'PNG', margin + 25, yPos, imgWidth, imgHeight);
                                yPos += imgHeight + 10;
                            }
                        });
                    }
                    
                    yPos += 10;
                    drawDivider();
                });
                
                yPos += 10;
            });
            
            // Footer on each page
            const totalPages = doc.internal.getNumberOfPages();
            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text(`Seite ${i} von ${totalPages}`, pageWidth - margin, pageHeight - 10, { align: 'right' });
                doc.text('Warhammer 40k Simulationsbericht', margin, pageHeight - 10);
            }
            
            // PDF speichern
            doc.save(`warhammer40k_simulation_${new Date().toISOString().split('T')[0]}.pdf`);
            showSuccess('Strukturierter PDF-Report mit Diagrammen wurde heruntergeladen!');
        };

        // Export Simulation Results to JSON
        window.exportResultsToJson = function() {
            if (!window.simulationResults || window.simulationResults.length === 0) {
                showError('Keine Simulationsergebnisse zum Exportieren vorhanden.');
                return;
            }
            
            const data = {
                simulationResults: window.simulationResults,
                attackers: window.attackers,
                defenders: window.defenders,
                version: "2.0",
                timestamp: new Date().toISOString()
            };
            
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `warhammer40k_simulation_results_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showSuccess('Simulationsergebnisse als JSON-Datei heruntergeladen!');
        };

        // Simulation ausführen
        window.runSimulation = function() {
            console.log('runSimulation called');
            console.log('Attackers:', window.attackers);
            console.log('Defenders:', window.defenders);
            
            if (window.attackers.length === 0) {
                showError('Bitte fügen Sie mindestens einen Angreifer hinzu.');
                return;
            }

            if (window.defenders.length === 0) {
                showError('Bitte fügen Sie mindestens einen Verteidiger hinzu.');
                return;
            }

            // Prüfen ob alle Angreifer Waffen haben
            const attackersWithoutWeapons = [];
            window.attackers.forEach(group => {
                group.Members.forEach(member => {
                    if (!member.Weapons || member.Weapons.length === 0) {
                        attackersWithoutWeapons.push(`${member.Name} (${group.GroupName})`);
                    }
                });
            });
            
            if (attackersWithoutWeapons.length > 0) {
                showError(`Die folgenden Angreifer haben keine Waffen: ${attackersWithoutWeapons.join(', ')}`);
                return;
            }

            const amount = parseInt(document.getElementById('simulationAmount').value);
            console.log('Simulation amount:', amount);
            
            // Loading anzeigen
            document.getElementById('loadingSpinner').classList.add('active');

            // Simulation in nächstem Frame starten (für Loading-Animation)
            setTimeout(() => {
                try {
                    // Konvertiere UI-Gruppen in das für die Simulation erwartete Format
                    const simulationData = {
                        Amount: amount,
                        Attackers: [],
                        Defenders: []
                    };

                    // Transformiere Verteidiger-Gruppen in das erwartete Format
                    window.defenders.forEach(group => {
                        simulationData.Defenders.push({
                            Name: group.GroupName,
                            Members: group.Members.map(member => ({
                                Name: member.Name,
                                type: member.type,
                                isLeader: member.isLeader || false,
                                toughness: member.toughness,
                                wounds: member.wounds,
                                models: member.models,
                                save: member.save,
                                invulnerable: member.invulnerable,
                                Keywords: member.Keywords
                            }))
                        });
                    });

                    // Transformiere Angreifer-Gruppen in das erwartete Format
                    window.attackers.forEach(group => {
                        group.Members.forEach(member => {
                            // Erstelle einen Angreifer für die gesamte Gruppe dieses Mitglieds
                            const attackerName = `${member.Name} (${group.GroupName})`;
                                
                            simulationData.Attackers.push({
                                Name: attackerName,
                                Weapons: member.Weapons.map(weapon => ({
                                    name: weapon.name,
                                    type: weapon.type,
                                    attacks: weapon.attacks,
                                    to_hit: weapon.to_hit,
                                    strength: weapon.strength,
                                    ap: weapon.ap,
                                    damage: weapon.damage,
                                    Keywords: weapon.Keywords,
                                    amount: weapon.amount // Don't multiply here - the amount field already represents total weapons
                                }))
                            });
                        });
                    });

                    console.log('Simulation data:', simulationData);
                    console.log('runCombatSimulation function type:', typeof window.runCombatSimulation);

                    if (typeof window.runCombatSimulation !== 'function') {
                        throw new Error('Simulation-Engine nicht verfügbar. Bitte laden Sie die Seite neu.');
                    }

                    window.simulationResults = window.runCombatSimulation(simulationData);
                    console.log('Simulation results:', window.simulationResults);
                    displayResults();
                    document.getElementById('resultsPanel').style.display = 'block';
                    
                    // Zu Ergebnissen scrollen - mit verzögerung für bessere Performance
                    setTimeout(() => {
                        document.getElementById('resultsPanel').scrollIntoView({ 
                            behavior: 'smooth',
                            block: 'start',
                            inline: 'nearest'
                        });
                    }, 200);
                    
                    showSuccess('Simulation erfolgreich abgeschlossen!');
                } catch (error) {
                    console.error('Simulation Error:', error);
                    showError('Fehler bei der Simulation: ' + error.message);
                } finally {
                    document.getElementById('loadingSpinner').classList.remove('active');
                }
            }, 100);
        };

        // Ergebnisse anzeigen (neu strukturiert: nach Angreifer-Gruppen)
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            if (!window.simulationResults || window.simulationResults.length === 0) {
                container.innerHTML = '<p>Keine Ergebnisse verfügbar.</p>';
                return;
            }

            window.simulationResults.forEach((attackerResult, attackerIndex) => {
                const attackerDiv = document.createElement('div');
                attackerDiv.className = 'result-section';
                
                let attackerHtml = `
                    <div class="attacker-group-header">
                        <h2>🗡️ ${safeString(attackerResult.Name || 'Unbekannter Angreifer')}</h2>
                    </div>
                `;

                // Sammle alle Waffen aus allen Target-Ergebnissen dieser Angreifer-Gruppe
                const weaponSummary = new Map();
                
                if (attackerResult.Target && attackerResult.Target.length > 0) {
                    attackerResult.Target.forEach(targetResult => {
                        if (targetResult.Weapons) {
                            targetResult.Weapons.forEach(weapon => {
                                if (!weaponSummary.has(weapon.Name)) {
                                    weaponSummary.set(weapon.Name, {
                                        weapon: weapon,
                                        targets: []
                                    });
                                }
                                weaponSummary.get(weapon.Name).targets.push({
                                    targetName: targetResult.Name,
                                    hits: weapon.Hits,
                                    wounds: weapon.Wounds,
                                    failedSaves: weapon.FailedSaves,
                                    damage: weapon.AverageDamage
                                });
                            });
                        }
                    });
                }

                // Zeige Waffen-Übersicht für diese Angreifer-Gruppe
                if (weaponSummary.size > 0) {
                    attackerHtml += `
                        <div class="weapons-overview">
                            <button class="collapsible-btn" onclick="toggleCollapsible(this)">
                                ⚔️ Waffen dieser Gruppe (${weaponSummary.size})
                                <span class="toggle-icon">▼</span>
                            </button>
                            <div class="collapsible-content">
                                <div class="weapons-grid">
                    `;

                    weaponSummary.forEach((weaponData, weaponName) => {
                        const weapon = weaponData.weapon;
                        const cleanedWeaponName = cleanWeaponName(weaponName);
                        attackerHtml += `
                            <div class="weapon-card">
                                <h5>${safeString(cleanedWeaponName)}</h5>
                                <div class="weapon-stats">
                                    <div class="stat-item">
                                        <span class="stat-label">Durchschn. Treffer:</span>
                                        <span class="stat-value">${safeNumber(weapon.Hits).toFixed(2)}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Durchschn. Verwundungen:</span>
                                        <span class="stat-value">${safeNumber(weapon.Wounds).toFixed(2)}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Fehlgeschlagene Saves:</span>
                                        <span class="stat-value">${safeNumber(weapon.FailedSaves).toFixed(2)}</span>
                                    </div>
                                    <div class="stat-item">
                                        <span class="stat-label">Durchschn. Schaden:</span>
                                        <span class="stat-value">${safeNumber(weapon.AverageDamage).toFixed(2)}</span>
                                    </div>
                                </div>`;
                        
                        // Zeige wichtige Keywords an
                        if (weapon.Keywords && Object.keys(weapon.Keywords).length > 0) {
                            attackerHtml += `
                                <div class="weapon-keywords">
                                    <span class="stat-label">Spezial-Regeln:</span>
                                    <div class="keyword-tags">`;
                            
                            const keywords = weapon.Keywords;
                            const triggers = weapon.KeywordTriggers || {};
                            
                            if (keywords.lethalHits) {
                                const avgTriggers = triggers.lethalHits > 0 ? ` (⌀${triggers.lethalHits.toFixed(1)})` : '';
                                attackerHtml += `<span class="keyword-tag lethal">Lethal Hits${avgTriggers}</span>`;
                            }
                            if (keywords.devastatingWounds) {
                                const avgTriggers = triggers.devastatingWounds > 0 ? ` (⌀${triggers.devastatingWounds.toFixed(1)})` : '';
                                attackerHtml += `<span class="keyword-tag devastating">Devastating Wounds${avgTriggers}</span>`;
                            }
                            if (keywords.sustainedHits) {
                                const avgTriggers = triggers.sustainedHits > 0 ? ` (⌀${triggers.sustainedHits.toFixed(1)})` : '';
                                attackerHtml += `<span class="keyword-tag sustained">Sustained Hits ${keywords.sustainedHits}${avgTriggers}</span>`;
                            }
                            if (keywords.criticalHitOn && keywords.criticalHitOn !== "6") {
                                attackerHtml += `<span class="keyword-tag crit">Critical Hit ${keywords.criticalHitOn}+</span>`;
                            }
                            if (keywords.criticalWoundOn && keywords.criticalWoundOn !== "6") {
                                attackerHtml += `<span class="keyword-tag crit">Critical Wound ${keywords.criticalWoundOn}+</span>`;
                            }
                            if (keywords.anti && keywords.anti.length > 0) {
                                keywords.anti.forEach(anti => {
                                    attackerHtml += `<span class="keyword-tag anti">Anti-${anti.target} ${anti.threshold}+</span>`;
                                });
                            }
                            if (keywords.melta) {
                                attackerHtml += `<span class="keyword-tag melta">Melta ${keywords.melta}</span>`;
                            }
                            if (keywords.rerolls && keywords.rerolls.length > 0) {
                                keywords.rerolls.forEach(reroll => {
                                    let rerollText = reroll.replace("RH", "Reroll Hits ").replace("RW", "Reroll Wounds ");
                                    attackerHtml += `<span class="keyword-tag reroll">${rerollText}</span>`;
                                });
                            }
                            
                            // Zeige andere getriggerte Keywords an
                            if (triggers.hazardous > 0) {
                                attackerHtml += `<span class="keyword-tag hazardous">Hazardous (⌀${triggers.hazardous.toFixed(1)})</span>`;
                            }
                            if (triggers.blast > 0) {
                                attackerHtml += `<span class="keyword-tag blast">Blast (⌀+${triggers.blast.toFixed(1)} Attacks)</span>`;
                            }
                            if (triggers.torrent > 0) {
                                attackerHtml += `<span class="keyword-tag torrent">Torrent (⌀${triggers.torrent.toFixed(1)} Auto-Hits)</span>`;
                            }
                            
                            attackerHtml += `
                                    </div>
                                </div>`;
                        }
                        
                        attackerHtml += `
                            </div>
                        `;
                    });

                    attackerHtml += `
                                </div>
                            </div>
                        </div>
                    `;
                }

                // Zeige Verteidiger-spezifische Ergebnisse
                if (attackerResult.Target && attackerResult.Target.length > 0) {
                    attackerHtml += `
                        <div class="targets-section">
                            <button class="collapsible-btn" onclick="toggleCollapsible(this)">
                                🎯 Ergebnisse gegen Verteidiger (${attackerResult.Target.length})
                                <span class="toggle-icon">▼</span>
                            </button>
                            <div class="collapsible-content">
                    `;

                    attackerResult.Target.forEach((targetResult, targetIndex) => {
                        attackerHtml += `
                            <div class="target-result">
                                <h4>vs. ${safeString(targetResult.Name || 'Unbekannter Verteidiger')}</h4>
                        `;

                        // Verteidiger-Ergebnisse
                        if (targetResult.Members && targetResult.Members.length > 0) {
                            attackerHtml += `
                                <div class="defenders-section">
                                    <h5>🛡️ Ergebnisse pro Verteidiger</h5>
                                    <div class="defenders-grid">
                            `;

                            targetResult.Members.forEach((member, memberIndex) => {
                                const leaderIcon = member.IsLeader ? '🎖️ ' : '';
                                const isSingleModel = member.MaximumModels === 1;
                                
                                attackerHtml += `
                                    <div class="defender-card ${member.IsLeader ? 'leader' : ''}">
                                        <h6>${leaderIcon}${safeString(member.Name || 'Unbekannter Verteidiger')}</h6>
                                        <div class="defender-stats">
                                `;
                                
                                if (isSingleModel) {
                                    // Für Einzelmodelle: Zeige Wunden statt Modelle
                                    attackerHtml += `
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Wunden zugefügt:</span>
                                                <span class="stat-value">${safeNumber(member.TotalDamage).toFixed(2)}/${member.MaxWounds || 'N/A'}</span>
                                            </div>
                                    `;
                                } else {
                                    // Für Mehrfachmodelle: Zeige Modelle vernichtet
                                    attackerHtml += `
                                            <div class="stat-item">
                                                <span class="stat-label">Modelle vernichtet:</span>
                                                <span class="stat-value">${safeNumber(member.ModelsDestroyed).toFixed(2)}/${safeNumber(member.MaximumModels)}</span>
                                            </div>
                                    `;
                                }
                                
                                attackerHtml += `
                                            <div class="stat-item">
                                                <span class="stat-label">Durchschn. Schaden:</span>
                                                <span class="stat-value">${safeNumber(member.TotalDamage).toFixed(2)}</span>
                                            </div>
                                            <div class="stat-item">
                                                <span class="stat-label">Komplette Vernichtung:</span>
                                                <span class="stat-value">${safeNumber(member.CompleteWipeoutChance).toFixed(1)}%</span>
                                            </div>
                                        </div>
                                `;

                                // Kill-Distribution anzeigen
                                if (member.KillDistribution && member.KillDistribution.length > 0) {
                                    const distributionTitle = isSingleModel ? 
                                        "Wahrscheinlichkeitsverteilung (≥X Wunden)" : 
                                        "Wahrscheinlichkeitsverteilung (≥X Kills)";
                                    
                                    attackerHtml += `
                                        <div class="kill-distribution">
                                            <h6>${distributionTitle}</h6>
                                            <div class="distribution-chart">
                                                <div class="chart-bars-row">
                                    `;

                                    member.KillDistribution.forEach(dist => {
                                        const barHeight = Math.max(3, (dist.percentage / 100) * 100); // 100px max height
                                        attackerHtml += `
                                            <div class="chart-bar-container">
                                                <div class="chart-bar" style="height: ${barHeight}px; background-color: #4CAF50;">
                                                    <span class="bar-label">${dist.percentage.toFixed(0)}%</span>
                                                </div>
                                                <span class="bar-text">≥${dist.value}</span>
                                            </div>
                                        `;
                                    });

                                    attackerHtml += `
                                                </div>
                                            </div>
                                            <div class="distribution-list">
                                    `;

                                    member.KillDistribution.forEach(dist => {
                                        const unit = isSingleModel ? "Wunden" : "Modelle";
                                        attackerHtml += `
                                            <div class="distribution-item">
                                                <span>≥${dist.value} ${unit}:</span>
                                                <span>${dist.percentage.toFixed(1)}%</span>
                                            </div>
                                        `;
                                    });

                                    attackerHtml += `
                                            </div>
                                        </div>
                                    `;
                                }

                                attackerHtml += `</div>`;
                            });

                            attackerHtml += `
                                    </div>
                                </div>
                            `;
                        }

                        attackerHtml += `</div>`;
                    });

                    attackerHtml += `
                            </div>
                        </div>
                    `;
                }

                attackerDiv.innerHTML = attackerHtml;
                container.appendChild(attackerDiv);
            });
        }

        // Hilfsfunktionen für sichere Werte
        function safeString(value) {
            return (value !== undefined && value !== null) ? String(value) : 'N/A';
        }

        function safeNumber(value, defaultValue = 0) {
            return (value !== undefined && value !== null && !isNaN(value)) ? value : defaultValue;
        }

        // Funktion zum Bereinigen von Waffennamen - entfernt verschachtelte Klammern
        function cleanWeaponName(weaponName) {
            if (!weaponName) return 'N/A';
            
            // Finde die erste öffnende Klammer
            const firstParenIndex = weaponName.indexOf('(');
            if (firstParenIndex === -1) {
                return weaponName; // Keine Klammern gefunden
            }
            
            // Finde die entsprechende schließende Klammer für die erste öffnende Klammer
            let parenCount = 0;
            let firstCloseIndex = -1;
            
            for (let i = firstParenIndex; i < weaponName.length; i++) {
                if (weaponName[i] === '(') {
                    parenCount++;
                } else if (weaponName[i] === ')') {
                    parenCount--;
                    if (parenCount === 0) {
                        firstCloseIndex = i;
                        break;
                    }
                }
            }
            
            if (firstCloseIndex === -1) {
                return weaponName; // Keine passende schließende Klammer gefunden
            }
            
            // Extrahiere den Teil bis zur ersten schließenden Klammer
            return weaponName.substring(0, firstCloseIndex + 1).trim();
        }
    </script>
</body>
</html>
