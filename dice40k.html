<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warhammer 40k 10th Edition Kampfsimulator</title>
    <!-- jsPDF für PDF-Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #e0e6ed;
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #ffd700;
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .simulation-panel {
            margin-bottom: 30px;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .collapsible {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .collapsible.active {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .collapsible:after {
            content: '▼';
            font-size: 14px;
            color: #ffd700;
            transition: transform 0.3s ease;
        }

        .collapsible.active:after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 5px 5px;
        }

        .collapsible-content.active {
            padding: 20px;
            max-height: 1000px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .panel h2 {
            color: #ffd700;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #b8c6db;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            font-size: 14px;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(224, 230, 237, 0.6);
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 120px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #2ecc71 0%, #27ae60 100%);
        }

        .btn-danger {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
        }

        .keywords-section {
            margin-top: 15px;
        }

        .keywords-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }

        .keywords-input input {
            flex: 1;
        }

        .help-btn {
            background: linear-gradient(45deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .help-btn:hover {
            transform: scale(1.1);
        }

        .keywords-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .keyword-tag {
            background: rgba(255, 215, 0, 0.2);
            color: #ffd700;
            padding: 4px 8px;
            border-radius: 15px;
            font-size: 12px;
            border: 1px solid rgba(255, 215, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .keyword-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .unit-list {
            margin-top: 20px;
        }

        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-name {
            font-weight: bold;
            color: #ffd700;
            font-size: 1.1rem;
        }

        .unit-controls {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            min-width: auto;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #667eea;
            padding: 10px;
            margin: 5px 0;
            border-radius: 0 5px 5px 0;
            position: relative;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .weapon-info {
            flex: 1;
            margin-bottom: 8px;
        }

        .weapon-controls {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
            align-items: center;
        }

        .weapon-controls .btn-small {
            padding: 4px 8px;
            font-size: 11px;
            min-width: 60px;
        }

        .results-panel {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .result-item {
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 5px;
            padding: 15px;
        }

        .result-header {
            font-weight: bold;
            color: #2ecc71;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            padding: 2px 0;
        }

        .stat-label {
            color: #b8c6db;
        }

        .stat-value {
            color: #e0e6ed;
            font-weight: 600;
        }

        .json-section {
            margin-top: 20px;
        }

        .json-textarea {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            resize: vertical;
        }

        .simulation-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .simulation-controls label {
            color: #b8c6db;
            font-weight: 600;
        }

        .simulation-controls input {
            width: 100px;
        }

        .keyword-reference {
            margin-top: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .keyword-reference h3 {
            color: #ffd700;
            margin-bottom: 10px;
        }

        .keyword-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .keyword-item {
            background: rgba(255, 255, 255, 0.05);
            padding: 8px;
            border-radius: 3px;
            border-left: 3px solid #667eea;
        }

        .keyword-name {
            font-weight: bold;
            color: #ffd700;
        }

        .keyword-desc {
            font-size: 0.9rem;
            color: #b8c6db;
        }

        .chart-container {
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 5px;
            padding: 15px;
        }

        .chart-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .bar-chart {
            display: flex;
            align-items: end;
            gap: 2px;
            height: 100px;
            margin: 10px 0;
        }

        .bar {
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 2px 2px 0 0;
            min-width: 12px;
            display: flex;
            align-items: end;
            justify-content: center;
            color: white;
            font-size: 10px;
            font-weight: bold;
            position: relative;
        }

        .bar-label {
            position: absolute;
            bottom: -15px;
            font-size: 9px;
            color: #b8c6db;
        }

        .probability-text {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
        }

        .wipeout-chance {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            margin-top: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            color: #e0e6ed;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #ffd700;
        }

        /* Success and Error Messages */
        .success {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .error {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 5px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Unit and Weapon Management Styles */
        .unit-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .unit-header h3 {
            margin: 0;
            color: #ffd700;
        }

        .unit-stats p {
            margin: 5px 0;
        }

        .weapons-list {
            margin-top: 10px;
        }

        .weapon-item {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 8px;
            position: relative;
        }

        .weapon-item button {
            position: absolute;
            top: 5px;
            right: 5px;
        }

        .btn-small {
            padding: 3px 8px;
            font-size: 0.8rem;
        }

        .keyword-selection-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .keyword-selection-item {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 215, 0, 0.3);
            border-radius: 5px;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .keyword-selection-item:hover {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.6);
            transform: translateY(-2px);
        }

        .keyword-selection-item.selected {
            background: rgba(255, 215, 0, 0.2);
            border-color: #ffd700;
        }

        .keyword-selection-name {
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .keyword-selection-desc {
            font-size: 0.85rem;
            color: #b8c6db;
        }

        .keyword-parameter-inputs {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 5px;
            padding: 10px;
        }

        .keyword-parameter-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .keyword-parameter-label {
            min-width: 120px;
            font-size: 0.9rem;
            color: #ffd700;
        }

        .keyword-parameter-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            font-size: 0.9rem;
        }

        .simulation-start-panel {
            text-align: center;
            margin: 30px 0;
        }

        .simulation-final-controls p {
            margin-bottom: 15px;
            font-size: 1.1rem;
            color: #b8c6db;
        }

        .btn-large {
            font-size: 1.2rem !important;
            padding: 15px 30px !important;
        }
    </style>
    <style>
        .collapsible {
            background: rgba(255, 255, 255, 0.1);
            color: #e0e6ed;
            cursor: pointer;
            padding: 15px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            text-align: left;
            outline: none;
            font-size: 16px;
            font-weight: 600;
            margin-top: 15px;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .collapsible.active {
            background: rgba(255, 215, 0, 0.1);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .collapsible:after {
            content: '▼';
            font-size: 14px;
            color: #ffd700;
            transition: transform 0.3s ease;
        }

        .collapsible.active:after {
            transform: rotate(180deg);
        }

        .collapsible-content {
            padding: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 0 5px 5px;
        }

        .collapsible-content.active {
            padding: 20px;
            max-height: 1000px;
        }

        .simulation-panel {
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚔️ Warhammer 40k 10th Edition Kampfsimulator ⚔️</h1>
            <p>Simuliere Kämpfe zwischen Angreifern und Verteidigern mit allen 10th Edition Regeln</p>
        </div>

        <!-- Simulation Panel -->
        <div class="panel simulation-panel">
            <h2>🎯 Simulation Setup</h2>
            
            <div class="simulation-controls">
                <label>Anzahl Simulationen:</label>
                <input type="number" id="simulationAmount" value="1000" min="10" max="100000">
            </div>

            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
            </div>

            <!-- JSON Import/Export als aufklappbar -->
            <button class="collapsible" onclick="toggleCollapsible(this)">
                📄 JSON Import/Export
            </button>
            <div class="collapsible-content">
                <div class="form-group">
                    <label>📥 Konfiguration aus Datei laden:</label>
                    <input type="file" id="jsonFileInput" accept=".json" style="margin-bottom: 10px;">
                    <button class="btn btn-secondary" onclick="importFromFile()">Datei importieren</button>
                </div>

                <div class="form-group">
                    <label>📤 Aktuelle Konfiguration speichern:</label>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="exportToFile()">Als Datei exportieren</button>
                        <button class="btn" onclick="showFullJson()">JSON anzeigen</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>📝 Oder JSON manuell eingeben:</label>
                    <textarea class="json-textarea" id="jsonImport" placeholder="Fügen Sie hier Ihre JSON-Konfiguration ein..."></textarea>
                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="importJson()">JSON importieren</button>
                        <button class="btn" onclick="loadExample()">Beispiel laden</button>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="btn" onclick="showFullJson()">Vollständige JSON anzeigen</button>
                <button class="btn btn-danger" onclick="clearAll()">Alles zurücksetzen</button>
            </div>
        </div>

        <div class="main-grid">
            <!-- Angreifer Panel -->
            <div class="panel">
                <h2>🗡️ Angreifer verwalten</h2>
                
                <div class="form-group">
                    <label>Gruppen-Name (z.B. "Space Marine Squad"):</label>
                    <input type="text" id="attackerGroupName" placeholder="z.B. Space Marine Squad">
                </div>

                <div class="form-group">
                    <label>Name des Angreifers:</label>
                    <input type="text" id="attackerName" placeholder="z.B. Sergeant, Marine">
                </div>

                <div class="form-group">
                    <label>Anzahl dieses Modell-Typs:</label>
                    <input type="number" id="attackerCount" value="1" min="1" max="20">
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addAttacker()">Angreifer hinzufügen</button>
                </div>

                <div class="unit-list" id="attackersList"></div>

                <!-- Waffe hinzufügen als aufklappbar -->
                <button class="collapsible" onclick="toggleCollapsible(this)">
                    ⚔️ Waffe hinzufügen
                </button>
                <div class="collapsible-content">
                    <div class="form-group">
                        <label>Angreifer auswählen:</label>
                        <select id="weaponAttackerSelect">
                            <option value="">Bitte Angreifer auswählen</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Waffenname:</label>
                        <input type="text" id="weaponName" placeholder="z.B. Bolter">
                    </div>
                    
                    <div class="form-group">
                        <label>Anzahl identischer Waffen (Amount):</label>
                        <input type="number" id="weaponAmount" value="1" min="1" max="20">
                    </div>

                    <div class="form-group">
                        <label>Waffentyp:</label>
                        <select id="weaponType">
                            <option value="Ranged">Ranged</option>
                            <option value="Melee">Melee</option>
                            <option value="Psychic">Psychic</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Attacks (kann D6, 2D3+1, etc. sein):</label>
                        <input type="text" id="weaponAttacks" value="1" placeholder="z.B. 2D6+3">
                    </div>

                    <div class="form-group">
                        <label>To Hit (Würfelwurf benötigt):</label>
                        <input type="number" id="weaponToHit" value="4" min="2" max="6">
                    </div>

                    <div class="form-group">
                        <label>Strength:</label>
                        <input type="number" id="weaponStrength" value="4" min="1" max="20">
                    </div>

                    <div class="form-group">
                        <label>AP (Armor Penetration):</label>
                        <input type="number" id="weaponAP" value="0" min="0" max="6">
                    </div>

                    <div class="form-group">
                        <label>Damage (kann D6, D3+1, etc. sein):</label>
                        <input type="text" id="weaponDamage" value="1" placeholder="z.B. D6+2">
                    </div>                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="weaponKeywordInput" placeholder="Keyword eingeben oder aus Liste wählen">
                        <button class="btn btn-small" onclick="addWeaponKeyword()">+</button>
                        <button class="btn btn-small" onclick="showKeywordSelector('weapon')" title="Aus Keyword-Liste auswählen">📋</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="weaponKeywords"></div>
                    
                    <!-- Parameter-Input für Keywords wie "Melta X", "Anti-X Y+", etc. -->
                    <div id="weaponKeywordParameters" style="margin-top: 10px; display: none;">
                        <div class="keyword-parameter-inputs"></div>
                    </div>
                </div>

                    <div class="button-group">
                        <button class="btn btn-secondary" onclick="addWeapon()">Waffe hinzufügen</button>
                        <button class="btn" onclick="clearWeaponForm()">Formular leeren</button>
                    </div>
                </div>
            </div>

            <!-- Verteidiger Panel -->
            <div class="panel">
                <h2>🛡️ Verteidiger verwalten</h2>
                
                <div class="form-group">
                    <label>Gruppen-Name (z.B. "Space Marine Squad"):</label>
                    <input type="text" id="defenderGroupName" placeholder="z.B. Space Marine Squad">
                </div>
                
                <div class="form-group">
                    <label>Name des Verteidigers:</label>
                    <input type="text" id="defenderName" placeholder="z.B. Sergeant, Marine">
                </div>

                <div class="form-group">
                    <label>Anzahl Modelle:</label>
                    <input type="number" id="defenderModels" value="10" min="1">
                </div>

                <div class="form-group">
                    <label>Toughness:</label>
                    <input type="number" id="defenderToughness" value="4" min="1" max="12">
                </div>

                <div class="form-group">
                    <label>Wounds pro Modell:</label>
                    <input type="number" id="defenderWounds" value="1" min="1">
                </div>

                <div class="form-group">
                    <label>Save (Armor Save):</label>
                    <input type="number" id="defenderSave" value="6" min="2" max="7">
                </div>
                <div class="form-group">
                    <label>Invulnerable Save (leer lassen wenn nicht vorhanden):</label>
                    <input type="number" id="defenderInvul" min="2" max="6" placeholder="z.B. 5">
                </div>

                <div class="keywords-section">
                    <label>Keywords:</label>
                    <div class="keywords-input">
                        <input type="text" id="defenderKeywordInput" placeholder="Keyword eingeben oder aus Liste wählen">
                        <button class="btn btn-small" onclick="addDefenderKeyword()">+</button>
                        <button class="btn btn-small" onclick="showKeywordSelector('defender')" title="Aus Keyword-Liste auswählen">📋</button>
                        <button class="help-btn" onclick="showKeywordHelp()" title="Keyword-Hilfe anzeigen">?</button>
                    </div>
                    <div class="keywords-list" id="defenderKeywords"></div>
                    
                    <!-- Parameter-Input für Keywords -->
                    <div id="defenderKeywordParameters" style="margin-top: 10px; display: none;">
                        <div class="keyword-parameter-inputs"></div>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="addDefender()">Verteidiger hinzufügen</button>
                </div>

                <div class="unit-list" id="defendersList"></div>
            </div>
        </div>

        <!-- Simulation starten -->
        <div class="panel simulation-start-panel">
            <h2>🚀 Simulation starten</h2>
            <div class="simulation-final-controls">
                <p>Alle Angreifer und Verteidiger sind konfiguriert? Dann kann die Simulation gestartet werden!</p>
                <button class="btn btn-primary btn-large" onclick="runSimulation()" style="font-size: 1.2rem; padding: 15px 30px;">
                    ⚔️ Simulation starten
                </button>
            </div>
        </div>

        <!-- Ergebnisse Panel -->
        <div class="panel results-panel" id="resultsPanel" style="display: none;">
            <h2>📊 Simulationsergebnisse</h2>
            <div class="results-grid" id="resultsContainer"></div>
            
            <!-- Export Button am Ende der Ergebnisse -->
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="exportResultsToPDF()">📄 PDF-Report erstellen</button>
                <button class="btn btn-secondary" onclick="exportResults()">📄 JSON exportieren</button>
            </div>
        </div>
    </div>

    <!-- Keyword Help Modal -->
    <div id="keywordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordHelp()">&times;</span>
            <h2>📖 Keyword-Referenz</h2>
            <div class="keyword-reference">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-grid" id="modalStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-grid" id="modalCustomKeywords"></div>
            </div>
        </div>
    </div>

    <!-- Keyword Selector Modal -->
    <div id="keywordSelectorModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeKeywordSelector()">&times;</span>
            <h2>🔖 Keywords auswählen</h2>
            <div class="keyword-selector">
                <h3>Standard 10th Edition Keywords:</h3>
                <div class="keyword-selection-grid" id="selectorStandardKeywords"></div>
                
                <h3>Custom Keywords:</h3>
                <div class="keyword-selection-grid" id="selectorCustomKeywords"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Dice } from './src/scripts/dice.js';
        import { Attacker, Defender, Weapon } from './src/scripts/units.js';
        import run from './src/scripts/w40k.js';

        console.log('Scripts loaded successfully');
        console.log('run function:', typeof run);

        // Globale Variablen
        window.attackers = [];
        window.defenders = [];
        window.simulationResults = [];
        window.currentWeaponKeywords = [];
        window.currentDefenderKeywords = [];

        // Migration: Stelle sicher, dass alle Angreifer-Mitglieder ein Weapons-Array haben
        function migrateAttackerData() {
            window.attackers.forEach(group => {
                // Migriere alte Struktur mit Waffen auf Gruppen-Ebene
                if (group.Weapons && !group.Members.some(m => m.Weapons)) {
                    // Teile Waffen auf alle Mitglieder auf (alte Struktur)
                    group.Members.forEach(member => {
                        if (!member.Weapons) {
                            member.Weapons = [...group.Weapons];
                        }
                    });
                    delete group.Weapons; // Entferne alte Waffen-Referenz
                }
                
                // Stelle sicher, dass alle Mitglieder ein Weapons-Array haben
                group.Members.forEach(member => {
                    if (!member.Weapons) {
                        member.Weapons = [];
                    }
                });
            });
        }

        // Collapsible-Funktionalität
        window.toggleCollapsible = function(element) {
            element.classList.toggle('active');
            const content = element.nextElementSibling;
            content.classList.toggle('active');
        };

        // Keyword-Definitionen
        const standardKeywords = {
            'lethal hits': 'Critical hits automatisch verwunden (case-insensitive)',
            'sustained hits X': 'Critical hits erzeugen X zusätzliche Hits (X kann Zahl oder Würfel sein, case-insensitive)',
            'devastating wounds': 'Critical wounds ignorieren alle Saves (case-insensitive)',
            'anti-KEYWORD X+': 'Gegen Units mit KEYWORD: Critical wounds bei X+ (z.B. "anti-vehicle 5" oder "anti-infantry 4+", case-insensitive)',
            'twin-linked': 'Reroll alle failed wound rolls (case-insensitive)',
            'rapid fire X': 'Bei Range ≤ Hälfte: +X Attacks (case-insensitive)',
            'blast': '+1 Attack pro 5 Modelle im Ziel (1-4=+0, 5-9=+1, 10-14=+2, etc., case-insensitive)',
            'hazardous': 'Bei Critical Fails: 1 Mortal Wound (case-insensitive, implementiert)',
            'lance': 'Charge: +1 to wound, +1 AP (case-insensitive)',
            'precision': 'Critical hits können Charaktere zuweisen (case-insensitive, implementiert)',
            'torrent': 'Automatische Hits, keine Hit-Würfe erforderlich (case-insensitive, implementiert)',
            'ignores cover': 'Umgeht Cover-Save Bonus des Ziels (case-insensitive, implementiert)',
            'indirect fire': '-1 to hit, maximal 4+ to hit (case-insensitive, implementiert)',
            'psychic': 'Kann durch Deny the Witch gestoppt werden (case-insensitive, implementiert)',
            'melta X': 'Bei Range ≤ Hälfte: +X Damage (case-insensitive, benötigt Parameter X)',
            '+1 to hit': 'Verbessert Hit-Würfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to hit': 'Verschlechtert Hit-Würfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)',
            '+1 to wound': 'Verbessert Wound-Würfe um 1 (z.B. 4+ wird zu 3+, case-insensitive)',
            '-1 to wound': 'Verschlechtert Wound-Würfe um 1 (z.B. 3+ wird zu 4+, case-insensitive)'
        };

        const customKeywords = {
            'RH1': 'Reroll 1s beim Hit-Wurf',
            'RW1': 'Reroll 1s beim Wound-Wurf',
            'RHMiss': 'Reroll alle fehlgeschlagenen Hit-Würfe',
            'RWMiss': 'Reroll alle fehlgeschlagenen Wound-Würfe',
            'RHNoCrit': 'Reroll 1s beim Hit-Wurf wenn kein Critical Hit',
            'RWNoCrit': 'Reroll 1s beim Wound-Wurf wenn kein Critical Wound',
            'CritHitX': 'Critical Hits bei X+ statt 6+ (z.B. CritHit5+)',
            'CritWoundX': 'Critical Wounds bei X+ statt 6+ (z.B. CritWound4+)',
            '+1D': 'Erhöht ausgehenden Schaden um 1 (case-insensitive)',
            '-1D': 'Reduziert eingehenden Schaden um 1 (minimum 1, case-insensitive)',
            '/2D': 'Halbiert eingehenden Schaden (minimum 1, abgerundet, case-insensitive)',
            'feel no pain X': 'Ignoriert Schaden bei X+ auf 1W6 (z.B. "feel no pain 6", case-insensitive)',
            'feel no pain psychic X': 'Ignoriert Psychic Schaden bei X+ auf 1W6 (case-insensitive)',
            'cover': '+1 Save (außer gegen "ignores cover" Weapons, case-insensitive)',
            '-1 wound when stronger': 'Wenn Stärke > Toughness: -1 to wound (case-insensitive)'
        };

        // Initialisierung
        document.addEventListener('DOMContentLoaded', function() {
            populateKeywordModal();
            updateAttackerSelect();
            migrateAttackerData(); // Migration der Angreifer-Daten
            
            // Sicherstellen, dass der Loading-Spinner beim Start versteckt ist
            const loadingSpinner = document.getElementById('loadingSpinner');
            if (loadingSpinner) {
                loadingSpinner.classList.remove('active');
            }
        });

        // Keyword Modal Functions
        window.showKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'block';
        };

        window.closeKeywordHelp = function() {
            document.getElementById('keywordModal').style.display = 'none';
        };

        // Keyword Selector Functions
        let currentKeywordTarget = null; // 'weapon' or 'defender'

        window.showKeywordSelector = function(target) {
            currentKeywordTarget = target;
            populateKeywordSelector();
            document.getElementById('keywordSelectorModal').style.display = 'block';
        };

        window.closeKeywordSelector = function() {
            document.getElementById('keywordSelectorModal').style.display = 'none';
            currentKeywordTarget = null;
        };

        function populateKeywordSelector() {
            const standardContainer = document.getElementById('selectorStandardKeywords');
            const customContainer = document.getElementById('selectorCustomKeywords');
            
            // Clear existing content
            standardContainer.innerHTML = '';
            customContainer.innerHTML = '';

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-selection-item';
                keywordElement.onclick = () => selectKeyword(keyword);
                keywordElement.innerHTML = `
                    <div class="keyword-selection-name">${keyword}</div>
                    <div class="keyword-selection-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-selection-item';
                keywordElement.onclick = () => selectKeyword(keyword);
                keywordElement.innerHTML = `
                    <div class="keyword-selection-name">${keyword}</div>
                    <div class="keyword-selection-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        function selectKeyword(keyword) {
            if (currentKeywordTarget === 'weapon') {
                if (!window.currentWeaponKeywords.includes(keyword)) {
                    window.currentWeaponKeywords.push(keyword);
                    updateWeaponKeywordsDisplay();
                }
            } else if (currentKeywordTarget === 'defender') {
                if (!window.currentDefenderKeywords.includes(keyword)) {
                    window.currentDefenderKeywords.push(keyword);
                    updateDefenderKeywordsDisplay();
                }
            }
            closeKeywordSelector();
        }

        // Click outside modal to close
        window.onclick = function(event) {
            const keywordModal = document.getElementById('keywordModal');
            const selectorModal = document.getElementById('keywordSelectorModal');
            if (event.target == keywordModal) {
                keywordModal.style.display = 'none';
            }
            if (event.target == selectorModal) {
                selectorModal.style.display = 'none';
                currentKeywordTarget = null;
            }
        };

        // Keyword-Referenz im Modal anzeigen
        function populateKeywordModal() {
            const standardContainer = document.getElementById('modalStandardKeywords');
            const customContainer = document.getElementById('modalCustomKeywords');

            // Standard Keywords
            for (const [keyword, description] of Object.entries(standardKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                standardContainer.appendChild(keywordElement);
            }

            // Custom Keywords
            for (const [keyword, description] of Object.entries(customKeywords)) {
                const keywordElement = document.createElement('div');
                keywordElement.className = 'keyword-item';
                keywordElement.innerHTML = `
                    <div class="keyword-name">${keyword}</div>
                    <div class="keyword-desc">${description}</div>
                `;
                customContainer.appendChild(keywordElement);
            }
        }

        // Angreifer hinzufügen
        window.addAttacker = function() {
            const groupName = document.getElementById('attackerGroupName').value.trim();
            const name = document.getElementById('attackerName').value.trim();
            const count = parseInt(document.getElementById('attackerCount').value) || 1;
            
            if (!groupName) {
                showError('Bitte geben Sie einen Gruppen-Namen ein.');
                return;
            }
            if (!name) {
                showError('Bitte geben Sie einen Namen für den Angreifer ein.');
                return;
            }

            // Prüfe ob Gruppe bereits existiert
            let group = window.attackers.find(g => g.GroupName === groupName);
            
            if (!group) {
                // Neue Gruppe erstellen
                group = {
                    GroupName: groupName,
                    Members: []
                    // Waffen sind jetzt bei den einzelnen Mitgliedern
                };
                window.attackers.push(group);
            }
            
            // Mitglied zur Gruppe hinzufügen
            const member = {
                Name: name,
                Count: count,
                Weapons: []  // Jedes Mitglied hat seine eigenen Waffen
            };
            
            group.Members.push(member);
            
            // Formular leeren
            document.getElementById('attackerGroupName').value = '';
            document.getElementById('attackerName').value = '';
            document.getElementById('attackerCount').value = '1';
            
            updateAttackersList();
            updateAttackerSelect();
            showSuccess(`${count}x ${name} wurde zur Gruppe "${groupName}" hinzugefügt.`);
        };

        // Verteidiger hinzufügen
        window.addDefender = function() {
            const groupName = document.getElementById('defenderGroupName').value.trim();
            const name = document.getElementById('defenderName').value.trim();
            const models = parseInt(document.getElementById('defenderModels').value);
            const toughness = parseInt(document.getElementById('defenderToughness').value);
            const wounds = parseInt(document.getElementById('defenderWounds').value);
            const save = parseInt(document.getElementById('defenderSave').value);
            const invul = document.getElementById('defenderInvul').value;

            if (!groupName) {
                showError('Bitte geben Sie einen Gruppen-Namen ein.');
                return;
            }
            if (!name) {
                showError('Bitte geben Sie einen Namen für den Verteidiger ein.');
                return;
            }

            // Prüfe ob Gruppe bereits existiert
            let group = window.defenders.find(g => g.GroupName === groupName);
            
            if (!group) {
                // Neue Gruppe erstellen
                group = {
                    GroupName: groupName,
                    Members: []
                };
                window.defenders.push(group);
            }
            
            // Mitglied zur Gruppe hinzufügen
            const member = {
                Name: name,
                type: 'Infantry',
                models: models,
                toughness: toughness,
                wounds: wounds,
                save: save,
                invulnerable: invul ? parseInt(invul) : 7,
                Keywords: [...window.currentDefenderKeywords]
            };
            
            group.Members.push(member);

            clearDefenderForm();
            updateDefendersList();
            showSuccess(`${models}x ${name} wurde zur Gruppe "${groupName}" hinzugefügt.`);
        };

        // Waffe hinzufügen
        window.addWeapon = function() {
            const attackerValue = document.getElementById('weaponAttackerSelect').value;
            const name = document.getElementById('weaponName').value.trim();
            const type = document.getElementById('weaponType').value;
            const attacks = document.getElementById('weaponAttacks').value.trim();
            const toHit = parseInt(document.getElementById('weaponToHit').value);
            const strength = parseInt(document.getElementById('weaponStrength').value);
            const ap = parseInt(document.getElementById('weaponAP').value);
            const damage = document.getElementById('weaponDamage').value.trim();
            const amount = parseInt(document.getElementById('weaponAmount').value) || 1;

            if (!attackerValue) {
                showError('Bitte wählen Sie einen Angreifer aus.');
                return;
            }

            if (!name) {
                showError('Bitte geben Sie einen Namen für die Waffe ein.');
                return;
            }

            // Parse groupIndex und memberIndex aus dem Wert "groupIndex-memberIndex"
            const [groupIndex, memberIndex] = attackerValue.split('-').map(i => parseInt(i));

            const weapon = {
                name: name,
                type: type,
                attacks: attacks,
                to_hit: toHit,
                strength: strength,
                ap: ap,
                damage: damage,
                amount: amount,
                Keywords: [...window.currentWeaponKeywords]
            };

            // Waffe zum spezifischen Angreifer hinzufügen
            window.attackers[groupIndex].Members[memberIndex].Weapons.push(weapon);
            clearWeaponForm();
            updateAttackersList();
            
            // Waffen-Menü zuklappen nach dem Hinzufügen
            const weaponCollapsible = document.querySelector('button.collapsible');
            const weaponCollapsibles = document.querySelectorAll('button.collapsible');
            let weaponMenuCollapsible = null;
            
            weaponCollapsibles.forEach(collapsible => {
                if (collapsible.textContent.includes('Waffe hinzufügen')) {
                    weaponMenuCollapsible = collapsible;
                }
            });
            
            if (weaponMenuCollapsible && weaponMenuCollapsible.classList.contains('active')) {
                const weaponContent = weaponMenuCollapsible.nextElementSibling;
                weaponMenuCollapsible.classList.remove('active');
                weaponContent.classList.remove('active');
            }
            
            const attackerName = window.attackers[groupIndex].Members[memberIndex].Name;
            const groupName = window.attackers[groupIndex].GroupName;
            showSuccess(`Waffe "${name}" wurde zu ${attackerName} (${groupName}) hinzugefügt.`);
        };

        // Keyword-Funktionen
        window.addWeaponKeyword = function() {
            const input = document.getElementById('weaponKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentWeaponKeywords.includes(keyword)) {
                window.currentWeaponKeywords.push(keyword);
                input.value = '';
                updateWeaponKeywordsDisplay();
            }
        };

        window.addDefenderKeyword = function() {
            const input = document.getElementById('defenderKeywordInput');
            const keyword = input.value.trim();
            if (keyword && !window.currentDefenderKeywords.includes(keyword)) {
                window.currentDefenderKeywords.push(keyword);
                input.value = '';
                updateDefenderKeywordsDisplay();
            }
        };

        // Form clearing functions
        window.clearWeaponForm = function() {
            document.getElementById('weaponAttackerSelect').value = '';
            document.getElementById('weaponName').value = '';
            document.getElementById('weaponAmount').value = '1';
            document.getElementById('weaponType').value = 'Ranged';
            document.getElementById('weaponAttacks').value = '1';
            document.getElementById('weaponToHit').value = '4';
            document.getElementById('weaponStrength').value = '4';
            document.getElementById('weaponAP').value = '0';
            document.getElementById('weaponDamage').value = '1';
            document.getElementById('weaponKeywordInput').value = '';
            
            // Keywords leeren
            window.currentWeaponKeywords = [];
            updateWeaponKeywordsDisplay();
        };

        function clearDefenderForm() {
            document.getElementById('defenderGroupName').value = '';
            document.getElementById('defenderName').value = '';
            document.getElementById('defenderModels').value = '1';
            document.getElementById('defenderToughness').value = '4';
            document.getElementById('defenderWounds').value = '1';
            document.getElementById('defenderSave').value = '3';
            document.getElementById('defenderInvul').value = '';
            document.getElementById('defenderKeywordInput').value = '';
            
            // Keywords leeren
            window.currentDefenderKeywords = [];
            updateDefenderKeywordsDisplay();
        };

        // Keywords mit Parametern (benötigen X-Werte)
        const parametricKeywords = {
            'melta': { pattern: /^melta\s*(\d+)?$/i, description: 'Bei Range ≤ Hälfte: +X Damage', paramName: 'Bonus-Damage' },
            'anti-': { pattern: /^anti-([^0-9]+)\s*(\d+)\+?$/i, description: 'Gegen KEYWORD: Critical wounds bei X+', paramName: 'Critical-Threshold' },
            'sustained hits': { pattern: /^sustained\s+hits\s*(\d+|d\d+)?$/i, description: 'Critical hits erzeugen X zusätzliche Hits', paramName: 'Extra-Hits' },
            'rapid fire': { pattern: /^rapid\s+fire\s*(\d+)?$/i, description: 'Bei Range ≤ Hälfte: +X Attacks', paramName: 'Bonus-Attacks' },
            'feel no pain': { pattern: /^feel\s+no\s+pain\s*(\d+)\+?$/i, description: 'Ignoriert Schaden bei X+ auf 1W6', paramName: 'Save-Threshold' },
            'crithit': { pattern: /^crithit(\d+)\+?$/i, description: 'Critical Hits bei X+ statt 6+', paramName: 'Hit-Threshold' },
            'critwound': { pattern: /^critwound(\d+)\+?$/i, description: 'Critical Wounds bei X+ statt 6+', paramName: 'Wound-Threshold' }
        };

        function needsParameter(keyword) {
            const keywordLower = keyword.toLowerCase();
            for (const [key, config] of Object.entries(parametricKeywords)) {
                if (keywordLower.includes(key.toLowerCase()) || config.pattern.test(keyword)) {
                    // Prüfe ob bereits ein Parameter vorhanden ist
                    const match = config.pattern.exec(keyword);
                    if (match && match[1]) {
                        return null; // Bereits parametrisiert
                    }
                    return config;
                }
            }
            return null;
        }

        function updateWeaponKeywordsDisplay() {
            const container = document.getElementById('weaponKeywords');
            const paramContainer = document.getElementById('weaponKeywordParameters');
            const paramInputs = paramContainer.querySelector('.keyword-parameter-inputs');
            
            container.innerHTML = '';
            paramInputs.innerHTML = '';
            
            let hasParameters = false;
            
            window.currentWeaponKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeWeaponKeyword(${index})">×</span>
                `;
                container.appendChild(tag);
                
                // Prüfe ob Parameter benötigt wird
                const paramConfig = needsParameter(keyword);
                if (paramConfig) {
                    hasParameters = true;
                    const paramItem = document.createElement('div');
                    paramItem.className = 'keyword-parameter-item';
                    paramItem.innerHTML = `
                        <span class="keyword-parameter-label">${keyword} - ${paramConfig.paramName}:</span>
                        <input type="text" class="keyword-parameter-input" 
                               id="weaponParam_${index}" 
                               placeholder="X" 
                               onchange="updateParametricKeyword('weapon', ${index}, this.value)">
                    `;
                    paramInputs.appendChild(paramItem);
                }
            });
            
            paramContainer.style.display = hasParameters ? 'block' : 'none';
        }

        function updateDefenderKeywordsDisplay() {
            const container = document.getElementById('defenderKeywords');
            const paramContainer = document.getElementById('defenderKeywordParameters');
            const paramInputs = paramContainer.querySelector('.keyword-parameter-inputs');
            
            container.innerHTML = '';
            paramInputs.innerHTML = '';
            
            let hasParameters = false;
            
            window.currentDefenderKeywords.forEach((keyword, index) => {
                const tag = document.createElement('div');
                tag.className = 'keyword-tag';
                tag.innerHTML = `
                    ${keyword}
                    <span class="remove" onclick="removeDefenderKeyword(${index})">×</span>
                `;
                container.appendChild(tag);
                
                // Prüfe ob Parameter benötigt wird
                const paramConfig = needsParameter(keyword);
                if (paramConfig) {
                    hasParameters = true;
                    const paramItem = document.createElement('div');
                    paramItem.className = 'keyword-parameter-item';
                    paramItem.innerHTML = `
                        <span class="keyword-parameter-label">${keyword} - ${paramConfig.paramName}:</span>
                        <input type="text" class="keyword-parameter-input" 
                               id="defenderParam_${index}" 
                               placeholder="X" 
                               onchange="updateParametricKeyword('defender', ${index}, this.value)">
                    `;
                    paramInputs.appendChild(paramItem);
                }
            });
            
            paramContainer.style.display = hasParameters ? 'block' : 'none';
        }

        window.updateParametricKeyword = function(type, index, value) {
            const keywords = type === 'weapon' ? window.currentWeaponKeywords : window.currentDefenderKeywords;
            const keyword = keywords[index];
            const paramConfig = needsParameter(keyword);
            
            if (paramConfig && value) {
                // Ersetze das Keyword mit dem parametrisierten Wert
                let newKeyword = keyword;
                if (keyword.toLowerCase().includes('melta')) {
                    newKeyword = `melta ${value}`;
                } else if (keyword.toLowerCase().includes('anti-')) {
                    // Extrahiere das Anti-Target und füge den Wert hinzu
                    const match = keyword.match(/anti-([^0-9]+)/i);
                    if (match) {
                        newKeyword = `anti-${match[1].trim()} ${value}+`;
                    }
                } else if (keyword.toLowerCase().includes('sustained hits')) {
                    newKeyword = `sustained hits ${value}`;
                } else if (keyword.toLowerCase().includes('rapid fire')) {
                    newKeyword = `rapid fire ${value}`;
                } else if (keyword.toLowerCase().includes('feel no pain')) {
                    newKeyword = `feel no pain ${value}+`;
                } else if (keyword.toLowerCase().includes('crithit')) {
                    newKeyword = `CritHit${value}+`;
                } else if (keyword.toLowerCase().includes('critwound')) {
                    newKeyword = `CritWound${value}+`;
                }
                
                keywords[index] = newKeyword;
                
                if (type === 'weapon') {
                    updateWeaponKeywordsDisplay();
                } else {
                    updateDefenderKeywordsDisplay();
                }
            }
        };

        window.removeWeaponKeyword = function(index) {
            window.currentWeaponKeywords.splice(index, 1);
            updateWeaponKeywordsDisplay();
        };

        window.removeDefenderKeyword = function(index) {
            window.currentDefenderKeywords.splice(index, 1);
            updateDefenderKeywordsDisplay();
        };

        // Listen aktualisieren
        function updateAttackersList() {
            const container = document.getElementById('attackersList');
            container.innerHTML = '';

            window.attackers.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${group.GroupName}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small" onclick="editAttackerGroup(${groupIndex})">Bearbeiten</button>
                            <button class="btn btn-small btn-danger" onclick="removeAttackerGroup(${groupIndex})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Mitglieder:</strong><br>
                        ${group.Members.map((member, mIndex) => `
                            <div style="margin: 5px 0; padding: 5px; background: rgba(255,255,255,0.03); border-radius: 3px;">
                                <div style="margin-bottom: 5px;">
                                    ${member.Count}x ${member.Name}
                                    <button class="btn btn-small" onclick="editAttackerMember(${groupIndex}, ${mIndex})" style="float: right; margin-left: 5px;">Bearbeiten</button>
                                    <button class="btn btn-small btn-danger" onclick="removeAttackerMember(${groupIndex}, ${mIndex})" style="float: right;">Entfernen</button>
                                </div>
                                ${member.Weapons && member.Weapons.length > 0 ? `
                                    <div style="margin-left: 10px; font-size: 0.9em; color: #b8c6db;">
                                        <strong>Waffen (${member.Weapons.length}):</strong><br>
                                        ${member.Weapons.map((weapon, wIndex) => `
                                            <div style="margin: 2px 0; padding: 3px; background: rgba(255,255,255,0.05); border-radius: 2px;">
                                                <strong>${weapon.name}</strong> (${weapon.type})<br>
                                                A: ${weapon.attacks} | Hit: ${weapon.to_hit}+ | S: ${weapon.strength} | AP: -${weapon.ap} | D: ${weapon.damage} | Amount: ${weapon.amount}<br>
                                                Keywords: ${weapon.Keywords.join(', ') || 'Keine'}
                                                <div style="margin-top: 3px;">
                                                    <button class="btn btn-small" onclick="editWeapon(${groupIndex}, ${mIndex}, ${wIndex})">Bearbeiten</button>
                                                    <button class="btn btn-small btn-danger" onclick="removeWeapon(${groupIndex}, ${mIndex}, ${wIndex})">Entfernen</button>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : '<div style="margin-left: 10px; font-size: 0.9em; color: #888;">Keine Waffen</div>'}
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateDefendersList() {
            const container = document.getElementById('defendersList');
            container.innerHTML = '';

            window.defenders.forEach((group, groupIndex) => {
                const div = document.createElement('div');
                div.className = 'unit-item';
                div.innerHTML = `
                    <div class="unit-header">
                        <div class="unit-name">${group.GroupName}</div>
                        <div class="unit-controls">
                            <button class="btn btn-small" onclick="editDefenderGroup(${groupIndex})">Bearbeiten</button>
                            <button class="btn btn-small btn-danger" onclick="removeDefenderGroup(${groupIndex})">Entfernen</button>
                        </div>
                    </div>
                    <div class="unit-details">
                        <strong>Mitglieder:</strong><br>
                        ${group.Members.map((member, mIndex) => `
                            <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.03); border-radius: 3px;">
                                <strong>${member.models}x ${member.Name}</strong><br>
                                T: ${member.toughness} | W: ${member.wounds} | Save: ${member.save}+ | 
                                Inv: ${member.invulnerable < 7 ? member.invulnerable + '+' : 'Keine'}<br>
                                Keywords: ${member.Keywords.join(', ') || 'Keine'}
                                <div style="margin-top: 5px;">
                                    <button class="btn btn-small" onclick="editDefenderMember(${groupIndex}, ${mIndex})">Bearbeiten</button>
                                    <button class="btn btn-small btn-danger" onclick="removeDefenderMember(${groupIndex}, ${mIndex})">Entfernen</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function updateAttackerSelect() {
            const select = document.getElementById('weaponAttackerSelect');
            select.innerHTML = '<option value="">Bitte Angreifer auswählen</option>';
            
            window.attackers.forEach((group, groupIndex) => {
                group.Members.forEach((member, memberIndex) => {
                    const option = document.createElement('option');
                    option.value = `${groupIndex}-${memberIndex}`;
                    option.textContent = `${member.Name} (${group.GroupName}) - ${member.Count}x`;
                    select.appendChild(option);
                });
            });
        }

        // Entfernen-Funktionen für Gruppen
        window.removeAttackerGroup = function(groupIndex) {
            const group = window.attackers[groupIndex];
            if (confirm(`Möchten Sie die gesamte Gruppe "${group.GroupName}" entfernen?`)) {
                window.attackers.splice(groupIndex, 1);
                updateAttackersList();
                updateAttackerSelect();
            }
        };

        window.removeDefenderGroup = function(groupIndex) {
            const group = window.defenders[groupIndex];
            if (confirm(`Möchten Sie die gesamte Gruppe "${group.GroupName}" entfernen?`)) {
                window.defenders.splice(groupIndex, 1);
                updateDefendersList();
            }
        };

        window.removeAttackerMember = function(groupIndex, memberIndex) {
            const group = window.attackers[groupIndex];
            const member = group.Members[memberIndex];
            if (confirm(`Möchten Sie ${member.Count}x ${member.Name} entfernen?`)) {
                group.Members.splice(memberIndex, 1);
                // Wenn keine Mitglieder mehr, Gruppe entfernen
                if (group.Members.length === 0) {
                    window.attackers.splice(groupIndex, 1);
                    updateAttackerSelect();
                }
                updateAttackersList();
            }
        };

        window.removeDefenderMember = function(groupIndex, memberIndex) {
            const group = window.defenders[groupIndex];
            const member = group.Members[memberIndex];
            if (confirm(`Möchten Sie ${member.models}x ${member.Name} entfernen?`)) {
                group.Members.splice(memberIndex, 1);
                // Wenn keine Mitglieder mehr, Gruppe entfernen
                if (group.Members.length === 0) {
                    window.defenders.splice(groupIndex, 1);
                }
                updateDefendersList();
            }
        };

        window.removeWeapon = function(groupIndex, memberIndex, weaponIndex) {
            window.attackers[groupIndex].Members[memberIndex].Weapons.splice(weaponIndex, 1);
            updateAttackersList();
        };

        // Bearbeitungs-Funktionen
        window.editAttacker = function(index) {
            const attacker = window.attackers[index];
            const newName = prompt('Neuer Name für den Angreifer:', attacker.Name);
            
            if (newName && newName.trim() !== '') {
                window.attackers[index].Name = newName.trim();
                updateAttackersList();
                updateAttackerSelect();
                showSuccess(`Angreifer wurde umbenannt zu "${newName.trim()}".`);
            }
        };

        window.editDefender = function(index) {
            const defender = window.defenders[index];
            
            // Laden der aktuellen Werte in das Formular
            document.getElementById('defenderName').value = defender.Name;
            document.getElementById('defenderModels').value = defender.models;
            document.getElementById('defenderToughness').value = defender.toughness;
            document.getElementById('defenderWounds').value = defender.wounds;
            document.getElementById('defenderSave').value = defender.save;
            document.getElementById('defenderInvul').value = defender.invulnerable < 7 ? defender.invulnerable : '';
            
            // Keywords laden
            window.currentDefenderKeywords = [...defender.Keywords];
            updateDefenderKeywordsDisplay();
            
            // Temporär den Index speichern für das Update
            window.editingDefenderIndex = index;
            
            // Button-Text ändern
            const addButton = document.querySelector('button[onclick="addDefender()"]');
            const originalText = addButton.textContent;
            addButton.textContent = 'Änderungen speichern';
            addButton.onclick = function() {
                updateDefender(index);
                addButton.textContent = originalText;
                addButton.onclick = window.addDefender;
            };
            
            showSuccess('Verteidiger-Daten in das Formular geladen. Bearbeiten Sie die Werte und klicken Sie "Änderungen speichern".');
        };

        // Bearbeitungs-Funktionen für Gruppen-Mitglieder
        window.editAttackerMember = function(groupIndex, memberIndex) {
            const group = window.attackers[groupIndex];
            const member = group.Members[memberIndex];
            
            const newName = prompt('Neuer Name für den Angreifer:', member.Name);
            if (newName && newName.trim() !== '') {
                const newCount = parseInt(prompt('Neue Anzahl:', member.Count));
                if (!isNaN(newCount) && newCount > 0) {
                    group.Members[memberIndex].Name = newName.trim();
                    group.Members[memberIndex].Count = newCount;
                    updateAttackersList();
                    showSuccess(`Angreifer wurde aktualisiert: ${newCount}x ${newName.trim()}`);
                }
            }
        };

        window.editDefenderMember = function(groupIndex, memberIndex) {
            const group = window.defenders[groupIndex];
            const member = group.Members[memberIndex];
            
            const newName = prompt('Neuer Name für den Verteidiger:', member.Name);
            if (!newName || newName.trim() === '') return;
            
            const newModels = parseInt(prompt('Neue Anzahl Modelle:', member.models));
            if (isNaN(newModels) || newModels <= 0) return;
            
            const newToughness = parseInt(prompt('Neue Toughness:', member.toughness));
            if (isNaN(newToughness) || newToughness <= 0) return;
            
            const newWounds = parseInt(prompt('Neue Wounds:', member.wounds));
            if (isNaN(newWounds) || newWounds <= 0) return;
            
            const newSave = parseInt(prompt('Neuer Save (z.B. 3 für 3+):', member.save));
            if (isNaN(newSave) || newSave < 2 || newSave > 6) return;
            
            const newInvul = prompt('Neuer Invulnerable Save (oder leer für keinen):', member.invulnerable < 7 ? member.invulnerable : '');
            const invulValue = newInvul && newInvul.trim() !== '' ? parseInt(newInvul) : 7;
            
            // Keywords bearbeiten
            const keywordsString = prompt('Keywords (kommagetrennt):', member.Keywords.join(', '));
            const keywords = keywordsString ? keywordsString.split(',').map(k => k.trim()).filter(k => k !== '') : [];
            
            // Aktualisiere Mitglied
            group.Members[memberIndex] = {
                Name: newName.trim(),
                type: member.type, // Typ bleibt unverändert
                models: newModels,
                toughness: newToughness,
                wounds: newWounds,
                save: newSave,
                invulnerable: invulValue,
                Keywords: keywords
            };
            
            updateDefendersList();
            showSuccess(`Verteidiger wurde aktualisiert: ${newModels}x ${newName.trim()}`);
        };

        window.editAttackerGroup = function(groupIndex) {
            const group = window.attackers[groupIndex];
            const newName = prompt('Neuer Gruppen-Name:', group.GroupName);
            
            if (newName && newName.trim() !== '') {
                window.attackers[groupIndex].GroupName = newName.trim();
                updateAttackersList();
                updateAttackerSelect();
                showSuccess(`Angreifer-Gruppe wurde umbenannt zu "${newName.trim()}".`);
            }
        };

        window.editDefenderGroup = function(groupIndex) {
            const group = window.defenders[groupIndex];
            const newName = prompt('Neuer Gruppen-Name:', group.GroupName);
            
            if (newName && newName.trim() !== '') {
                window.defenders[groupIndex].GroupName = newName.trim();
                updateDefendersList();
                showSuccess(`Verteidiger-Gruppe wurde umbenannt zu "${newName.trim()}".`);
            }
        };

        // Simulation ausführen
        window.runSimulation = function() {
            console.log('runSimulation called');
            console.log('Attackers:', window.attackers);
            console.log('Defenders:', window.defenders);
            
            if (window.attackers.length === 0) {
                showError('Bitte fügen Sie mindestens einen Angreifer hinzu.');
                return;
            }

            if (window.defenders.length === 0) {
                showError('Bitte fügen Sie mindestens einen Verteidiger hinzu.');
                return;
            }

            // Prüfen ob alle Angreifer Waffen haben
            const attackersWithoutWeapons = [];
            window.attackers.forEach(group => {
                group.Members.forEach(member => {
                    if (!member.Weapons || member.Weapons.length === 0) {
                        attackersWithoutWeapons.push(`${member.Name} (${group.GroupName})`);
                    }
                });
            });
            
            if (attackersWithoutWeapons.length > 0) {
                showError(`Die folgenden Angreifer haben keine Waffen: ${attackersWithoutWeapons.join(', ')}`);
                return;
            }

            const amount = parseInt(document.getElementById('simulationAmount').value);
            console.log('Simulation amount:', amount);
            
            // Loading anzeigen
            document.getElementById('loadingSpinner').classList.add('active');

            // Simulation in nächstem Frame starten (für Loading-Animation)
            setTimeout(() => {
                try {
                    // Konvertiere UI-Gruppen in das für die Simulation erwartete Format
                    const simulationData = {
                        Amount: amount,
                        Attackers: window.attackers.map(group => ({
                            Name: group.GroupName,
                            Members: group.Members.map(member => ({
                                Name: member.Name,
                                Count: member.Count,
                                Weapons: member.Weapons.map(weapon => ({
                                    name: weapon.name,
                                    type: weapon.type,
                                    attacks: weapon.attacks,
                                    to_hit: weapon.to_hit,
                                    strength: weapon.strength,
                                    ap: weapon.ap,
                                    damage: weapon.damage,
                                    Keywords: weapon.Keywords,
                                    amount: weapon.amount
                                }))
                            }))
                        })),
                        Defenders: window.defenders.map(group => ({
                            Name: group.GroupName,
                            Members: group.Members.map(member => ({
                                Name: member.Name,
                                type: member.type,
                                toughness: member.toughness,
                                wounds: member.wounds,
                                models: member.models,
                                save: member.save,
                                invulnerable: member.invulnerable,
                                Keywords: member.Keywords
                            }))
                        }))
                    };

                    console.log('Simulation data:', simulationData);
                    console.log('run function type:', typeof run);

                    window.simulationResults = run(simulationData);
                    console.log('Simulation results:', window.simulationResults);
                    displayResults();
                    document.getElementById('resultsPanel').style.display = 'block';
                    
                    // Zu Ergebnissen scrollen
                    document.getElementById('resultsPanel').scrollIntoView({ behavior: 'smooth' });
                    
                    showSuccess('Simulation erfolgreich abgeschlossen!');
                } catch (error) {
                    console.error('Simulation Error:', error);
                    showError('Fehler bei der Simulation: ' + error.message);
                } finally {
                    document.getElementById('loadingSpinner').classList.remove('active');
                }
            }, 100);
        };

        // Ergebnisse anzeigen
        function displayResults() {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = '';

            window.simulationResults.forEach(result => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                
                let content = `<div class="result-header">🗡️ ${result.Name}</div>`;
                
                result.Target.forEach(target => {
                    // Wenn target.Members existiert (Gruppe), zeige alle Mitglieder nebeneinander
                    if (target.Members && target.Members.length > 0) {
                        content += `
                            <div style="margin-bottom: 20px; border-left: 3px solid #667eea; padding-left: 10px;">
                                <div class="result-header" style="font-size: 1rem; margin-bottom: 8px;">
                                    🛡️ vs ${target.Name} (Gruppe)
                                </div>
                                
                                <!-- Gruppen-Mitglieder nebeneinander -->
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 15px;">
                                    ${target.Members.map(member => `
                                        <div style="background: rgba(255,255,255,0.03); border-radius: 5px; padding: 10px;">
                                            <strong>${member.Name}</strong><br>
                                            <div class="stat-row">
                                                <span class="stat-label">${member.MaximumModels === 1 ? 'Durchschnittsschaden:' : 'Vernichtete Modelle:'}</span>
                                                <span class="stat-value">${member.MaximumModels === 1 ? 
                                                    member.TotalDamage.toFixed(2) + ' / ' + member.MaxWounds + ' Wounds' :
                                                    member.ModelsDestroyed.toFixed(2) + ' / ' + member.MaximumModels}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">${member.MaximumModels === 1 ? 'Lebensenergie verloren:' : 'Vernichtungsrate:'}</span>
                                                <span class="stat-value">${member.MaximumModels === 1 ? 
                                                    ((member.TotalDamage / member.MaxWounds) * 100).toFixed(1) + '%' :
                                                    ((member.ModelsDestroyed / member.MaximumModels) * 100).toFixed(1) + '%'}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Komplette Vernichtung:</span>
                                                <span class="stat-value">${member.CompleteWipeoutChance.toFixed(1)}%</span>
                                            </div>
                                            
                                            ${member.KillDistribution ? createKillDistributionChart(member) : ''}
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <!-- Aufklappbare Waffen-Details -->
                                <button class="collapsible" onclick="toggleCollapsible(this)" style="margin-top: 15px;">
                                    ⚔️ Waffen-Details
                                </button>
                                <div class="collapsible-content">
                                    ${target.Weapons.map(weapon => `
                                        <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                                            <strong>${weapon.Name}:</strong><br>
                                            <div class="stat-row">
                                                <span class="stat-label">Durchschn. Treffer:</span>
                                                <span class="stat-value">${weapon.Hits.toFixed(2)}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Durchschn. Verwundungen:</span>
                                                <span class="stat-value">${weapon.Wounds.toFixed(2)}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Fehlgeschlagene Saves:</span>
                                                <span class="stat-value">${weapon.FailedSaves.toFixed(2)}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Durchschn. Schaden:</span>
                                                <span class="stat-value">${weapon.AverageDamage.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    } else {
                        // Altes Format für Einzelziele (Rückwärtskompatibilität)
                        content += `
                            <div style="margin-bottom: 15px; border-left: 3px solid #667eea; padding-left: 10px;">
                                <div class="result-header" style="font-size: 1rem; margin-bottom: 8px;">
                                    🛡️ vs ${target.Name}
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">${target.MaximumModels === 1 ? 'Durchschnittsschaden:' : 'Vernichtete Modelle:'}</span>
                                    <span class="stat-value">${target.MaximumModels === 1 ? 
                                        target.TotalDamage.toFixed(2) + ' / ' + target.MaxWounds + ' Wounds' :
                                        target.ModelsDestroyed.toFixed(2) + ' / ' + target.MaximumModels}</span>
                                </div>
                                <div class="stat-row">
                                    <span class="stat-label">${target.MaximumModels === 1 ? 'Lebensenergie verloren:' : 'Vernichtungsrate:'}</span>
                                    <span class="stat-value">${target.MaximumModels === 1 ? 
                                        ((target.TotalDamage / target.MaxWounds) * 100).toFixed(1) + '%' :
                                        ((target.ModelsDestroyed / target.MaximumModels) * 100).toFixed(1) + '%'}</span>
                                </div>
                                
                                <div class="stat-row">
                                    <span class="stat-label">Komplette Vernichtung:</span>
                                    <span class="stat-value">${target.CompleteWipeoutChance.toFixed(1)}%</span>
                                </div>
                                
                                ${target.KillDistribution ? createKillDistributionChart(target) : ''}
                                
                                <!-- Aufklappbare Waffen-Details -->
                                <button class="collapsible" onclick="toggleCollapsible(this)" style="margin-top: 15px;">
                                    ⚔️ Waffen-Details
                                </button>
                                <div class="collapsible-content">
                                    ${target.Weapons.map(weapon => `
                                        <div style="margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 3px;">
                                            <strong>${weapon.Name}:</strong><br>
                                            <div class="stat-row">
                                                <span class="stat-label">Durchschn. Treffer:</span>
                                                <span class="stat-value">${weapon.Hits.toFixed(2)}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Durchschn. Verwundungen:</span>
                                                <span class="stat-value">${weapon.Wounds.toFixed(2)}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Fehlgeschlagene Saves:</span>
                                                <span class="stat-value">${weapon.FailedSaves.toFixed(2)}</span>
                                            </div>
                                            <div class="stat-row">
                                                <span class="stat-label">Durchschn. Schaden:</span>
                                                <span class="stat-value">${weapon.AverageDamage.toFixed(2)}</span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });
                
                resultDiv.innerHTML = content;
                container.appendChild(resultDiv);
            });
        }

        // Chart für Kill/Damage Distribution erstellen
        function createKillDistributionChart(target) {
            if (!target.KillDistribution || target.KillDistribution.length === 0) {
                return '';
            }

            const chartId = 'chart_' + Math.random().toString(36).substr(2, 9);
            const isIndividualModel = target.MaximumModels === 1;
            
            // Sortiere nach value (kills/damage)
            const sortedDistribution = [...target.KillDistribution].sort((a, b) => a.value - b.value);
            
            // Erstelle HTML für das Chart
            let chartHtml = `
                <div class="chart-container">
                    <div class="chart-title">
                        ${isIndividualModel ? 'Schaden-Verteilung' : 'Vernichtungs-Verteilung'}
                    </div>
                    <div class="bar-chart" id="${chartId}">
            `;
            
            // Finde Maximalwert für Skalierung
            const maxPercentage = Math.max(...sortedDistribution.map(d => d.percentage));
            
            // Erstelle Balken
            sortedDistribution.forEach(item => {
                const barHeight = Math.max(5, (item.percentage / maxPercentage) * 100);
                const label = isIndividualModel ? 
                    (item.value === 0 ? '0' : `≥${item.value}`) : 
                    `${item.value}`;
                
                chartHtml += `
                    <div class="bar" style="height: ${barHeight}%;" title="${item.percentage.toFixed(1)}%">
                        <div class="bar-label">${label}</div>
                    </div>
                `;
            });
            
            chartHtml += `
                    </div>
                    <div class="probability-text">
                        Wahrscheinlichkeiten (in %):<br>
                        ${sortedDistribution.map(item => {
                            const label = isIndividualModel ? 
                                (item.value === 0 ? '0 Wounds' : `≥${item.value} Wounds`) : 
                                `${item.value} ${item.value === 1 ? 'Modell' : 'Modelle'}`;
                            return `${label}: ${item.percentage.toFixed(1)}%`;
                        }).join(' | ')}
                    </div>
                </div>
            `;
            
            return chartHtml;
        }

    </script>
</body>
</html>
